+ [templates]
+----account_menu.inc
+----admin.html
+----base.inc
+----community.html
+----login.html
+----merchant.html
+----overlay.inc
+----partner.html
+----roles.inc
+----signup.html
+----siterequest.inc
+----welcome.inc

account_menu.inc
<!-- templates/account_menu.inc -->
<!-- Menu Buttons -->
<button data-submenu="my_account_submenu" data-section="account_intro">
    <span class="button-content"><i class="fas fa-cog"></i> My Account</span>
    <i class="fas fa-caret-right caret"></i>
</button>
<div id="my_account_submenu" class="submenu">
    <button data-section="contact_details">
        <span class="button-content"><i class="fas fa-address-book"></i> Contact</span>
    </button>
    <button data-section="change_password">
        <span class="button-content"><i class="fas fa-key"></i> Change Password</span>
    </button>
</div>
{% if page_type in ['community', 'merchant', 'partner'] %}
    <button data-href="/admin" style="background-color: #dc3545;">
        <span class="button-content"><i class="fas fa-arrow-left"></i> Back to Admin</span>
    </button>
{% endif %}
<button id="logOffBtn" style="background-color: #dc3545;">
    <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
</button>

<!-- Content Sections -->
<div id="contact_details" class="section" style="display: none;">
    <h2>Contact Details</h2>
    <div class="settings-form">
        <label><strong>User ID:</strong></label>
        <input type="text" id="userId" readonly>
        <label for="contactName">Contact Name:</label>
        <input type="text" id="contactName" placeholder="Enter contact name">
        <label for="websiteUrl">Website URL:</label>
        <input type="url" id="websiteUrl" placeholder="Enter website URL">
        <label for="emailAddress">Email Address:</label>
        <input type="email" id="emailAddress" placeholder="Enter email address">
        <label><strong>Phone Number:</strong></label>
        <span>{{ user.phone_number | default('N/A') }}</span>
        <button data-action="saveSettings"><i class="fas fa-save"></i> Save Settings</button>
    </div>
</div>

<div id="change_password" class="section" style="display: none;">
    <div class="settings-form">
        <div class="password-container">
            <label for="currentPassword">Current Password:</label>
            <input type="password" id="currentPassword" name="currentPassword" placeholder="Enter current password">
            <i class="fas fa-eye password-toggle" {% if page_type == "partner" %}data-field="currentPassword Ascending"{% else %}data-target="currentPassword"{% endif %}></i>
        </div>
        <div class="password-container">
            <label for="newPassword">New Password:</label>
            <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password">
            <i class="fas fa-eye password-toggle" {% if page_type == "partner" %}data-field="newPassword"{% else %}data-target="newPassword"{% endif %}></i>
        </div>
        <div class="password-container">
            <label for="confirmPassword">Confirm New Password:</label>
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password">
            <i class="fas fa-eye password-toggle" {% if page_type == "partner" %}data-field="confirmPassword"{% else %}data-target="confirmPassword"{% endif %}></i>
        </div>
        <button data-action="savePassword"><i class="fas fa-key"></i> Change Password</button>
    </div>
</div>
admin.html

{% extends "base.inc" %}
{% block content %}
<div class="main-container">
    <div class="menu-container">
        <div class="menu">
            <button data-section="deal_listings">
                <span class="button-content"><i class="fas fa-tags"></i> Deal Listings</span>
            </button>
            <button data-section="affiliates">
                <span class="button-content"><i class="fas fa-handshake"></i> Affiliate Programs</span>
            </button>
            <button data-section="site_settings">
                <span class="button-content"><i class="fas fa-tools"></i> Site Settings</span>
            </button>
            <button data-submenu="userManagement" data-section="userManagementIntro">
                <span class="button-content"><i class="fas fa-users"></i> User Management</span>
                <i class="fas fa-caret-right caret"></i>
            </button>
            <div id="userManagement" class="submenu">
                <button data-section="user_management" data-role="admin">
                    <span class="button-content">
                        <i class="icon-admin" style="height: 16px; width: 16px;"></i> Admin
                    </span>
                </button>
                <button data-section="user_management" data-role="wixpro">
                    <span class="button-content">
                        <i class="icon-partner" style="height: 16px; width: 16px;"></i> Partners
                    </span>
                </button>
                <button data-section="user_management" data-role="community">
                    <span class="button-content">
                        <i class="icon-community" style="height: 16px; width: 16px;"></i> Communities
                    </span>
                </button>
                <button data-section="user_management" data-role="merchant">
                    <span class="button-content">
                        <i class="icon-merchant" style="height: 16px; width: 16px;"></i> Merchants
                    </span>
                </button>
            </div>
            <button data-submenu="testScripts" data-section="testScriptsIntro">
                <span class="button-content"><i class="fas fa-flask"></i> Test Scripts</span>
                <i class="fas fa-caret-right caret"></i>
            </button>
            <div id="testScripts" class="submenu">
                <button data-href="/" data-role="partner">
                    <span class="button-content">
                        <span class="icon-group">
                            <i class="icon-partner" style="height: 16px; width: 16px;"></i>
                            <i class="fas fa-flask small-icon"></i>
                        </span> Partner
                    </span>
                </button>
                <button data-href="/" data-role="community">
                    <span class="button-content">
                        <span class="icon-group">
                            <i class="icon-community" style="height: 16px; width: 16px;"></i>                            
                            <i class="fas fa-flask small-icon"></i>
                        </span> Community
                    </span>
                </button>
                <button data-href="/" data-role="merchant">
                    <span class="button-content">
                        <span class="icon-group">
                            <i class="icon-merchant" style="height: 16px; width: 16px;"></i>                            
                            <i class="fas fa-flask small-icon"></i>
                        </span> Merchant
                    </span>
                </button>
                <button data-submenu="referralTests" data-section="referralTestsIntro">
                    <span class="button-content"><i class="fas fa-link"></i> Referral Tests</span>
                    <i class="fas fa-caret-right caret"></i>
                </button>
                <div id="referralTests" class="submenu">
                    <button data-section="page_visit_test">
                        <span class="button-content"><i class="fas fa-eye"></i> Page Visit Referral Test</span>
                    </button>
                    <button data-section="order_test">
                        <span class="button-content"><i class="fas fa-shopping-cart"></i> Order Referral Test</span>
                    </button>
                </div>
            </div>
            {% include 'account_menu.inc' with context %}
        </div>
    </div>
    <div class="content-wrapper">
        {% include 'welcome.inc' with context %}
        <div id="deal_listings" class="section" style="display: none;">
            <h2>Discounted Deal Listings</h2>
            <p>This section displays all currently active deal listings available across your affiliate programs.</p>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1; max-width: 300px;">
                    <h3>Categories</h3>
                    <div class="treeview" id="categoryTree"></div>
                </div>
                <div style="flex: 2;">
                    <table class="deals-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Title</th>
                                <th>URL</th>
                                <th>Price</th>
                                <th>Original</th>
                                <th>Discount %</th>
                                <th>Image</th>
                                <th>QTY</th>
                            </tr>
                        </thead>
                        <tbody id="dealList"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="affiliates" class="section" style="display: none;">
            <h2>Affiliate Programs</h2>
            <p>Use this section to manage your affiliate program credentials.</p>
            <div id="affiliate-icons" style="display: flex; gap: 20px; margin-bottom: 20px;"></div>
            <form id="affiliate-form" style="display: none;">
                <div id="affiliate-fields">
                    <i class="selected-setting-icon" style="font-size: 16px; color: currentColor; margin-right: 10px; vertical-align: middle;"></i>
                    <h3 class="affiliate-comment-heading" style="display: inline-block; vertical-align: middle;"></h3>
                    <a href="#" class="affiliate-api-link" style="margin-left: 10px; display: none; vertical-align: middle; color: currentColor;"><i class="fas fa-link" style="font-size: 16px;"></i></a>
                    <a href="#" class="affiliate-signup-link" style="margin-left: 10px; display: none; vertical-align: middle; color: currentColor;"><i class="fas fa-user-plus" style="font-size: 16px;"></i></a>
                    <a href="#" class="affiliate-readme-link" style="margin-left: 10px; display: none; vertical-align: middle; color: currentColor;"><i class="fas fa-book" style="font-size: 16px;"></i></a>
                    <a href="#" class="affiliate-keys-link" style="margin-left: 10px; display: none; vertical-align: middle; color: currentColor;"><i class="fas fa-key" style="font-size: 16px;"></i></a>
                    <p class="affiliate-description" style="margin-bottom: 15px;"></p>
                    <div id="affiliate-readme-content" style="display: none;"></div>
                </div>
                <button type="submit" class="btn" style="margin-top: 10px; color: currentColor; padding: 5px 10px;"><i class="fas fa-save" style="margin-right: 5px;"></i>Save Settings</button>
            </form>
        </div>
        <div id="site_settings" class="section" style="display: none;">
            <h2>Site Settings</h2>
            <p>Use this section to manage site-wide settings and API credentials.</p>
            <div id="site-settings-icons" style="display: flex; gap: 20px; margin-bottom: 20px;"></div>
            <form id="site-settings-form" style="display: none;">
                <div id="site-settings-fields">
                    <i class="selected-setting-icon" style="font-size: 16px; color: currentColor; margin-right: 10px; vertical-align: middle;"></i>
                    <h3 class="site-settings-comment-heading" style="display: inline-block; vertical-align: middle;"></h3>
                    <a href="#" class="site-settings-api-link" style="margin-left: 10px; display: none; vertical-align: middle; color: currentColor;"><i class="fas fa-link" style="font-size: 16px;"></i></a>
                    <p class="site-settings-description" style="margin-bottom: 15px;"></p>
                </div>
                <button type="submit" class="btn" style="margin-top: 10px; color: currentColor; padding: 5px 10px;"><i class="fas fa-save" style="margin-right: 5px;"></i>Save Settings</button>
            </form>
        </div>
        <div id="userManagementIntro" class="section" style="display: none;">
            <h2>User Management</h2>
            <p>This section allows you to manage different types of users in your system.</p>
            <p>Select a user type from the menu to view their details or modify their permissions:</p>
            <ul>
                <li><strong>Admin:</strong> Manage users with Admin permissions.</li>
                <li><strong>Partners:</strong> Manage users with WixPro permissions.</li>
                <li><strong>Communities:</strong> Manage community users.</li>
                <li><strong>Merchants:</strong> Manage merchant users.</li>
            </ul>
        </div>
        <div id="user_management" class="section" style="display: none;">
            <h2><span id="user_role_icon" class="menu-size"></span> <span id="user_role_title"></span></h2>
            <table>
                <thead>
                    <tr>
                        <th>USERid</th>
                        <th>Contact Name</th>
                        <th>Website URL</th>
                        <th>Email</th>
                        <th>Phone Number</th>
                        <th>Permissions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="user_list"></tbody>
            </table>
        </div>
        <div id="testScriptsIntro" class="section" style="display: none;">
            <h2>Test Scripts</h2>
            <p>Use this section to test referral tracking and other scripts.</p>
            <p>Select an option from the menu to visit endpoints or run referral tests under "Referral Tests."</p>
        </div>
        <div id="referralTestsIntro" class="section" style="display: none;">
            <h2>Referral Tests</h2>
            <p>This section contains tools to test referral tracking functionality.</p>
            <p>Choose "Page Visit Referral Test" or "Order Referral Test" to submit test data and verify tracking behavior.</p>
        </div>
        <div id="page_visit_test" class="section" style="display: none;">
            <h2>Page Visit Referral Test</h2>
            <div class="form">
                <form id="pageVisitForm">
                    <table>
                        <tr>
                            <td><label for="pageReferer">Referer:</label></td>
                            <td><select id="pageReferer" name="referer"></select></td>
                        </tr>
                        <tr>
                            <td><label for="page">Page:</label></td>
                            <td><input type="text" id="page" name="page" value="/home"></td>
                        </tr>
                        <tr>
                            <td><label for="pageTimestamp">Timestamp:</label></td>
                            <td><input type="text" id="pageTimestamp" name="timestamp"></td>
                        </tr>
                        <tr>
                            <td colspan="2"><button type="submit">Submit Page Visit</button></td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
        <div id="order_test" class="section" style="display: none;">
            <h2>Order Referral Test</h2>
            <div class="form">
                <form id="orderForm">
                    <table>
                        <tr>
                            <td><label for="orderReferer">Referer:</label></td>
                            <td><select id="orderReferer" name="referer"></select></td>
                        </tr>
                        <tr>
                            <td><label for="orderId">Order ID:</label></td>
                            <td><input type="text" id="orderId" name="orderId" value="ORD12345"></td>
                        </tr>
                        <tr>
                            <td><label for="buyer">Buyer Name:</label></td>
                            <td><input type="text" id="buyer" name="buyer" value="John Doe"></td>
                        </tr>
                        <tr>
                            <td><label for="total">Total Amount (£):</label></td>
                            <td><input type="number" id="total" name="total" value="99.99" step="0.01"></td>
                        </tr>
                        <tr>
                            <td><label for="orderTimestamp">Timestamp:</label></td>
                            <td><input type="text" id="orderTimestamp" name="timestamp"></td>
                        </tr>
                        <tr>
                            <td colspan="2"><button type="submit">Submit Order</button></td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
base.inc
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title | default('clubmadeira.io') }}</title>
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Local CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/icons.css?v=1.0.1') }}">
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='black' d='M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160zM201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'/></svg>" type="image/svg+xml">
    <!-- Fallback for browsers that don't support SVG favicons -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <!-- Dynamic API URL -->
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <!-- External JS -->
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" defer></script>
    <script src="https://cdn.tiny.cloud/1/YOUR_API_KEY/tinymce/6/tinymce.min.js" defer></script>
    <!-- Load common.js early for Toastr setup -->
    <script src="{{ url_for('static', filename='js/common.js') }}" defer></script>
</head>
<body>
    <div class="layout-wrapper">
        <div class="header">
            {% include 'roles.inc' %}            
        </div>        
        {% include 'overlay.inc' %}
        {% block content %}{% endblock %}
    </div>

    <!-- Local JS -->
    <script src="{{ url_for('static', filename='js/site-auth.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/site-navigation.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/category-management.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/site-request.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/user-management.js') }}" defer></script>    
    <script src="{{ url_for('static', filename='js/admin-page.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/merchant-page.js') }}" defer></script>    
    <script src="{{ url_for('static', filename='js/partner-page.js') }}" defer></script>    
    <script src="{{ url_for('static', filename='js/community-page.js') }}" defer></script>    
    <script src="{{ url_for('static', filename='js/page-load.js') }}" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const layoutWrapper = document.querySelector('.layout-wrapper');
            layoutWrapper.style.display = 'none'; // Hide initially

            // Pass page type from Flask
            const pageType = '{{ page_type | default("default") }}';

            // Ensure navigation is initialized even if page-specific initialization fails
            function initializeFallback() {
                if (typeof window.siteNavigation?.initializeNavigation === 'function') {
                    console.log('initializeFallback - Initializing navigation');
                    window.siteNavigation.initializeNavigation();
                } else {
                    console.error('initializeFallback - siteNavigation.initializeNavigation not found');
                }
                layoutWrapper.style.display = 'block'; // Show the layout
            }

            // Attempt page-specific initialization
            if (typeof window.initialize === 'function') {
                console.log(`Initializing page for type: ${pageType}`);
                window.initialize(pageType);
            } else {
                console.warn('window.initialize not found, falling back to navigation initialization');
                initializeFallback();
            }

            // Add event listeners for markdown rendering
            if (typeof window.renderMdPage === 'function') {
                document.querySelectorAll('.md-link').forEach(link => {
                    link.addEventListener('click', function(event) {
                        event.preventDefault(); // Prevent default link behavior
                        const mdPath = this.getAttribute('data-md-path'); // Get markdown path from attribute
                        const targetId = 'md-render-target'; // Define target element ID
                        window.renderMdPage(mdPath, targetId); // Call renderMdPage
                    });
                });
            } else {
                console.error('renderMdPage is not defined');
            }
        });
    </script>
</body>
</html>
community.html
{% extends "base.inc" %}

{% block body_attributes %}data-page-type="admin"{% endblock %}

{% block content %}
<div class="main-container">
    <div class="menu-container">
        <div class="menu">
            <button data-section="deal_listings">
                <span class="button-content"><i class="fas fa-tags"></i> Deal Listings</span>
            </button>
            <button data-section="affiliates">
                <span class="button-content"><i class="fas fa-handshake"></i> Affiliate Programs</span>
            </button>
            <button data-section="site_settings">
                <span class="button-content"><i class="fas fa-tools"></i> Site Settings</span>
            </button>
            <button data-submenu="userManagement" data-section="userManagementIntro">
                <span class="button-content"><i class="fas fa-users"></i> User Management</span>
                <i class="fas fa-caret-right caret"></i>
            </button>
            <div id="userManagement" class="submenu">
                <button data-section="user_management" data-role="admin">
                    <span class="button-content">
                        <i class="icon-admin" style="height: 16px; width: 16px;"></i> Admin
                    </span>
                </button>
                <button data-section="user_management" data-role="wixpro">
                    <span class="button-content">
                        <i class="icon-partner" style="height: 16px; width: 16px;"></i> Partners
                    </span>
                </button>
                <button data-section="user_management" data-role="community">
                    <span class="button-content">
                        <i class="icon-community" style="height: 16px; width: 16px;"></i> Communities
                    </span>
                </button>
                <button data-section="user_management" data-role="merchant">
                    <span class="button-content">
                        <i class="icon-merchant" style="height: 16px; width: 16px;"></i> Merchants
                    </span>
                </button>
            </div>
            <button data-submenu="testScripts" data-section="testScriptsIntro">
                <span class="button-content"><i class="fas fa-flask"></i> Test Scripts</span>
                <i class="fas fa-caret-right caret"></i>
            </button>
            <div id="testScripts" class="submenu">
                <button data-href="/partner">
                    <span class="button-content">
                        <span class="icon-group">
                            <i class="icon-partner" style="height: 16px; width: 16px;"></i>
                            <i class="fas fa-flask small-icon"></i>
                        </span> Partner
                    </span>
                </button>
                <button data-href="/community">
                    <span class="button-content">
                        <span class="icon-group">
                            <i class="icon-community" style="height: 16px; width: 16px;"></i>                            
                            <i class="fas fa-flask small-icon"></i>
                        </span> Community
                    </span>
                </button>
                <button data-href="/merchant">
                    <span class="button-content">
                        <span class="icon-group">
                            <i class="icon-merchant" style="height: 16px; width: 16px;"></i>                            
                            <i class="fas fa-flask small-icon"></i>
                        </span> Merchant
                    </span>
                </button>
                <button data-submenu="referralTests" data-section="referralTestsIntro">
                    <span class="button-content"><i class="fas fa-link"></i> Referral Tests</span>
                    <i class="fas fa-caret-right caret"></i>
                </button>
                <div id="referralTests" class="submenu">
                    <button data-section="page_visit_test">
                        <span class="button-content"><i class="fas fa-eye"></i> Page Visit Referral Test</span>
                    </button>
                    <button data-section="order_test">
                        <span class="button-content"><i class="fas fa-shopping-cart"></i> Order Referral Test</span>
                    </button>
                </div>
            </div>
            {% include 'account_menu.inc' with context %}
        </div>
    </div>
    <div class="content-wrapper">
        {% include 'welcome.inc' with context %}
        <div id="deal_listings" class="section" style="display: none;">
            <h2>Discounted Deal Listings</h2>
            <p>This section displays all currently active deal listings available across your affiliate programs.</p>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1; max-width: 300px;">
                    <h3>Categories</h3>
                    <div class="treeview" id="categoryTree"></div>
                </div>
                <div style="flex: 2;">
                    <table class="deals-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Title</th>
                                <th>URL</th>
                                <th>Price</th>
                                <th>Original</th>
                                <th>Discount %</th>
                                <th>Image</th>
                                <th>QTY</th>
                            </tr>
                        </thead>
                        <tbody id="dealList"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="affiliates" class="section" style="display: none;">
            <h2>Affiliate Programs</h2>
            <p>Use this section to manage your affiliate program credentials.</p>
            <div id="affiliate-icons" style="display: flex; gap: 20px; margin-bottom: 20px;"></div>
            <form id="affiliate-form" style="display: none;">
                <div id="affiliate-fields">
                    <i class="selected-setting-icon" style="font-size: 16px; color: currentColor; margin-right: 10px; vertical-align: middle;"></i>
                    <h3 class="affiliate-comment-heading" style="display: inline-block; vertical-align: middle;"></h3>
                    <a href="#" class="affiliate-api-link" style="margin-left: 10px; display: none; vertical-align: middle; color: currentColor;"><i class="fas fa-link" style="font-size: 16px;"></i></a>
                    <a href="#" class="affiliate-signup-link" style="margin-left: 10px; display: none; vertical-align: middle; color: currentColor;"><i class="fas fa-user-plus" style="font-size: 16px;"></i></a>
                    <a href="#" class="affiliate-readme-link" style="margin-left: 10px; display: none; vertical-align: middle; color: currentColor;"><i class="fas fa-book" style="font-size: 16px;"></i></a>
                    <a href="#" class="affiliate-keys-link" style="margin-left: 10px; display: none; vertical-align: middle; color: currentColor;"><i class="fas fa-key" style="font-size: 16px;"></i></a>
                    <p class="affiliate-description" style="margin-bottom: 15px;"></p>
                    <div id="affiliate-readme-content" style="display: none;"></div>
                </div>
                <button type="submit" class="btn" style="margin-top: 10px; color: currentColor; padding: 5px 10px;"><i class="fas fa-save" style="margin-right: 5px;"></i>Save Settings</button>
            </form>
        </div>
        <div id="site_settings" class="section" style="display: none;">
            <h2>Site Settings</h2>
            <p>Use this section to manage site-wide settings and API credentials.</p>
            <div id="site-settings-icons" style="display: flex; gap: 20px; margin-bottom: 20px;"></div>
            <form id="site-settings-form" style="display: none;">
                <div id="site-settings-fields">
                    <i class="selected-setting-icon" style="font-size: 16px; color: currentColor; margin-right: 10px; vertical-align: middle;"></i>
                    <h3 class="site-settings-comment-heading" style="display: inline-block; vertical-align: middle;"></h3>
                    <a href="#" class="site-settings-api-link" style="margin-left: 10px; display: none; vertical-align: middle; color: currentColor;"><i class="fas fa-link" style="font-size: 16px;"></i></a>
                    <p class="site-settings-description" style="margin-bottom: 15px;"></p>
                </div>
                <button type="submit" class="btn" style="margin-top: 10px; color: currentColor; padding: 5px 10px;"><i class="fas fa-save" style="margin-right: 5px;"></i>Save Settings</button>
            </form>
        </div>
        <div id="userManagementIntro" class="section" style="display: none;">
            <h2>User Management</h2>
            <p>This section allows you to manage different types of users in your system.</p>
            <p>Select a user type from the menu to view their details or modify their permissions:</p>
            <ul>
                <li><strong>Admin:</strong> Manage users with Admin permissions.</li>
                <li><strong>Partners:</strong> Manage users with WixPro permissions.</li>
                <li><strong>Communities:</strong> Manage community users.</li>
                <li><strong>Merchants:</strong> Manage merchant users.</li>
            </ul>
        </div>
        <div id="user_management" class="section" style="display: none;">
            <h2><span id="user_role_icon" class="menu-size"></span> <span id="user_role_title"></span></h2>
            <table>
                <thead>
                    <tr>
                        <th>USERid</th>
                        <th>Contact Name</th>
                        <th>Website URL</th>
                        <th>Email</th>
                        <th>Phone Number</th>
                        <th>Permissions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="user_list"></tbody>
            </table>
        </div>
        <div id="testScriptsIntro" class="section" style="display: none;">
            <h2>Test Scripts</h2>
            <p>Use this section to test referral tracking and other scripts.</p>
            <p>Select an option from the menu to visit endpoints or run referral tests under "Referral Tests."</p>
        </div>
        <div id="referralTestsIntro" class="section" style="display: none;">
            <h2>Referral Tests</h2>
            <p>This section contains tools to test referral tracking functionality.</p>
            <p>Choose "Page Visit Referral Test" or "Order Referral Test" to submit test data and verify tracking behavior.</p>
        </div>
        <div id="page_visit_test" class="section" style="display: none;">
            <h2>Page Visit Referral Test</h2>
            <div class="form">
                <form id="pageVisitForm">
                    <table>
                        <tr>
                            <td><label for="pageReferer">Referer:</label></td>
                            <td><select id="pageReferer" name="referer"></select></td>
                        </tr>
                        <tr>
                            <td><label for="page">Page:</label></td>
                            <td><input type="text" id="page" name="page" value="/home"></td>
                        </tr>
                        <tr>
                            <td><label for="pageTimestamp">Timestamp:</label></td>
                            <td><input type="text" id="pageTimestamp" name="timestamp"></td>
                        </tr>
                        <tr>
                            <td colspan="2"><button type="submit">Submit Page Visit</button></td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
        <div id="order_test" class="section" style="display: none;">
            <h2>Order Referral Test</h2>
            <div class="form">
                <form id="orderForm">
                    <table>
                        <tr>
                            <td><label for="orderReferer">Referer:</label></td>
                            <td><select id="orderReferer" name="referer"></select></td>
                        </tr>
                        <tr>
                            <td><label for="orderId">Order ID:</label></td>
                            <td><input type="text" id="orderId" name="orderId" value="ORD12345"></td>
                        </tr>
                        <tr>
                            <td><label for="buyer">Buyer Name:</label></td>
                            <td><input type="text" id="buyer" name="buyer" value="John Doe"></td>
                        </tr>
                        <tr>
                            <td><label for="total">Total Amount (£):</label></td>
                            <td><input type="number" id="total" name="total" value="99.99" step="0.01"></td>
                        </tr>
                        <tr>
                            <td><label for="orderTimestamp">Timestamp:</label></td>
                            <td><input type="text" id="orderTimestamp" name="timestamp"></td>
                        </tr>
                        <tr>
                            <td colspan="2"><button type="submit">Submit Order</button></td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
login.html
{% extends "base.inc" %}
{% block body_attributes %}data-page-type="login"{% endblock %}
{% block content %}
<!-- Deployed 2025-03-31 v11 -->
<div class="login-page">
    <div id="loadingOverlay" class="hidden">
        <div class="multicircle-loader">
            <div class="circle circle1"></div>
            <div class="circle circle2"></div>
            <div class="circle circle3"></div>
            <div class="circle circle4"></div>
        </div>
    </div>

    <div class="container hidden" id="loginContainer">
        <h2>Login</h2>
        <div class="custom-login-notice">
            <span class="highlight">Please log in</span> to access your account. If you don’t have an account, click "Sign Up" below.
        </div>
        <form id="loginForm" class="form" method="POST" action="/">
            <div class="form-group">
                <label for="loginEmail">Email:</label>
                <div class="input-container">
                    <input type="email" id="loginEmail" name="email" placeholder="Enter your email" required>
                </div>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password:</label>
                <div class="input-container">
                    <input type="password" id="loginPassword" name="password" placeholder="Enter your password" required>
                    <span class="toggle-password"><i class="fas fa-eye"></i></span>
                </div>
            </div>
            <button type="submit">Login</button>
        </form>
        <div class="toggle-link">
            <a href="{{ url_for('authentication_bp.signup') }}">Need an account? Sign Up</a><br>
            <a onclick="showForgotPassword()">Forgot Password?</a>
        </div>
    </div>

    <div class="container hidden" id="forgotPasswordContainer">
        <h2>Forgot Password</h2>
        <form id="forgotPasswordForm" class="form" method="POST" action="/reset-password">
            <div class="form-group">
                <label for="forgotEmail">Email:</label>
                <input type="email" id="forgotEmail" name="email" placeholder="Enter your email" required>
            </div>
            <button type="submit">Send OTP via SMS</button>
        </form>
        <div class="toggle-link">
            <a onclick="showLogin()">Back to Login</a>
        </div>
    </div>

    <div class="container hidden" id="verifyOtpContainer">
        <h2>Verify OTP</h2>
        <form id="verifyOtpForm" class="form" method="POST" action="/verify-reset-code">
            <div class="form-group">
                <label for="verifyEmail">Email:</label>
                <input type="email" id="verifyEmail" name="email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="otpCode">One-Time Password:</label>
                <input type="text" id="otpCode" name="code" placeholder="Enter the OTP from SMS" required>
            </div>
            <div class="form-group">
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" name="new_password" placeholder="Enter new password" required>
            </div>
            <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password:</label>
                <input type="password" id="confirmNewPassword" name="confirm_new_password" placeholder="Confirm new password" required>
            </div>
            <button type="submit">Update Password</button>
        </form>
        <div class="toggle-link">
            <a onclick="showLogin()">Back to Login</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Login script loaded - Version: v11 - Timestamp:', new Date().toISOString());

        if (!window.apiUrl) {
            console.error('window.apiUrl is not defined. Form will submit natively.');
            showLogin();
            return;
        }

        if (!window.siteNavigation || !window.decodeJWT || !window.initialize) {
            console.error('Required scripts not loaded. Falling back to native form submission.');
            toastr.error('Failed to load required scripts. Please refresh the page.');
            showLogin();
            return;
        }

        function showLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.add('hidden');
        }

        function showLogin() {
            const loginContainer = document.getElementById('loginContainer');
            const forgotContainer = document.getElementById('forgotPasswordContainer');
            const verifyContainer = document.getElementById('verifyOtpContainer');
            if (loginContainer) loginContainer.classList.remove('hidden');
            if (forgotContainer) forgotContainer.classList.add('hidden');
            if (verifyContainer) verifyContainer.classList.add('hidden');
            hideLoadingOverlay();
        }

        function showForgotPassword() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('forgotPasswordContainer').classList.remove('hidden');
            document.getElementById('verifyOtpContainer').classList.add('hidden');
            hideLoadingOverlay();
        }

        function showVerifyOtp(email) {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('forgotPasswordContainer').classList.add('hidden');
            document.getElementById('verifyOtpContainer').classList.remove('hidden');
            document.getElementById('verifyEmail').value = email;
            hideLoadingOverlay();
        }

        // Utility to set a cookie
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax; Secure";
            console.log('setCookie - Set cookie:', name, 'Value:', value);
        }

        // Utility to get a cookie
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Utility to delete a cookie
        function deleteCookie(name) {
            document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/; SameSite=Lax; Secure';
            console.log('deleteCookie - Deleted cookie:', name);
        }

        document.querySelectorAll('.toggle-password').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const input = this.parentElement.querySelector('input');
                const icon = this.querySelector('i');
                input.type = input.type === 'password' ? 'text' : 'password';
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
        });

        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('Login form submitted');
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;

                if (!email || !password) {
                    toastr.error('Please enter both email and password.');
                    return;
                }

                showLoadingOverlay();
                try {
                    const response = await fetch('/', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Accept': 'application/json' 
                        },
                        body: JSON.stringify({ email, password }),
                        credentials: 'include' // Ensure cookies are sent
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Login failed');
                    }

                    const data = await response.json();
                    if (data.status !== 'success') throw new Error(data.message || 'Login failed');

                    localStorage.setItem('authToken', data.token);
                    if (data.user_id) localStorage.setItem('userId', data.user_id);  // Already "user_id", kept for consistency
                    localStorage.setItem('expectedPageType', data['x-role']);
                    setCookie('authToken', data.token, 7); // Explicitly set cookie before redirect
                    console.log('Login success - Token:', data.token, 'Redirecting to:', data.redirect_url);
                    window.location.href = data.redirect_url;
                } catch (error) {
                    console.error('Login error:', error.message);
                    toastr.error(error.message || 'Unable to connect to server.');
                    hideLoadingOverlay();
                    showLogin();
                }
            });
        }

        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        if (forgotPasswordForm) {
            forgotPasswordForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('forgotEmail').value.trim();

                showLoadingOverlay();
                try {
                    const response = await fetch(`${window.apiUrl}/reset-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Reset request failed');

                    toastr.success('A one-time password has been sent to your phone.');
                    showVerifyOtp(email);
                } catch (error) {
                    toastr.error(error.message || 'Error sending OTP');
                    hideLoadingOverlay();
                }
            });
        }

        const verifyOtpForm = document.getElementById('verifyOtpForm');
        if (verifyOtpForm) {
            verifyOtpForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('verifyEmail').value.trim();
                const code = document.getElementById('otpCode').value.trim();
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;

                const passwordRegex = /^(?=.*\d).{8,}$/;
                if (!passwordRegex.test(newPassword)) {
                    toastr.error('New password must be at least 8 characters long and include numbers');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    toastr.error('New password and confirmation do not match');
                    return;
                }

                showLoadingOverlay();
                try {
                    const response = await window.siteNavigation.authenticatedFetch(`${window.apiUrl}/verify-reset-code`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, code, new_password: newPassword })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Verification failed');

                    toastr.success('Password updated successfully!');
                    showLogin();
                } catch (error) {
                    toastr.error(error.message || 'Error verifying OTP');
                    hideLoadingOverlay();
                }
            });
        }

        // Check if already logged in on page load
        const token = localStorage.getItem('authToken');
        const currentPageType = document.body.getAttribute('data-page-type') || 'login';
        const expectedPageType = localStorage.getItem('expectedPageType') || 'login';
        const redirectCount = parseInt(localStorage.getItem('loginRedirectCount') || '0');
        const xPageType = document.head.querySelector('meta[name="x-page-type"]')?.content || currentPageType;

        console.log('Page load check - Token:', token ? '[present]' : 'null', 'Current Page Type:', currentPageType, 'Expected Page Type:', expectedPageType, 'X-Page-Type:', xPageType, 'Redirect Count:', redirectCount);

        if (token && currentPageType === 'login' && expectedPageType !== 'login') {
            if (redirectCount > 2) {
                console.error('Login redirect loop detected, clearing token');
                localStorage.removeItem('authToken');
                localStorage.removeItem('expectedPageType');
                localStorage.setItem('loginRedirectCount', '0');
                deleteCookie('authToken');
                showLogin();
            } else if (xPageType === 'login') {
                console.error('Server returned login page despite valid token, possible session mismatch');
                toastr.error('Session issue detected, please log in again');
                localStorage.removeItem('authToken');
                localStorage.removeItem('expectedPageType');
                localStorage.setItem('loginRedirectCount', '0');
                deleteCookie('authToken');
                showLogin();
            } else {
                console.log('Redirecting to / with token, incrementing redirect count');
                localStorage.setItem('loginRedirectCount', redirectCount + 1);
                setCookie('authToken', token, 7);
                window.location.href = '/';
            }
        } else {
            localStorage.setItem('loginRedirectCount', '0');
            localStorage.removeItem('expectedPageType');
            showLogin();
        }
    });
</script>
{% endblock %}
merchant.html
{% extends 'base.inc' %}
{% block body_attributes %}data-page-type="merchant"{% endblock %}
{% block content %}
    <div class="main-container" style="margin-top: 0; padding-top: 0;">
        <!-- Menu Container -->
        <div class="menu-container">
            <div class="menu">
                <input type="text" id="userId" style="display: none;" value="{{ user.user_id if user else '' }}">
                <button data-section="info">
                    <span class="button-content"><i class="fas fa-home"></i> Dashboard</span>
                </button>
                <button data-section="my-products">
                    <span class="button-content"><i class="fas fa-box-open"></i> My Products</span>
                </button>
                <button data-submenu="my-store-submenu" data-section="store-request">
                    <span class="button-content"><i class="fas fa-store"></i> My Store Request</span>
                    <i class="fas fa-caret-right caret"></i>
                </button>
                <div id="my-store-submenu" class="submenu">
                    <button data-section="api-keys">
                        <span class="button-content"><i class="fas fa-key"></i> API Keys</span>
                    </button>
                    <button data-section="create-store">
                        <span class="button-content"><i class="fas fa-store-alt"></i> Create Store</span>
                    </button>
                </div>
                <button data-submenu="documentation-submenu" data-section="documentation-content">
                    <span class="button-content"><i class="fas fa-book"></i> Documentation</span>
                    <i class="fas fa-caret-right caret"></i>
                </button>
                <div id="documentation-submenu" class="submenu">
                    <!-- Submenu items will be dynamically inserted here via JavaScript -->
                </div>
                {% include 'account_menu.inc' with context %}
            </div>
        </div>

        <!-- Content Wrapper -->
        <div class="content-wrapper" style="margin-top: 0;">  
            {% include 'welcome.inc' with context %}       
            <div id="store-request" class="section" style="display: none;">
                <h2>My Store Request</h2>
                <p>Manage your store request details here.</p>
            </div>
            <div id="api-keys" class="section" style="display: none;">
                <h2>API Keys</h2>
                <div id="api-keys-icons" style="display: flex; gap: 20px; margin-bottom: 20px;"></div>
                <form id="api-keys-form" style="display: none;">
                    <div id="api-keys-fields"></div>
                    <button type="submit" class="btn" style="margin-top: 10px;">Submit</button>
                </form>
            </div>
            <div id="create-store" class="section" style="display: none;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <i class="fas fa-store" style="font-size: 32px; margin-right: 10px;"></i>
                    <h2>Create Store</h2>
                </div>
                <p>Request a custom Wix store to sell your products online. Provide details below to set up your store (minimum: Home and Returns Policy pages).</p>
                {% with user_type='merchant' %}
                    {% include 'siterequest.inc' %}
                {% endwith %}
            </div>
            <div id="my-products" class="section" style="display: none;">
                <h2>My Products</h2>
                <p>These are the products from your parts feed.</p>
                <table id="productTable">
                    <thead>
                        <tr><th class="hidden">ID</th><th>Category</th><th>Title</th><th>URL</th><th>Price</th><th>Original</th><th>Image</th><th>QTY</th></tr>
                    </thead>
                    <tbody id="productList"></tbody>
                </table>
            </div>
            <div id="documentation-content" class="section" style="display: none;">                
                <div id="md-render-target">
                    <p>Select a documentation item from the menu to view the details.</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        console.log('merchant.html - Template loaded');
    </script>
{% endblock %}
overlay.inc
<div id="loadingOverlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 1); justify-content: center; align-items: center; z-index: 9999;">
    <div style="position: relative; width: 200px; height: 200px;">
        <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 120px; height: 120px; border-top-color: #ff6f61; top: 40px; left: 40px; animation-delay: 0s;"></div>
        <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 90px; height: 90px; border-top-color: #6bff61; top: 55px; left: 55px; animation-delay: 0.3s;"></div>
        <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 60px; height: 60px; border-top-color: #61cfff; top: 70px; left: 70px; animation-delay: 0.6s;"></div>
        <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 30px; height: 30px; border-top-color: #ff61ff; top: 85px; left: 85px; animation-delay: 0.9s;"></div>
    </div>
</div>
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
partner.html
{% extends "base.inc" %}
{% block body_attributes %}data-page-type="partner"{% endblock %}
{% block content %}
    <div class="main-container">
        <div class="menu-container">
            <div class="menu">
                <input type="text" id="userId" style="display: none;" value="{{ user.user_id if user else '' }}">
                <button data-section="info">
                    <span class="button-content"><i class="fas fa-home"></i> Dashboard</span>
                </button>
                <button data-section="integrations">
                    <span class="button-content"><i class="fas fa-plug"></i> Integrations</span>
                </button>
                <button data-submenu="my-account-submenu" data-section="my-account">
                    <span class="button-content"><i class="fas fa-cog"></i> My Account</span>
                    <i class="fas fa-caret-right caret"></i>
                </button>
                <div id="my-account-submenu" class="submenu">
                    <button data-section="my-account">
                        <span class="button-content"><i class="fas fa-address-book"></i> Contact</span>
                    </button>
                    <button data-section="change-password">
                        <span class="button-content"><i class="fas fa-key"></i> Change Password</span>
                    </button>
                </div>
                {% include 'account_menu.inc' with context %}
            </div>
        </div>
        <div class="content-wrapper">
            {% include 'welcome.inc' with context %}
            <div id="integrations" class="section" style="display: none;">
                <h2>Integrations</h2>
                <p>View your integration statuses below.</p>
                <ul id="integrationList"></ul>
            </div>
            <div id="my-account" class="section" style="display: none;">
                <h2>My Account</h2>
                <p>Update your contact details here.</p>
                <!-- Assuming this is populated dynamically or via account_menu.inc -->
            </div>
            <div id="change-password" class="section" style="display: none;">
                <h2>Change Password</h2>
                <p>Change your password here.</p>
                <!-- Assuming this is populated dynamically or via account_menu.inc -->
            </div>
        </div>
    </div>
    <script>
        console.log('partner.html - Template loaded');
    </script>
{% endblock %}
roles.inc
<!-- templates/roles.inc -->
{% if page_type == 'admin' %}
<button data-section="info" style="color: currentcolor; padding: 20px; border-radius: 8px; display: flex; align-items: center; gap: 25px; height: 120px; box-sizing: border-box; overflow: visible; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
    <span class="icon-admin" style="width: 50px; height: 50px;"></span>
    <div>
        <h1 style="margin: 0; font-size: 24px; color: currentcolor;">Admin Dashboard</h1>
        <p style="margin: 5px 0 0; font-size: 14px; opacity: 0.9; color: currentcolor;">Manage your platform with powerful tools and insights.</p>
    </div>
</button>
{% elif page_type == 'merchant' %}
<button data-section="info" style="color: currentcolor; padding: 20px; border-radius: 8px; display: flex; align-items: center; gap: 15px; height: 120px; box-sizing: border-box; overflow: visible; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
    <span class="icon-merchant" style="width: 50px; height: 50px;"></span>
    <div>
        <h1 style="margin: 0; font-size: 24px; color: currentcolor;">Merchant Dashboard</h1>
        <p style="margin: 5px 0 0; font-size: 14px; opacity: 0.9; color: currentcolor;">Track sales, manage deals, and grow your business.</p>
    </div>
</button>
{% elif page_type == 'community' %}
<button data-section="info" style="color: currentcolor; padding: 20px; border-radius: 8px; display: flex; align-items: center; gap: 15px; height: 120px; box-sizing: border-box; overflow: visible; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
    <span class="icon-community" style="width: 50px; height: 50px;"></span>
    <div>
        <h1 style="margin: 0; font-size: 24px; color: currentcolor;">Community Dashboard</h1>
        <p style="margin: 5px 0 0; font-size: 14px; opacity: 0.9; color: currentcolor;">Connect with members and share valuable resources.</p>
    </div>
</button>
{% elif page_type == 'partner' %}
<button data-section="info" style="color: currentcolor; padding: 20px; border-radius: 8px; display: flex; align-items: center; gap: 15px; height: 120px; box-sizing: border-box; overflow: visible; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
    <span class="icon-partner" style="width: 50px; height: 50px;"></span>
    <div>
        <h1 style="margin: 0; font-size: 24px; color: currentcolor;">Partner Dashboard</h1>
        <p style="margin: 5px 0 0; font-size: 14px; opacity: 0.9; color: currentcolor;">Collaborate and create with our partner tools.</p>
    </div>
</button>
{% else %}
<div style="color: currentcolor; padding: 20px; border-radius: 8px; display: flex; align-items: center; gap: 15px; height: 120px; box-sizing: border-box; overflow: visible;">
    <span class="icon-community" style="width: 50px; height: 50px;"></span>
    <div>
        <h1 style="margin: 0; font-size: 24px; color: currentcolor;">Welcome to clubmadeira.io</h1>
        <p style="margin: 5px 0 0; font-size: 14px; opacity: 0.9; color: currentcolor;">Log in to access your dashboard.</p>
    </div>
</div>
{% endif %}
signup.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/signup.css"> <!-- Link to combined styles with pulse -->
    <!-- Favicon: Font Awesome "group-arrows-rotate" SVG (Unicode f366) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path d='M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160zM201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'/></svg>" type="image/svg+xml">
</head>
<body>
    <div class="signup-container">
        <h1>Sign Up - I am a...</h1>
        <form id="signupForm" autocomplete="off">
            <!-- Dummy fields to trick autofill -->
            <input type="text" class="hidden" autocomplete="off">
            <input type="text" class="hidden" autocomplete="off">
            <div class="options">
                <label class="option">
                    <input type="radio" name="signup_type" value="community" checked>
                    <img src="{{ url_for('static', filename='img/community.jpg') }}" alt="Scout leader in uniform, neck down">
                    <span>Community Group</span>
                </label>
                <label class="option">
                    <input type="radio" name="signup_type" value="seller">
                    <img src="{{ url_for('static', filename='img/merchant.jpg') }}" alt="White man in business suit, neck down">
                    <span>Merchant</span>
                </label>
                <label class="option">
                    <input type="radio" name="signup_type" value="wixpro">
                    <img src="{{ url_for('static', filename='img/wixpro.jpg') }}" alt="Female ethnic web designer in casual dress, neck down">
                    <span>Partner</span>
                </label>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="contact_name">Contact Name:</label>
                    <div class="input-container">
                        <input type="text" id="contact_name" name="contact_name" required autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-phone">Phone Number:</label>
                    <div class="input-container">
                        <input type="tel" id="signup-phone" name="signup_phone" autocomplete="off" pattern="[0-9]{10}" title="Please enter a 10-digit phone number">
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email:</label>
                    <div class="input-container">
                        <input type="text" id="signup-email" name="signup_email" required autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password:</label>
                    <div class="input-container">
                        <input type="text" id="signup-password" name="signup_password" required autocomplete="new-password">
                        <i class="fas fa-eye toggle-password" data-target="signup-password"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-confirm-password">Confirm Password:</label>
                    <div class="input-container">
                        <input type="password" id="signup-confirm-password" name="signup_confirm_password" required autocomplete="new-password">
                        <i class="fas fa-eye toggle-password" data-target="signup-confirm-password"></i>
                    </div>
                </div>
                <button type="submit">Sign Me Up</button>
            </div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // Set correct input types and clear fields after load
        window.onload = function() {
            const emailInput = document.getElementById('signup-email');
            const passwordInput = document.getElementById('signup-password');
            const confirmPasswordInput = document.getElementById('signup-confirm-password');
            const phoneInput = document.getElementById('signup-phone');

            // Set proper types
            emailInput.type = 'email';
            passwordInput.type = 'password';

            // Double-clear strategy
            setTimeout(function() {
                emailInput.value = '';
                passwordInput.value = '';
                confirmPasswordInput.value = '';
                phoneInput.value = '';
            }, 100);

            setTimeout(function() {
                emailInput.value = '';
                passwordInput.value = '';
                confirmPasswordInput.value = '';
                phoneInput.value = '';
            }, 500); // Extra delay for Chrome

            // Set "Community Group" as selected by default
            const communityOption = document.querySelector('input[value="community"]').closest('.option');
            communityOption.classList.add('selected');
        };

        // Clear fields on focus
        document.getElementById('signup-email').addEventListener('focus', function() {
            this.value = '';
        });
        document.getElementById('signup-password').addEventListener('focus', function() {
            this.value = '';
        });
        document.getElementById('signup-confirm-password').addEventListener('focus', function() {
            this.value = '';
        });
        document.getElementById('signup-phone').addEventListener('focus', function() {
            this.value = '';
        });

        // Highlight selected option
        document.querySelectorAll('input[name="signup_type"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.option').forEach(function(option) {
                    option.classList.remove('selected');
                });
                if (this.checked) {
                    this.closest('.option').classList.add('selected');
                }
            });
        });

        // Dynamically set 'required' attribute for phone number based on signup type
        document.querySelectorAll('input[name="signup_type"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                const phoneInput = document.getElementById('signup-phone');
                if (this.value === 'wixpro') {
                    phoneInput.removeAttribute('required');
                } else {
                    phoneInput.setAttribute('required', '');
                }
            });

            // Set initial phone requirement based on default selection
            const phoneInput = document.getElementById('signup-phone');
            if (radio.value === 'community' && radio.checked) {
                phoneInput.setAttribute('required', '');
            }
        });

        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(function(icon) {
            icon.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if (input.type === 'password') {
                    input.type = 'text';
                    this.classList.remove('fa-eye');
                    this.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    this.classList.remove('fa-eye-slash');
                    this.classList.add('fa-eye');
                }
            });
        });

        // Form submission with OTP workflow
        $('#signupForm').on('submit', async function(e) {
            e.preventDefault();

            const signupType = $('input[name="signup_type"]:checked').val();
            if (!signupType) {
                toastr.error('Please select a signup type.');
                return;
            }

            const contactName = $('#contact_name').val().trim();
            const phone = $('#signup-phone').val().trim();
            const email = $('#signup-email').val().trim();
            const password = $('#signup-password').val().trim();
            const confirmPassword = $('#signup-confirm-password').val().trim();

            // Validation: Check all required fields, password match, and phone validity
            if (!contactName || !email || !password || !confirmPassword) {
                toastr.error('All fields except phone (for Partner) must be filled.');
                return;
            }

            if (password !== confirmPassword) {
                toastr.error('Passwords do not match.');
                return;
            }

            const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
            if (!passwordRegex.test(password)) {
                toastr.error('Password must be 8+ characters with letters and numbers.');
                return;
            }

            if (signupType !== 'wixpro') {
                if (!phone) {
                    toastr.error('Phone number is required for Community Group and Merchant.');
                    return;
                }
                const phoneRegex = /^\d{10}$/;
                if (!phoneRegex.test(phone)) {
                    toastr.error('Enter a valid 10-digit phone number (e.g., 1234567890).');
                    return;
                }
            }

            const signupData = { 
                signup_type: signupType, 
                contact_name: contactName, 
                signup_phone: phone || null, 
                signup_email: email, 
                signup_password: password 
            };

            try {
                // Step 1: Create user with /signup
                const signupResponse = await fetch('/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(signupData)
                });
                const signupDataResp = await signupResponse.json();
                if (!signupResponse.ok) throw new Error(signupDataResp.message || 'Signup failed');

                if (signupType === 'wixpro') {
                    // Partner: Direct to login
                    toastr.success('Signup successful! Redirecting to login...');
                    setTimeout(() => window.location.href = '/login', 2000);
                } else {
                    // Merchant/Community: Send OTP with /reset-password
                    const otpResponse = await fetch('/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const otpData = await otpResponse.json();
                    if (!otpResponse.ok) throw new Error(otpData.message || 'Failed to send OTP');

                    toastr.success('OTP sent to your phone. Please enter it below.');
                    const otpContainer = document.createElement('div');
                    otpContainer.innerHTML = `
                        <div class="form-group">
                            <label for="signupOtp">Enter OTP:</label>
                            <input type="text" id="signupOtp" name="otp" placeholder="Enter OTP" required>
                        </div>
                        <button id="verifyOtpBtn">Verify OTP</button>
                    `;
                    this.appendChild(otpContainer);
                    this.querySelector('.form-section').style.display = 'none';

                    document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
                        const otp = document.getElementById('signupOtp').value.trim();
                        if (!otp) {
                            toastr.error('Please enter the OTP.');
                            return;
                        }

                        // Step 2: Verify OTP with /verify-reset-code
                        const verifyResponse = await fetch('/verify-reset-code', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, code: otp, new_password: password })
                        });
                        const verifyData = await verifyResponse.json();
                        if (!verifyResponse.ok) throw new Error(verifyData.message || 'OTP verification failed');

                        // Step 3: Redirect to group page based on signup_type
                        toastr.success('Signup verified! Redirecting to your page...');
                        const redirectPath = signupType === 'seller' ? '/merchant' : '/community';
                        setTimeout(() => window.location.href = redirectPath, 2000);
                    });
                }
            } catch (error) {
                toastr.error(error.message || 'Error during signup/OTP process');
            }
        });

        // Toastr options
        toastr.options = {
            closeButton: true,
            progressBar: true,
            positionClass: 'toast-top-right',
            timeOut: 5000
        };
    </script>
</body>
</html>
siterequest.inc
<form id="siteRequestForm" class="settings-form">
    <input type="hidden" id="userType" value="{{ user_type }}">

    <label for="name">{{ 'Community Name' if user_type == 'community' else 'Store Name' }}:</label>
    <input type="text" id="name" name="name" placeholder="Enter your {{ 'community' if user_type == 'community' else 'store' }} name" required>

    <label for="about">{{ 'About Our Community' if user_type == 'community' else 'About Your Store' }}:</label>
    <textarea id="about" name="about" placeholder="Tell us about your {{ 'community' if user_type == 'community' else 'store' }}"></textarea>

    <label for="logos">{{ 'Community Logos' if user_type == 'community' else 'Store Logos' }}:</label>
    <input type="file" id="logos" name="logos" accept="image/*" multiple>
    <small>Upload up to 5 logos (e.g., main logo, secondary logos).</small>

    <label for="colorPrefs">Color Preferences:</label>
    <input type="text" id="colorPrefs" name="colorPrefs" placeholder="e.g., #FF5733, Blue">

    <label for="stylingDetails">Styling Details:</label>
    <textarea id="stylingDetails" name="stylingDetails" rows="4" placeholder="e.g., modern layout, bold fonts"></textarea>

    <label for="preferredDomain">Preferred Domain Name:</label>
    <input type="text" id="preferredDomain" name="preferredDomain" placeholder="e.g., my{{ 'community.org' if user_type == 'community' else 'store.uk' }}" oninput="updateEmailDomains()">
    <button type="button" data-action="checkDomainAvailability"><i class="fas fa-search"></i> Check Availability</button>

    <label>Email Addresses to Set Up (up to 5):</label>
    <div id="emailsContainer">
        <div class="email-section" data-email="1">
            <label for="email1Name">Email Name:</label>
            <input type="text" id="email1Name" name="email1Name" placeholder="e.g., info">
            <span id="email1Domain">@my{{ 'community.org' if user_type == 'community' else 'store.uk' }}</span>
        </div>
    </div>
    <button type="button" data-action="addEmail"><i class="fas fa-plus"></i> Add Another Email</button>

    <label>{{ 'Requested Pages (up to 5)' if user_type == 'community' else 'Required Pages' }}:</label>
    <div id="pagesContainer">
        {% if user_type == 'merchant' %}
            <!-- Fixed Home page -->
            <div class="page-section" data-page="1">
                <label for="page1Name">Page Name:</label>
                <input type="text" id="page1Name" name="page1Name" value="Home" readonly>
                <br><br>
                <label for="page1Content">Home Page Content:</label>
                <textarea id="page1Content" name="page1Content" placeholder="Describe your home page (e.g., welcome message, featured products)"></textarea>
                <label for="page1Images">Additional Images:</label>
                <input type="file" id="page1Images" name="page1Images" accept="image/*" multiple>
            </div>
            <!-- Fixed Returns Policy page -->
            <div class="page-section" data-page="2">
                <label for="page2Name">Page Name:</label>
                <input type="text" id="page2Name" name="page2Name" value="Returns Policy" readonly>
                <br><br>
                <label for="page2Content">Returns Policy Content:</label>
                <textarea id="page2Content" name="page2Content" placeholder="Outline your returns policy"></textarea>
                <label for="page2Images">Additional Images:</label>
                <input type="file" id="page2Images" name="page2Images" accept="image/*" multiple>
            </div>
        {% else %}
            <!-- Community starts with one customizable page -->
            <div class="page-section" data-page="1">
                <label for="page1Name">Page Name:</label>
                <input type="text" id="page1Name" name="page1Name" value="Home">
                <br><br>
                <label for="page1Content">Page Content:</label>
                <textarea id="page1Content" name="page1Content" placeholder="Describe this page"></textarea>
                <label for="page1Images">Additional Images:</label>
                <input type="file" id="page1Images" name="page1Images" accept="image/*" multiple>
            </div>
        {% endif %}
    </div>
    <button type="button" data-action="addPage"><i class="fas fa-plus"></i> Add Another Page</button>

    <label>{{ 'Wix Widgets' if user_type == 'community' else 'Wix Store Widgets' }}:</label>
    <div class="widget-checkboxes">
        {% if user_type == 'community' %}
            <div><label><input type="checkbox" name="widgets" value="events"> Events</label> - Add an events calendar.</div>
            <div><label><input type="checkbox" name="widgets" value="socialMediaFeeds"> Social Media Feeds</label> - Display live social media feeds.</div>
            <div><label><input type="checkbox" name="widgets" value="gallery"> Gallery</label> - Showcase photos.</div>
            <div><label><input type="checkbox" name="widgets" value="contactForm"> Contact Form</label> - Simple contact form.</div>
            <div><label><input type="checkbox" name="widgets" value="blog"> Blog</label> - Share updates and stories.</div>
            <div><label><input type="checkbox" name="widgets" value="weather"> Weather</label> - Show real-time weather.</div>
            <div><label><input type="checkbox" name="widgets" value="socialMediaLinks"> Social Media Links</label> - Quick links to profiles.</div>
        {% else %}
            <div><label><input type="checkbox" name="widgets" value="productCatalog"> Product Catalog</label> - Display your products.</div>
            <div><label><input type="checkbox" name="widgets" value="checkout"> Checkout</label> - Enable direct purchases.</div>
            <div><label><input type="checkbox" name="widgets" value="cart"> Shopping Cart</label> - Add a cart for customers.</div>
            <div><label><input type="checkbox" name="widgets" value="promotions"> Promotions</label> - Highlight sales and discounts.</div>
            <div><label><input type="checkbox" name="widgets" value="contactForm"> Contact Form</label> - Customer inquiries.</div>
        {% endif %}
    </div>

    <button type="button" data-action="saveSiteRequest"><i class="fas fa-paper-plane"></i> Submit Request</button>
</form>
welcome.inc
<!-- templates/welcome.inc -->
<div id="info" class="section">
    {% if page_type == 'admin' %}
        <h2>Admin Info</h2>
        <p id="welcome-message">Hello, <span id="user-contact-name">[User]</span>! This dashboard is your central hub for overseeing the clubmadeira.io platform.</p>
        <p>Use the menu to manage affiliate programs, deal listings, user permissions, and test scripts. This powerful toolset allows you to maintain and optimize the platform for all users.</p>
    {% elif page_type == 'merchant' %}
        <h2>Merchant Info</h2>
        <p id="welcome-message">Hello, <span id="user-contact-name">[User]</span>! This dashboard is designed for merchants to manage integrations with clubmadeira.io.</p>
        <p>Use the menu to manage products, your store, Wix integration, and account settings. Grow your business by leveraging our tools to showcase deals and track performance.</p>
    {% elif page_type == 'community' %}
        <h2>Community Info</h2>
        <p id="welcome-message">Hello, <span id="user-contact-name">[User]</span>! This dashboard connects your community with valuable resources on clubmadeira.io.</p>
        <p>Use the menu to integrate discounts into your website, select product categories, track referrals, and update account details. Build stronger ties by sharing benefits with your members.</p>
    {% elif page_type == 'partner' %}
        <h2>Partner Info</h2>
        <p id="welcome-message">Hello, <span id="user-contact-name">[User]</span>! This dashboard empowers partners to collaborate with merchants and communities on clubmadeira.io.</p>
        <p>Use the menu to manage integrations, review site requests, access documentation, and update your account. Work together to create tailored solutions for our users.</p>
    {% else %}
        <h2>Welcome</h2>
        <p id="welcome-message">Hello, <span id="user-contact-name">[User]</span>! Welcome to clubmadeira.io.</p>
        <p>This is your starting point. Log in to access your personalized dashboard and explore the tools available to you based on your role.</p>
    {% endif %}
</div>
