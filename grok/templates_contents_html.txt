+ [templates]
+----admin.html
+----auth.inc
+----base.inc
+----change_password.inc
+----community.html
+----login.html
+----merchant.html
+----my_account.inc
+----overlay.inc
+----partner.html
+----signup.html
+----siterequest.inc

admin.html
{% extends "base.inc" %}
{% block content %}
<div class="main-container">
    <div class="menu-container">
        <div class="menu">
            <button data-section="deal_listings">
                <span class="button-content"><i class="fas fa-tags"></i> Deal Listings</span>
            </button>
            <button data-submenu="affiliatePrograms" data-section="affiliateProgramsIntro">
                <span class="button-content"><i class="fas fa-handshake"></i> Affiliate Programs</span>
                <i class="fas fa-caret-right caret"></i>
            </button>
            <div id="affiliatePrograms" class="submenu">
                <button data-section="amazon_uk">
                    <span class="button-content">
                        <span class="icon-amazon-uk menu-size"></span> Amazon UK
                    </span>
                </button>
                <button data-section="ebay_uk">
                    <span class="button-content">
                        <span class="icon-ebay-uk menu-size"></span> eBay UK
                    </span>
                </button>
                <button data-section="awin">
                    <span class="button-content"><i class="fas fa-network-wired"></i> Awin</span>
                </button>
                <button data-section="cj">
                    <span class="button-content"><i class="fas fa-link"></i> CJ</span>
                </button>
                <button data-section="textmagic">
                    <span class="button-content"><i class="fas fa-sms"></i> TextMagic</span>
                </button>
                <button data-section="tiny">
                    <span class="button-content"><i class="fas fa-pen"></i> tiny</span>
                </button>
            </div>
            <button data-submenu="userManagement" data-section="userManagementIntro">
                <span class="button-content"><i class="fas fa-users"></i> User Management</span>
                <i class="fas fa-caret-right caret"></i>
            </button>
            <div id="userManagement" class="submenu">
                <button data-section="partners">
                    <span class="button-content">
                        <span class="menu-size icon-partner"></span> Partners
                    </span>
                </button>
                <button data-section="communities">
                    <span class="button-content">
                        <span class="menu-size icon-community"></span> Communities
                    </span>
                </button>
                <button data-section="merchants">
                    <span class="button-content">
                        <span class="menu-size icon-merchant"></span> Merchants
                    </span>
                </button>
            </div>
            <button data-submenu="testScripts" data-section="testScriptsIntro">
                <span class="button-content"><i class="fas fa-flask"></i> Test Scripts</span>
                <i class="fas fa-caret-right caret"></i>
            </button>
            <div id="testScripts" class="submenu">
                <button data-href="/partner">
                    <span class="button-content">
                        <span class="icon-group">
                            <span class="menu-size icon-partner"></span>
                            <i class="fas fa-flask small-icon"></i>
                        </span> Partner
                    </span>
                </button>
                <button data-href="/community">
                    <span class="button-content">
                        <span class="icon-group">
                            <span class="menu-size icon-community"></span>
                            <i class="fas fa-flask small-icon"></i>
                        </span> Community
                    </span>
                </button>
                <button data-href="/merchant">
                    <span class="button-content">
                        <span class="icon-group">
                            <span class="menu-size icon-merchant"></span>
                            <i class="fas fa-flask small-icon"></i>
                        </span> Merchant
                    </span>
                </button>
                <button data-submenu="referralTests" data-section="referralTestsIntro">
                    <span class="button-content"><i class="fas fa-link"></i> Referral Tests</span>
                    <i class="fas fa-caret-right caret"></i>
                </button>
                <div id="referralTests" class="submenu">
                    <button data-section="page_visit_test">
                        <span class="button-content"><i class="fas fa-eye"></i> Page Visit Referral Test</span>
                    </button>
                    <button data-section="order_test">
                        <span class="button-content"><i class="fas fa-shopping-cart"></i> Order Referral Test</span>
                    </button>
                </div>
            </div>
            <button data-submenu="myAccountSubmenu" data-section="myAccountIntro">
                <span class="button-content"><i class="fas fa-user"></i> My Account</span>
                <i class="fas fa-caret-right caret"></i>
            </button>
            <div id="myAccountSubmenu" class="submenu">
                <button data-section="contactDetails">
                    <span class="button-content"><i class="fas fa-address-book"></i> Contact Details</span>
                </button>
                <button data-section="changePassword">
                    <span class="button-content"><i class="fas fa-key"></i> Change Password</span>
                </button>
            </div>
            <button id="logOffBtn" style="background-color: #dc3545;">
                <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
            </button>
        </div>
    </div>
    <div class="content-wrapper">
        <div id="welcome" class="section">
            <h2>Welcome to Admin Dashboard</h2>
            <p>This is the main administration tool for managing your affiliate programs and deal listings.</p>
            <p>Use the menu on the left to:</p>
            <ul>
                <li>View and filter discounted deals in "Deal Listings"</li>
                <li>Manage affiliate credentials under "Affiliate Programs"</li>
                <li>Manage users under "User Management"</li>
                <li>Test referral tracking with "Test Scripts"</li>
                <li>Update your account details in "My Account"</li>
            </ul>
        </div>

        <div id="deal_listings" class="section">
            <h2>Discounted Deal Listings</h2>
            <p>This section displays all currently active deal listings available across your affiliate programs.</p>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1; max-width: 300px;">
                    <h3>Categories</h3>
                    <div class="treeview" id="categoryTree"></div>
                </div>
                <div style="flex: 2;">
                    <table class="deals-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Title</th>
                                <th>URL</th>
                                <th>Price</th>
                                <th>Original</th>
                                <th>Discount %</th>
                                <th>Image</th>
                                <th>QTY</th>
                            </tr>
                        </thead>
                        <tbody id="dealList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="affiliateProgramsIntro" class="section">
            <h2>Affiliate Programs</h2>
            <p>Use this section to manage your affiliate program credentials.</p>
            <p>Select an affiliate program from the menu to enter or update your API keys, access tokens, or other necessary credentials.</p>
        </div>

        <div id="amazon_uk" class="section">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <span class="icon-amazon-uk" style="width: 32px; height: 32px; margin-right: 10px;"></span>
                <h2>Amazon UK Credentials</h2>
            </div>
            <div class="form" style="margin: 0; max-width: 400px;">
                <label for="amazonAccessKey">Access Key:</label>
                <input type="text" id="amazonAccessKey" placeholder="Enter Access Key">
                <label for="amazonSecretKey">Secret Key:</label>
                <input type="text" id="amazonSecretKey" placeholder="Enter Secret Key">
                <label for="amazonAssociateTag">Associate Tag:</label>
                <input type="text" id="amazonAssociateTag" placeholder="Enter Associate Tag">
                <label for="amazonCountry">Country:</label>
                <input type="text" id="amazonCountry" placeholder="Enter Country (e.g., UK)">
                <button data-affiliate="amazon_uk">Update Credentials</button>
            </div>
            <div class="signup-instructions">
                <strong>Sign Up:</strong> Visit <a href="https://affiliate-program.amazon.com/" target="_blank">Amazon Associates</a>.
            </div>
        </div>

        <div id="ebay_uk" class="section">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <span class="icon-ebay-uk" style="width: 32px; height: 32px; margin-right: 10px;"></span>
                <h2>eBay UK Credentials</h2>
            </div>
            <div class="form" style="margin: 0; max-width: 400px;">
                <label for="ebayAppId">App ID:</label>
                <input type="text" id="ebayAppId" placeholder="Enter App ID">
                <button data-affiliate="ebay_uk">Update Credentials</button>
            </div>
            <div class="signup-instructions">
                <strong>Sign Up:</strong> Go to <a href="https://partnernetwork.ebay.com/" target="_blank">eBay Partner Network</a>.
            </div>
        </div>

        <div id="awin" class="section">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <i class="fas fa-network-wired" style="font-size: 32px; margin-right: 10px; color: white;"></i>
                <h2>Awin Credentials</h2>
            </div>
            <div class="form" style="margin: 0; max-width: 400px;">
                <label for="awinApiToken">API Token:</label>
                <input type="text" id="awinApiToken" placeholder="Enter API Token">
                <button data-affiliate="awin">Update Credentials</button>
            </div>
            <div class="signup-instructions">
                <strong>Sign Up:</strong> Visit <a href="https://www.awin.com/" target="_blank">Awin</a>.
            </div>
        </div>

        <div id="cj" class="section">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <i class="fas fa-link" style="font-size: 32px; margin-right: 10px; color: white;"></i>
                <h2>CJ Credentials</h2>
            </div>
            <div class="form" style="margin: 0; max-width: 400px;">
                <label for="cjApiKey">API Key:</label>
                <input type="text" id="cjApiKey" placeholder="Enter API Key">
                <label for="cjWebsiteId">Website ID:</label>
                <input type="text" id="cjWebsiteId" placeholder="Enter Website ID">
                <button data-affiliate="cj">Update Credentials</button>
            </div>
            <div class="signup-instructions">
                <strong>Sign Up:</strong> Go to <a href="https://www.cj.com/" target="_blank">CJ Affiliate</a>.
            </div>
        </div>

        <div id="textmagic" class="section">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <i class="fas fa-sms" style="font-size: 32px; margin-right: 10px; color: white;"></i>
                <h2>TextMagic Credentials</h2>
            </div>
            <div class="form" style="margin: 0; max-width: 400px;">
                <label for="textmagicUsername">Username:</label>
                <input type="text" id="textmagicUsername" placeholder="Enter Username">
                <label for="textmagicApiKey">API Key:</label>
                <input type="text" id="textmagicApiKey" placeholder="Enter API Key">
                <button data-affiliate="textmagic">Update Credentials</button>
            </div>
            <div class="signup-instructions">
                <strong>Sign Up:</strong> Visit <a href="https://www.textmagic.com/" target="_blank">TextMagic</a>.
            </div>
        </div>

        <div id="tiny" class="section">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <i class="fas fa-pen" style="font-size: 32px; margin-right: 10px; color: white;"></i>
                <h2>tiny Credentials</h2>
            </div>
            <div class="form" style="margin: 0; max-width: 400px;">
                <label for="tinyApiKey">API Key:</label>
                <input type="text" id="tinyApiKey" placeholder="Enter API Key">
                <button data-affiliate="tiny">Update Credentials</button>
            </div>
            <div class="signup-instructions">
                <strong>Sign Up:</strong> Visit <a href="https://www.tiny.cloud/" target="_blank">tiny</a>.
            </div>
        </div>

        <div id="userManagementIntro" class="section">
            <h2>User Management</h2>
            <p>This section allows you to manage different types of users in your system.</p>
            <p>Select a user type from the menu to view their details or modify their permissions:</p>
            <ul>
                <li><strong>Partners:</strong> Manage users with Partner permissions.</li>
                <li><strong>Communities:</strong> Manage community users.</li>
                <li><strong>Merchants:</strong> Manage merchant users.</li>
            </ul>
        </div>

        <div id="merchants" class="section">
            <h2>Merchant Management</h2>
            <table>
                <thead>
                    <tr>
                        <th>USERid</th>
                        <th>Contact Name</th>
                        <th>Email</th>
                        <th>Phone Number</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="merchantsList">
                    <!-- Dynamically populated by updateUserTable -->
                </tbody>
            </table>
        </div>

        <div id="communities" class="section">
            <h2>Communities Management</h2>
            <table>
                <thead>
                    <tr>
                        <th>USERid</th>
                        <th>Contact Name</th>
                        <th>Email</th>
                        <th>Phone Number</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="communitiesList">
                    <!-- Dynamically populated by updateUserTable -->
                </tbody>
            </table>
        </div>

        <div id="partners" class="section">
            <h2>Partner Management</h2>
            <table>
                <thead>
                    <tr>
                        <th>USERid</th>
                        <th>Contact Name</th>
                        <th>Email</th>
                        <th>Phone Number</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="partnersList">
                    <!-- Dynamically populated by updateUserTable -->
                </tbody>
            </table>
        </div>

        <div id="testScriptsIntro" class="section">
            <h2>Test Scripts</h2>
            <p>Use this section to test referral tracking and other scripts.</p>
            <p>Select an option from the menu to visit endpoints or run referral tests under "Referral Tests."</p>
        </div>

        <div id="referralTestsIntro" class="section">
            <h2>Referral Tests</h2>
            <p>This section contains tools to test referral tracking functionality.</p>
            <p>Choose "Page Visit Referral Test" or "Order Referral Test" to submit test data and verify tracking behavior.</p>
        </div>

        <div id="page_visit_test" class="section">
            <h2>Page Visit Referral Test</h2>
            <div class="form">
                <form id="pageVisitForm">
                    <table>
                        <tr><td><label for="pageReferer">Referer:</label></td><td><select id="pageReferer" name="referer"></select></td></tr>
                        <tr><td><label for="page">Page:</label></td><td><input type="text" id="page" name="page" value="/home"></td></tr>
                        <tr><td><label for="pageTimestamp">Timestamp:</label></td><td><input type="text" id="pageTimestamp" name="timestamp"></td></tr>
                        <tr><td colspan="2"><button type="submit">Submit Page Visit</button></td></tr>
                    </table>
                </form>
            </div>
        </div>

        <div id="order_test" class="section">
            <h2>Order Referral Test</h2>
            <div class="form">
                <form id="orderForm">
                    <table>
                        <tr><td><label for="orderReferer">Referer:</label></td><td><select id="orderReferer" name="referer"></select></td></tr>
                        <tr><td><label for="orderId">Order ID:</label></td><td><input type="text" id="orderId" name="orderId" value="ORD12345"></td></tr>
                        <tr><td><label for="buyer">Buyer Name:</label></td><td><input type="text" id="buyer" name="buyer" value="John Doe"></td></tr>
                        <tr><td><label for="total">Total Amount (£):</label></td><td><input type="number" id="total" name="total" value="99.99" step="0.01"></td></tr>
                        <tr><td><label for="orderTimestamp">Timestamp:</label></td><td><input type="text" id="orderTimestamp" name="timestamp"></td></tr>
                        <tr><td colspan="2"><button type="submit">Submit Order</button></td></tr>
                    </table>
                </form>
            </div>
        </div>

        <div id="myAccountIntro" class="section">
            <h2>My Account</h2>
            <p>Welcome to your account settings. Here, you can manage your personal information and update your password for security.</p>
            <p>Use the options below to navigate to the desired section:</p>
        </div>

        {% include 'my_account.inc' %}
                
        <div id="changePassword" class="section" style="display: none;">
            {% include 'change_password.inc' %}
        </div>
    
    </div>
</div>
{% endblock %}


auth.inc
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title | default('clubmadeira.io') }}</title>
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Local CSS -->
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='black' d='M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160zM201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'/></svg>" type="image/svg+xml">
    <!-- Dynamic API URL -->
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <!-- Load jQuery and Toastr before inline script -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- Load common.js early -->
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
</head>
<body>
    {% block content %}{% endblock %}
    <script src="{{ url_for('static', filename='js/site-auth.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/site-navigation.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/category-management.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/site-request.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/admin-page.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/page-load.js') }}" defer></script>
</body>
</html>
base.inc
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title | default('clubmadeira.io') }}</title>
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Local CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/icons.css') }}">
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='white' d='M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160zM201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'/></svg>" type="image/svg+xml">
    <!-- Dynamic API URL -->
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <!-- External JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" defer></script>
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" defer></script>
    <!-- Load common.js early for Toastr setup -->
    <script src="{{ url_for('static', filename='js/common.js') }}" defer></script>
</head>
<body>
    <div class="layout-wrapper">
        <div class="header">
            <div class="header-content" id="brandingContent">
                <!-- Branding content will be loaded here -->
            </div>
        </div>        
        
        {% block content %}{% endblock %}
        
    </div>

    <!-- Local JS -->
    <script src="{{ url_for('static', filename='js/site-auth.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/site-navigation.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/category-management.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/site-request.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/admin-page.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/page-load.js') }}" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const layoutWrapper = document.querySelector('.layout-wrapper');
            layoutWrapper.style.display = 'none'; // Hide initially

            function waitForInitialize(pageType, attempts = 100, delay = 1000) {
                if (typeof window.initialize === 'function') {
                    console.log(`Initialize function found, calling initialize("${pageType}")`);
                    window.initialize(pageType);
                    layoutWrapper.style.display = 'block'; // Show after initialization
                } else if (attempts > 0) {
                    console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                    setTimeout(() => waitForInitialize(pageType, attempts - 1, delay), delay);
                } else {
                    console.error('Initialize function not found after maximum retries');
                    layoutWrapper.style.display = 'block'; // Show anyway to avoid blank page
                }
            }

            // Pass page type from Flask
            waitForInitialize('{{ page_type | default("default") }}');
        });
    </script>
</body>
</html>
change_password.inc
<div class="settings-form">
    <div class="password-container">
        <label for="currentPassword">Current Password:</label>
        <input type="password" id="currentPassword" name="currentPassword" placeholder="Enter current password">
        <i class="fas fa-eye password-toggle" {% if user_type == "partner" %}data-field="currentPassword Ascending"{% else %}data-target="currentPassword"{% endif %}></i>
    </div>
    <div class="password-container">
        <label for="newPassword">New Password:</label>
        <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password">
        <i class="fas fa-eye password-toggle" {% if user_type == "partner" %}data-field="newPassword"{% else %}data-target="newPassword"{% endif %}></i>
    </div>
    <div class="password-container">
        <label for="confirmPassword">Confirm New Password:</label>
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password">
        <i class="fas fa-eye password-toggle" {% if user_type == "partner" %}data-field="confirmPassword"{% else %}data-target="confirmPassword"{% endif %}></i>
    </div>
    <button data-action="savePassword"><i class="fas fa-key"></i> Change Password</button>
</div>
community.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Community</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/icons.css">
    <script src="https://cdn.tiny.cloud/1/ml1wlwr128qsm8hn8d86e5mhs3y2fuvjr9ztknrsh23x6krp/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- Favicon: Font Awesome "group-arrows-rotate" SVG (Unicode f366) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path d='M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160zM201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'/></svg>" type="image/svg+xml">
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" defer></script>
</head>
<body>
    {% include 'overlay.inc' %}  <!-- Loading overlay added -->
    <div class="layout-wrapper">
        <div class="header">
            <div class="header-content" id="brandingContent"></div>
        </div>
        <div class="main-container">
            <div class="menu-container">
                <div class="menu">
                    <button data-submenu="my_website_submenu" data-section="my_website_intro_section">
                        <span class="button-content"><i class="fas fa-globe"></i> My Web Site</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="my_website_submenu" class="submenu">
                        <button data-section="wix">
                            <span class="button-content"><span class="icon-wix menu-size"></span> Wix</span>
                        </button>
                        <button data-section="wordpress">
                            <span class="button-content"><span class="icon-wordpress menu-size"></span> WordPress</span>
                        </button>
                        <button data-section="squarespace">
                            <span class="button-content"><span class="icon-squarespace menu-size"></span> Squarespace</span>
                        </button>
                        <button data-section="weebly">
                            <span class="button-content"><span class="icon-weebly menu-size"></span> Weebly</span>
                        </button>
                        <button data-section="joomla">
                            <span class="button-content"><span class="icon-joomla menu-size"></span> Joomla</span>
                        </button>
                        <button data-section="no_website">
                            <span class="button-content"><i class="fas fa-question-circle menu-size"></i> I Don’t Have a Website Yet</span>
                        </button>
                    </div>
                    <button data-section="categories">
                        <span class="button-content"><i class="fas fa-list"></i> My Categories</span>
                    </button>
                    <button data-submenu="referrals_submenu" data-section="referrals_intro_section">
                        <span class="button-content">
                            <span class="icon-community menu-size"></span> My Referrals
                        </span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="referrals_submenu" class="submenu">
                        <button data-section="visits">
                            <span class="button-content"><i class="fas fa-eye"></i> Visits</span>
                        </button>
                        <button data-section="orders">
                            <span class="button-content"><i class="fas fa-shopping-cart"></i> Orders</span>
                        </button>
                    </div>
                    <button data-submenu="my_account_submenu" data-section="my_account_intro_section">
                        <span class="button-content"><i class="fas fa-cog"></i> My Account</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="my_account_submenu" class="submenu">
                        <button data-section="contact_details">
                            <span class="button-content"><i class="fas fa-address-book"></i> Contact</span>
                        </button>
                        <button data-section="change_password">
                            <span class="button-content"><i class="fas fa-key"></i> Change Password</span>
                        </button>
                    </div>
                    <button data-href="/admin" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-arrow-left"></i> Back to Admin</span>
                    </button>
                    <button id="logOffBtn" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
                    </button>
                </div>
            </div>
            <div class="content-wrapper">
                <div id="welcome" class="section">
                    <h2>Welcome to Your Community Dashboard</h2>
                    <p id="welcome-message">Hello, <span id="user-contact-name">[User]</span>! This dashboard is your hub for managing your community account and tracking referrals.</p>
                    <p>As a valued member, connect with other community groups to share resources and grow together.</p>
                    <p>Use the menu on the left to:</p>
                    <ul>
                        <li>Learn how to add discounts to your website or request a site under "My Web Site"</li>
                        <li>Select product categories for your site in "My Categories"</li>
                        <li>View referral statistics under "My Referrals"</li>
                        <li>Update your account details in "My Account"</li>
                    </ul>
                </div>
                {% with user_type='community' %}
                    {% include 'my_account.inc' %}
                {% endwith %}
                {% with user_type='community' %}
                    <div id="change_password" class="section" style="display: none;">
                        {% include 'change_password.inc' %}
                    </div>
                {% endwith %}
                <div id="categories" class="section">
                    <h2>My Categories</h2>
                    <p>This section lets you choose which product categories will appear on your website's "Community Discounts" page.</p>
                    <div class="treeview" id="categoryTree"></div>
                </div>
                <div id="referrals_intro_section" class="section">
                    <h2>My Referrals</h2>
                    <p>This section allows you to track your referral activity.</p>
                    <p>Select from the submenu options:</p>
                    <ul>
                        <li><strong>Visits:</strong> View pages visited through your referral links.</li>
                        <li><strong>Orders:</strong> See orders placed via your referrals.</li>
                    </ul>
                </div>
                <div id="visits" class="section">
                    <h2>Visits</h2>
                    <div class="toggle-section" data-toggle="visits_this_month"><i class="fas fa-calendar-day"></i> This Month</div>
                    <div id="visits_this_month" class="toggle-content open">
                        <table id="visitsTableThisMonth">
                            <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                            <tbody id="visitsListThisMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="visits_last_month"><i class="fas fa-calendar-alt"></i> Last Month</div>
                    <div id="visits_last_month" class="toggle-content">
                        <table id="visitsTableLastMonth">
                            <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                            <tbody id="visitsListLastMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="visits_earlier"><i class="fas fa-history"></i> Earlier</div>
                    <div id="visits_earlier" class="toggle-content">
                        <table id="visitsTableEarlier">
                            <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                            <tbody id="visitsListEarlier"></tbody>
                        </table>
                    </div>
                </div>
                <div id="orders" class="section">
                    <h2>Orders</h2>
                    <div class="toggle-section" data-toggle="orders_this_month"><i class="fas fa-calendar-day"></i> This Month</div>
                    <div id="orders_this_month" class="toggle-content open">
                        <table id="ordersTableThisMonth">
                            <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                            <tbody id="ordersListThisMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="orders_last_month"><i class="fas fa-calendar-alt"></i> Last Month</div>
                    <div id="orders_last_month" class="toggle-content">
                        <table id="ordersTableLastMonth">
                            <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                            <tbody id="ordersListLastMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="orders_earlier"><i class="fas fa-history"></i> Earlier</div>
                    <div id="orders_earlier" class="toggle-content">
                        <table id="ordersTableEarlier">
                            <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                            <tbody id="ordersListEarlier"></tbody>
                        </table>
                    </div>
                </div>
                <div id="my_website_intro_section" class="section">
                    <h2>My Web Site</h2>
                    <p>Welcome to the "My Web Site" section! Here, you can learn how to integrate discounts into your community website.</p>
                    <ul>
                        <li><strong>Wix:</strong> Easy drag-and-drop builder.</li>
                        <li><strong>WordPress:</strong> Flexible CMS.</li>
                        <li><strong>Squarespace:</strong> Stylish solution.</li>
                        <li><strong>Weebly:</strong> Simple builder.</li>
                        <li><strong>Joomla:</strong> Robust CMS.</li>
                        <li><strong>I Don’t Have a Website Yet:</strong> Request a site setup.</li>
                    </ul>
                </div>
                <div id="wix" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-wix section-icon"></span>
                        <h2>Wix Integration</h2>
                    </div>
                    <p>Add discounts to your Wix site:</p>
                    <ol>
                        <li>Log in to Wix and open the Editor.</li>
                        <li>Click "+" > "Embed" > "Embed a Widget".</li>
                        <li>Paste: <code id="wixCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Publish.</li>
                    </ol>
                </div>
                <div id="wordpress" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-wordpress section-icon"></span>
                        <h2>WordPress Integration</h2>
                    </div>
                    <p>Add discounts to WordPress:</p>
                    <ol>
                        <li>Log in to WordPress admin.</li>
                        <li>Go to "Pages" > "Add New".</li>
                        <li>Add "Custom HTML" block: <code id="wordpressCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Publish.</li>
                    </ol>
                </div>
                <div id="squarespace" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-squarespace section-icon"></span>
                        <h2>Squarespace Integration</h2>
                    </div>
                    <p>Integrate discounts into Squarespace:</p>
                    <ol>
                        <li>Log in to Squarespace editor.</li>
                        <li>Add a new page.</li>
                        <li>Add "Code" block: <code id="squarespaceCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Update site.</li>
                    </ol>
                </div>
                <div id="weebly" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-weebly section-icon"></span>
                        <h2>Weebly Integration</h2>
                    </div>
                    <p>Add discounts to Weebly:</p>
                    <ol>
                        <li>Log in to Weebly editor.</li>
                        <li>Drag "Embed Code" onto page.</li>
                        <li>Paste: <code id="weeblyCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Publish.</li>
                    </ol>
                </div>
                <div id="joomla" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-joomla section-icon"></span>
                        <h2>Joomla Integration</h2>
                    </div>
                    <p>Integrate discounts into Joomla:</p>
                    <ol>
                        <li>Log in to Joomla admin.</li>
                        <li>Go to "Content" > "Articles" > "Add New".</li>
                        <li>Paste in "Code" view: <code id="joomlaCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Save.</li>
                    </ol>
                </div>
                <div id="no_website" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-question-circle section-icon"></i>
                        <h2>I Don’t Have a Website Yet</h2>
                    </div>
                    <p>Request a custom Wix website for your community from our Wix Professionals. Fill out the form below to specify your needs:</p>
                    {% with user_type='community' %}
                        {% include 'siterequest.inc' %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in the correct order with defer where appropriate -->
    <script src="/static/js/site-auth.js" defer></script>
    <script src="/static/js/site-navigation.js" defer></script>
    <script src="/static/js/category-management.js" defer></script>
    <script src="/static/js/site-request.js" defer></script>
    <script src="/static/js/community-page.js" defer></script>
    <script src="/static/js/page-load.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            tinymce.init({
                selector: '#aboutCommunity, #stylingDetails, #page1Content',
                inline: true,
                menubar: false,
                toolbar: 'bold italic | bullist numlist | link',
                plugins: 'lists link',
                setup: (editor) => {
                    editor.on('init', () => {
                        console.log('TinyMCE initialized for:', editor.id);
                    });
                }
            });
        });

        function waitForInitialize(attempts = 50, delay = 1000) {
            if (typeof window.initialize === 'function') {
                console.log('Initialize function found, calling initialize("community")');
                window.initialize('community');
            } else if (attempts > 0) {
                console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                setTimeout(() => waitForInitialize(attempts - 1, delay), delay);
            } else {
                console.error('Initialize function not found after maximum retries');
            }
        }
        waitForInitialize();
    </script>
</body>
</html>
login.html
{% extends "auth.inc" %}
{% block content %}
<!-- Deployed 2025-03-29 v6 -->
<div class="login-page">
    <div id="loadingOverlay" class="hidden">
        <div class="multicircle-loader">
            <div class="circle circle1"></div>
            <div class="circle circle2"></div>
            <div class="circle circle3"></div>
            <div class="circle circle4"></div>
        </div>
    </div>

    <div class="container" id="loginContainer" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
        <h2>Login</h2>
        <div class="custom-login-notice">
            <span class="highlight">Please log in</span> to access your account. If you don’t have an account, click "Sign Up" below.
        </div>
        <form id="loginForm" class="form">
            <div class="form-group">
                <label for="loginEmail">Email:</label>
                <div class="input-container">
                    <input type="email" id="loginEmail" name="email" placeholder="Enter your email" required>
                </div>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password:</label>
                <div class="input-container">
                    <input type="password" id="loginPassword" name="password" placeholder="Enter your password" required>
                    <span class="toggle-password"><i class="fas fa-eye"></i></span>
                </div>
            </div>
            <button type="submit">Login</button>
        </form>
        <div class="toggle-link">
            <a href="{{ url_for('authentication_bp.signup') }}">Need an account? Sign Up</a><br>
            <a onclick="showForgotPassword()">Forgot Password?</a>
        </div>
    </div>

    <div class="container hidden" id="forgotPasswordContainer">
        <h2>Forgot Password</h2>
        <form id="forgotPasswordForm" class="form">
            <div class="form-group">
                <label for="forgotEmail">Email:</label>
                <input type="email" id="forgotEmail" name="email" placeholder="Enter your email" required>
            </div>
            <button type="submit">Send OTP via SMS</button>
        </form>
        <div class="toggle-link">
            <a onclick="showLogin()">Back to Login</a>
        </div>
    </div>

    <div class="container hidden" id="verifyOtpContainer">
        <h2>Verify OTP</h2>
        <form id="verifyOtpForm" class="form">
            <div class="form-group">
                <label for="verifyEmail">Email:</label>
                <input type="email" id="verifyEmail" name="email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="otpCode">One-Time Password:</label>
                <input type="text" id="otpCode" name="code" placeholder="Enter the OTP from SMS" required>
            </div>
            <div class="form-group">
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" name="new_password" placeholder="Enter new password" required>
            </div>
            <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password:</label>
                <input type="password" id="confirmNewPassword" name="confirm_new_password" placeholder="Confirm new password" required>
            </div>
            <button type="submit">Update Password</button>
        </form>
        <div class="toggle-link">
            <a onclick="showLogin()">Back to Login</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Login script loaded - Version: Using plain fetch for /login - Timestamp:', new Date().toISOString());

        // Check for site-navigation.js after DOM load
        if (!window.siteNavigation || !window.siteNavigation.fetchProtectedPage) {
            console.error('site-navigation.js not loaded properly after DOMContentLoaded');
            return; // Avoid throwing an error to allow partial functionality
        }

        function showLoadingOverlay() {
            let overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('hidden');
                console.log('showLoadingOverlay - Overlay set to visible');
            } else {
                console.error('showLoadingOverlay - Overlay not found');
            }
        }

        function hideLoadingOverlay() {
            let overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
                console.log('hideLoadingOverlay - Overlay hidden');
            } else {
                console.error('hideLoadingOverlay - Overlay not found');
            }
        }

        function showLogin() {
            const loginContainer = document.getElementById('loginContainer');
            const forgotContainer = document.getElementById('forgotPasswordContainer');
            const verifyContainer = document.getElementById('verifyOtpContainer');
            const loginPage = document.querySelector('.login-page');
            
            if (loginContainer) {
                loginContainer.classList.remove('hidden');
                loginContainer.style.display = 'block';
                loginContainer.style.visibility = 'visible';
                loginContainer.style.opacity = '1';
                console.log('showLogin - Login container set to visible');
            } else {
                console.error('showLogin - Login container not found');
            }
            
            if (loginPage) {
                loginPage.style.display = 'block';
                loginPage.style.visibility = 'visible';
                loginPage.style.opacity = '1';
                console.log('showLogin - Login page set to visible');
            } else {
                console.error('showLogin - Login page not found');
            }
            
            if (forgotContainer) forgotContainer.classList.add('hidden');
            if (verifyContainer) verifyContainer.classList.add('hidden');
            hideLoadingOverlay();
        }

        function showForgotPassword() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('forgotPasswordContainer').classList.remove('hidden');
            document.getElementById('verifyOtpContainer').classList.add('hidden');
            hideLoadingOverlay();
        }

        function showVerifyOtp(email) {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('forgotPasswordContainer').classList.add('hidden');
            document.getElementById('verifyOtpContainer').classList.remove('hidden');
            document.getElementById('verifyEmail').value = email;
            hideLoadingOverlay();
        }

        console.log('DOMContentLoaded - Initializing login page');
        try {
            showLogin();
            console.log('DOMContentLoaded - showLogin executed successfully');

            document.querySelectorAll('.toggle-password').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const input = this.parentElement.querySelector('input');
                    const icon = this.querySelector('i');
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });

            function redirectBasedOnPermissions() {
                const token = localStorage.getItem('authToken');
                if (!token) return false;

                let decoded;
                try { 
                    decoded = decodeJWT(token); 
                    console.log('redirectBasedOnPermissions - Token decoded:', decoded);
                } catch (e) {
                    toastr.error('Invalid token format. Please log in again.');
                    localStorage.removeItem('authToken');
                    return false;
                }

                const permissions = decoded.permissions;
                let redirectPath;
                if (permissions.includes('admin')) redirectPath = '/admin';
                else if (permissions.includes('wixpro')) redirectPath = '/partner';
                else if (permissions.includes('merchant')) redirectPath = '/merchant';
                else if (permissions.includes('community')) redirectPath = '/community';
                else redirectPath = '/';

                if (window.location.pathname !== redirectPath) {
                    console.log('redirectBasedOnPermissions - Redirecting to:', redirectPath);
                    window.siteNavigation.fetchProtectedPage(redirectPath);
                    return true;
                }
                console.log('redirectBasedOnPermissions - No redirect needed');
                return false;
            }

            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                // Remove existing listeners to prevent overrides
                const newForm = loginForm.cloneNode(true);
                loginForm.parentNode.replaceChild(newForm, loginForm);
                document.getElementById('loginForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;

                    showLoadingOverlay();
                    console.log('Attaching loginForm event listener - Using plain fetch - Timestamp:', new Date().toISOString());
                    try {
                        console.log('Submitting login request with plain fetch');
                        const response = await fetch(`${window.apiUrl}/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });
                        if (!response) throw new Error('No response from server');
                        if (!response.ok) throw new Error((await response.json()).message || `Login failed with status ${response.status}`);

                        const data = await response.json();
                        if (data.status !== 'success') throw new Error(data.message || 'Login failed');

                        localStorage.setItem('authToken', data.token);
                        if (data.userId) localStorage.setItem('userId', data.userId);

                        const decoded = decodeJWT(data.token);
                        const permissions = decoded.permissions || [];
                        const needsVerification = (permissions.includes('merchant') || permissions.includes('community')) && !permissions.includes('verified');

                        if (needsVerification) {
                            console.log('Needs OTP verification');
                            const otpResponse = await fetch(`${window.apiUrl}/reset-password`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email })
                            });
                            const otpData = await otpResponse.json();
                            if (!otpResponse.ok) throw new Error(otpData.message || 'Failed to send OTP');

                            toastr.success('OTP sent to your phone. Please enter it below.');
                            const loginContainer = document.getElementById('loginContainer');
                            loginContainer.innerHTML = `
                                <h2>Verify OTP</h2>
                                <form id="loginOtpForm" class="form">
                                    <div class="form-group">
                                        <label for="loginOtp">One-Time Password:</label>
                                        <input type="text" id="loginOtp" name="otp" placeholder="Enter OTP" required>
                                    </div>
                                    <button type="submit">Verify OTP</button>
                                </form>
                            `;
                            hideLoadingOverlay();

                            document.getElementById('loginOtpForm').addEventListener('submit', async (e) => {
                                e.preventDefault();
                                const otp = document.getElementById('loginOtp').value.trim();
                                if (!otp) {
                                    toastr.error('Please enter the OTP.');
                                    return;
                                }

                                showLoadingOverlay();
                                const verifyResponse = await window.siteNavigation.authenticatedFetch(`${window.apiUrl}/verify-reset-code`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ email, code: otp, new_password: password })
                                });
                                const verifyData = await verifyResponse.json();
                                if (!verifyResponse.ok) throw new Error(verifyData.message || 'OTP verification failed');

                                localStorage.setItem('authToken', verifyData.token);
                                toastr.success('Verification successful! Redirecting...');
                                redirectBasedOnPermissions();
                            });
                        } else {
                            console.log('Login successful, redirecting based on permissions');
                            redirectBasedOnPermissions();
                        }
                    } catch (error) {
                        toastr.error(error.message || 'Unable to connect to server.');
                        hideLoadingOverlay();
                    }
                });
            } else {
                console.error('loginForm element not found');
            }

            document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('forgotEmail').value.trim();

                showLoadingOverlay();
                try {
                    const response = await fetch(`${window.apiUrl}/reset-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Reset request failed');

                    toastr.success('A one-time password has been sent to your phone.');
                    showVerifyOtp(email);
                } catch (error) {
                    toastr.error(error.message || 'Error sending OTP');
                    hideLoadingOverlay();
                }
            });

            document.getElementById('verifyOtpForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('verifyEmail').value.trim();
                const code = document.getElementById('otpCode').value.trim();
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;

                const passwordRegex = /^(?=.*\d).{8,}$/;
                if (!passwordRegex.test(newPassword)) {
                    toastr.error('New password must be at least 8 characters long and include numbers');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    toastr.error('New password and confirmation do not match');
                    return;
                }

                showLoadingOverlay();
                try {
                    const response = await window.siteNavigation.authenticatedFetch(`${window.apiUrl}/verify-reset-code`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, code, new_password: newPassword })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Verification failed');

                    toastr.success('Password updated successfully!');
                    showLogin();
                } catch (error) {
                    toastr.error(error.message || 'Error verifying OTP');
                    hideLoadingOverlay();
                }
            });

            setTimeout(() => {
                const loginContainer = document.getElementById('loginContainer');
                const loginPage = document.querySelector('.login-page');
                if (loginContainer && window.getComputedStyle(loginContainer).display === 'none') {
                    console.error('DOMContentLoaded - Login container still hidden after showLogin');
                    loginContainer.style.display = 'block';
                    loginContainer.style.visibility = 'visible';
                    loginContainer.style.opacity = '1';
                }
                if (loginPage && window.getComputedStyle(loginPage).display === 'none') {
                    console.error('DOMContentLoaded - Login page still hidden');
                    loginPage.style.display = 'block';
                    loginPage.style.visibility = 'visible';
                    loginPage.style.opacity = '1';
                }
            }, 100);
        } catch (e) {
            console.error('DOMContentLoaded - Error in initialization:', e.message);
        }
    });
</script>
{% endblock %}
merchant.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Merchant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.tiny.cloud/1/ml1wlwr128qsm8hn8d86e5mhs3y2fuvjr9ztknrsh23x6krp/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- Favicon: Font Awesome "group-arrows-rotate" SVG (Unicode f366) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path d='M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160zM201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'/></svg>" type="image/svg+xml">
    <!-- Define window.apiUrl before loading scripts -->
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" defer></script>
</head>
<body>
    {% include 'overlay.inc' %}  <!-- Loading overlay added -->
    <div class="layout-wrapper">
        <div class="header" style="margin-bottom: 0; padding-bottom: 0;">
            <div class="header-content" id="brandingContent">
                <!-- Branding content will be loaded here -->
            </div>
        </div>
        <div class="main-container" style="margin-top: 0; padding-top: 0;">
            <div class="menu-container">
                <div class="menu">
                    <button data-section="my-products">
                        <span class="button-content"><i class="fas fa-box-open"></i> My Products</span>
                    </button>
                    <button data-section="my-store">
                        <span class="button-content"><i class="fas fa-store"></i> My Store</span>
                    </button>
                    <button data-submenu="my-account-submenu" data-section="my-account">
                        <span class="button-content"><i class="fas fa-cog"></i> My Account</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="my-account-submenu" class="submenu">
                        <button data-section="contact-details">
                            <span class="button-content"><i class="fas fa-address-book"></i> Contact</span>
                        </button>
                        <button data-section="change-password">
                            <span class="button-content"><i class="fas fa-key"></i> Change Password</span>
                        </button>
                    </div>
                    <button data-href="/admin" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-arrow-left"></i> Back to Admin</span>
                    </button>
                    <button id="logOffBtn" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
                    </button>
                </div>
            </div>
            <div class="content-wrapper" style="margin-top: 0;">
                <div id="info" class="section">
                    <h2>Merchant Info</h2>
                    <p id="welcome-message">Hello, <span id="user-contact-name">[User]</span>! This dashboard is designed for merchants to manage integrations with clubmadeira.io.</p>
                    <p>Use the menu to manage products, your store, Wix integration, and account settings.</p>
                </div>
                <div id="my-account" class="section">
                    <h2>My Account</h2>
                    <p>Welcome to your account settings. Here, you can manage your personal information and update your password for security. Use the options below to navigate to the desired section:</p>
                </div>
                {% with user_type='merchant' %}
                    {% include 'my_account.inc' %}
                {% endwith %}
                {% with user_type='merchant' %}
                    <div id="change-password" class="section" style="display: none;">
                        {% include 'change_password.inc' %}
                    </div>
                {% endwith %}
                <div id="my-products" class="section">
                    <h2>My Products</h2>
                    <p>These are the products from your parts feed.</p>
                    <table id="productTable">
                        <thead>
                            <tr><th class="hidden">ID</th><th>Category</th><th>Title</th><th>URL</th><th>Price</th><th>Original</th><th>Image</th><th>QTY</th></tr>
                        </thead>
                        <tbody id="productList"></tbody>
                    </table>
                </div>
                <div id="my-store" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-store" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>My Store</h2>
                    </div>
                    <p>Request a custom Wix store to sell your products online. Provide details below to set up your store (minimum: Home and Returns Policy pages).</p>
                    {% with user_type='merchant' %}
                        {% include 'siterequest.inc' %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in the correct order with defer where appropriate -->
    <script src="/static/js/site-auth.js" defer></script>
    <script src="/static/js/site-navigation.js" defer></script>
    <script src="/static/js/site-request.js" defer></script>
    <script src="/static/js/user-management.js" defer></script>
    <script src="/static/js/merchant-page.js" defer></script>
    <script src="/static/js/page-load.js" defer></script>
    <script>
        // Initialize TinyMCE with minimal configuration for specific textareas
        document.addEventListener('DOMContentLoaded', () => {
            tinymce.init({
                selector: '#aboutStore, #stylingDetails, #page1Content, #page2Content',
                inline: true,
                menubar: false,
                toolbar: 'bold italic | bullist numlist | link',
                plugins: 'lists link',
                setup: (editor) => {
                    editor.on('init', () => {
                        console.log('TinyMCE initialized for:', editor.id);
                    });
                }
            });
        });

        // Wait for the initialize function to become available
        function waitForInitialize(attempts = 50, delay = 1000) {
            if (typeof window.initialize === 'function') {
                console.log('Initialize function found, calling initialize("merchant")');
                window.initialize('merchant');
            } else if (attempts > 0) {
                console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                setTimeout(() => waitForInitialize(attempts - 1, delay), delay);
            } else {
                console.error('Initialize function not found after maximum retries');
            }
        }
        // Call waitForInitialize after all scripts are loaded
        waitForInitialize();
    </script>
</body>
</html>
my_account.inc
<div id="contact-details" class="section" style="display: none;">
    <h2>Contact Details</h2>
    <div class="settings-form">
        <label><strong>User ID:</strong></label>
        <input type="text" id="userId" readonly>
        <label for="contactName">Contact Name:</label>
        <input type="text" id="contactName" placeholder="Enter contact name">
        <label for="websiteUrl">Website URL:</label>
        <input type="url" id="websiteUrl" placeholder="Enter website URL">
        <label for="emailAddress">Email Address:</label>
        <input type="email" id="emailAddress" placeholder="Enter email address">
        <label><strong>Phone Number:</strong></label>
        <span>{{ user.phone_number | default('N/A') }}</span>
        <button data-action="saveSettings"><i class="fas fa-save"></i> Save Settings</button>
    </div>
</div>
overlay.inc
<div id="loadingOverlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 1); justify-content: center; align-items: center; z-index: 9999;">
    <div style="position: relative; width: 200px; height: 200px;">
        <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 120px; height: 120px; border-top-color: #ff6f61; top: 40px; left: 40px; animation-delay: 0s;"></div>
        <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 90px; height: 90px; border-top-color: #6bff61; top: 55px; left: 55px; animation-delay: 0.3s;"></div>
        <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 60px; height: 60px; border-top-color: #61cfff; top: 70px; left: 70px; animation-delay: 0.6s;"></div>
        <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 30px; height: 30px; border-top-color: #ff61ff; top: 85px; left: 85px; animation-delay: 0.9s;"></div>
    </div>
</div>
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
partner.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Partner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <!-- Favicon: Font Awesome "group-arrows-rotate" SVG (Unicode f366) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path d='M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160zM201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'/></svg>" type="image/svg+xml">
    <!-- Define window.apiUrl before loading scripts -->
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" defer></script>
</head>
<body>
    {% include 'overlay.inc' %}  <!-- Loading overlay added -->
    <div class="layout-wrapper">
        <div class="header">
            <div class="header-content" id="brandingContent">
                <!-- Branding content will be loaded here -->
            </div>
        </div>
        <div class="main-container">
            <div class="menu-container">
                <div class="menu">
                    <button data-section="welcome">
                        <span class="button-content"><i class="fas fa-home"></i> Dashboard</span>
                    </button>
                    <button data-submenu="my-account-submenu" data-section="my-account">
                        <span class="button-content"><i class="fas fa-cog"></i> My Account</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="my-account-submenu" class="submenu">
                        <button data-section="my-account">
                            <span class="button-content"><i class="fas fa-address-book"></i> Contact</span>
                        </button>
                        <button data-section="change-password">
                            <span class="button-content"><i class="fas fa-key"></i> Change Password</span>
                        </button>
                    </div>
                    <button data-section="my-products">
                        <span class="button-content"><i class="fas fa-box-open"></i> My Products</span>
                    </button>
                    <button data-section="site-requests">
                        <span class="button-content"><i class="fas fa-file-alt"></i> Site Requests</span>
                    </button>
                    <button data-section="documentation">
                        <span class="button-content"><i class="fas fa-book"></i> Documentation</span>
                    </button>
                    <button data-href="/admin">
                        <span class="button-content"><i class="fas fa-arrow-left"></i> Back to Admin</span>
                    </button>
                    <button id="logOffBtn" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
                    </button>
                </div>
            </div>
            <div class="content-wrapper">
                <div id="welcome" class="section active">
                    <h2>Welcome to Your Partner Dashboard</h2>
                    <p>This dashboard is designed for partners to manage merchant integrations with clubmadeira.io. Use the "My Account" section to update your contact details or change your password for security. If you have admin privileges, you can return to the admin panel using the "Back to Admin" button.</p>
                </div>
                <div id="my-account" class="section">
                    <h2>My Account</h2>
                    <p>Welcome to your account settings. Here, you can manage your personal information and update your password for security. Use the options below to navigate to the desired section:</p>
                </div>
                {% with user_type='partner' %}
                    {% include 'my_account.inc' %}
                {% endwith %}
                {% with user_type='partner' %}
                    <div id="change-password" class="section" style="display: none;">
                        {% include 'change_password.inc' %}
                    </div>
                {% endwith %}
                <div id="my-products" class="section">
                    <h2>My Products</h2>
                    <p>These are the products from your parts feed.</p>
                    <table id="productTable">
                        <thead>
                            <tr><th class="hidden">ID</th><th>Category</th><th>Title</th><th>URL</th><th>Price</th><th>Original</th><th>Image</th><th>QTY</th></tr>
                        </thead>
                        <tbody id="productList"></tbody>
                    </table>
                </div>
                <div id="site-requests" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-file-alt" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Site Requests</h2>
                    </div>
                    <p>View and manage site requests from merchants and communities. Click a row to see details.</p>
                    <table id="siteRequestsTable">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Received At</th>
                                <th>Contact Name</th>
                                <th>Email</th>
                                <th>Organisation</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="siteRequestsList"></tbody>
                    </table>
                    <div id="apiKeyModal" class="modal" style="display: none;">
                        <div class="modal-content">
                            <span class="close" data-action="closeApiKeyModal"><i class="fas fa-times"></i></span>
                            <h3><i class="fas fa-key"></i> Enter API Key</h3>
                            <label for="merchantWixClientId">Wix Client ID:</label>
                            <input type="text" id="merchantWixClientId" placeholder="Enter Wix Client ID">
                            <button data-action="saveMerchantWixClientId"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
                <div id="site-request-detail" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-info-circle" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Site Request Details</h2>
                    </div>
                    <div class="settings-form">
                        <button data-section="site-requests"><i class="fas fa-arrow-left"></i> Back to Site Requests</button>
                        <div id="siteRequestContent"></div>
                    </div>
                </div>
                <div id="documentation" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-book" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Documentation</h2>
                    </div>
                    <div id="documentation-content">
                        <p>This section provides documentation for integrating with clubmadeira.io. Select a specific topic from the submenu.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in the correct order with defer where appropriate -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js" defer></script>
    <script src="/static/js/site-auth.js" defer></script>
    <script src="/static/js/site-navigation.js" defer></script>
    <script src="/static/js/site-request.js" defer></script>
    <script src="/static/js/user-management.js" defer></script>
    <script src="/static/js/partner-page.js" defer></script>
    <script src="/static/js/page-load.js" defer></script>
    <script>
        // Wait for the initialize function to become available
        function waitForInitialize(attempts = 50, delay = 1000) {
            if (typeof window.initialize === 'function') {
                console.log('Initialize function found, calling initialize("partner")');
                window.initialize('partner');
            } else if (attempts > 0) {
                console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                setTimeout(() => waitForInitialize(attempts - 1, delay), delay);
            } else {
                console.error('Initialize function not found after maximum retries');
            }
        }
        // Call waitForInitialize after all scripts are loaded
        waitForInitialize();
    </script>
</body>
</html>
signup.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/signup.css"> <!-- Link to combined styles with pulse -->
    <!-- Favicon: Font Awesome "group-arrows-rotate" SVG (Unicode f366) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path d='M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160zM201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'/></svg>" type="image/svg+xml">
</head>
<body>
    <div class="signup-container">
        <h1>Sign Up - I am a...</h1>
        <form id="signupForm" autocomplete="off">
            <!-- Dummy fields to trick autofill -->
            <input type="text" class="hidden" autocomplete="off">
            <input type="text" class="hidden" autocomplete="off">
            <div class="options">
                <label class="option">
                    <input type="radio" name="signup_type" value="community" checked>
                    <img src="{{ url_for('static', filename='img/community.jpg') }}" alt="Scout leader in uniform, neck down">
                    <span>Community Group</span>
                </label>
                <label class="option">
                    <input type="radio" name="signup_type" value="seller">
                    <img src="{{ url_for('static', filename='img/merchant.jpg') }}" alt="White man in business suit, neck down">
                    <span>Merchant</span>
                </label>
                <label class="option">
                    <input type="radio" name="signup_type" value="wixpro">
                    <img src="{{ url_for('static', filename='img/wixpro.jpg') }}" alt="Female ethnic web designer in casual dress, neck down">
                    <span>Partner</span>
                </label>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="contact_name">Contact Name:</label>
                    <div class="input-container">
                        <input type="text" id="contact_name" name="contact_name" required autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-phone">Phone Number:</label>
                    <div class="input-container">
                        <input type="tel" id="signup-phone" name="signup_phone" autocomplete="off" pattern="[0-9]{10}" title="Please enter a 10-digit phone number">
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email:</label>
                    <div class="input-container">
                        <input type="text" id="signup-email" name="signup_email" required autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password:</label>
                    <div class="input-container">
                        <input type="text" id="signup-password" name="signup_password" required autocomplete="new-password">
                        <i class="fas fa-eye toggle-password" data-target="signup-password"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-confirm-password">Confirm Password:</label>
                    <div class="input-container">
                        <input type="password" id="signup-confirm-password" name="signup_confirm_password" required autocomplete="new-password">
                        <i class="fas fa-eye toggle-password" data-target="signup-confirm-password"></i>
                    </div>
                </div>
                <button type="submit">Sign Me Up</button>
            </div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // Set correct input types and clear fields after load
        window.onload = function() {
            const emailInput = document.getElementById('signup-email');
            const passwordInput = document.getElementById('signup-password');
            const confirmPasswordInput = document.getElementById('signup-confirm-password');
            const phoneInput = document.getElementById('signup-phone');

            // Set proper types
            emailInput.type = 'email';
            passwordInput.type = 'password';

            // Double-clear strategy
            setTimeout(function() {
                emailInput.value = '';
                passwordInput.value = '';
                confirmPasswordInput.value = '';
                phoneInput.value = '';
            }, 100);

            setTimeout(function() {
                emailInput.value = '';
                passwordInput.value = '';
                confirmPasswordInput.value = '';
                phoneInput.value = '';
            }, 500); // Extra delay for Chrome

            // Set "Community Group" as selected by default
            const communityOption = document.querySelector('input[value="community"]').closest('.option');
            communityOption.classList.add('selected');
        };

        // Clear fields on focus
        document.getElementById('signup-email').addEventListener('focus', function() {
            this.value = '';
        });
        document.getElementById('signup-password').addEventListener('focus', function() {
            this.value = '';
        });
        document.getElementById('signup-confirm-password').addEventListener('focus', function() {
            this.value = '';
        });
        document.getElementById('signup-phone').addEventListener('focus', function() {
            this.value = '';
        });

        // Highlight selected option
        document.querySelectorAll('input[name="signup_type"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.option').forEach(function(option) {
                    option.classList.remove('selected');
                });
                if (this.checked) {
                    this.closest('.option').classList.add('selected');
                }
            });
        });

        // Dynamically set 'required' attribute for phone number based on signup type
        document.querySelectorAll('input[name="signup_type"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                const phoneInput = document.getElementById('signup-phone');
                if (this.value === 'wixpro') {
                    phoneInput.removeAttribute('required');
                } else {
                    phoneInput.setAttribute('required', '');
                }
            });

            // Set initial phone requirement based on default selection
            const phoneInput = document.getElementById('signup-phone');
            if (radio.value === 'community' && radio.checked) {
                phoneInput.setAttribute('required', '');
            }
        });

        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(function(icon) {
            icon.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if (input.type === 'password') {
                    input.type = 'text';
                    this.classList.remove('fa-eye');
                    this.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    this.classList.remove('fa-eye-slash');
                    this.classList.add('fa-eye');
                }
            });
        });

        // Form submission with OTP workflow
        $('#signupForm').on('submit', async function(e) {
            e.preventDefault();

            const signupType = $('input[name="signup_type"]:checked').val();
            if (!signupType) {
                toastr.error('Please select a signup type.');
                return;
            }

            const contactName = $('#contact_name').val().trim();
            const phone = $('#signup-phone').val().trim();
            const email = $('#signup-email').val().trim();
            const password = $('#signup-password').val().trim();
            const confirmPassword = $('#signup-confirm-password').val().trim();

            // Validation: Check all required fields, password match, and phone validity
            if (!contactName || !email || !password || !confirmPassword) {
                toastr.error('All fields except phone (for Partner) must be filled.');
                return;
            }

            if (password !== confirmPassword) {
                toastr.error('Passwords do not match.');
                return;
            }

            const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
            if (!passwordRegex.test(password)) {
                toastr.error('Password must be 8+ characters with letters and numbers.');
                return;
            }

            if (signupType !== 'wixpro') {
                if (!phone) {
                    toastr.error('Phone number is required for Community Group and Merchant.');
                    return;
                }
                const phoneRegex = /^\d{10}$/;
                if (!phoneRegex.test(phone)) {
                    toastr.error('Enter a valid 10-digit phone number (e.g., 1234567890).');
                    return;
                }
            }

            const signupData = { 
                signup_type: signupType, 
                contact_name: contactName, 
                signup_phone: phone || null, 
                signup_email: email, 
                signup_password: password 
            };

            try {
                // Step 1: Create user with /signup
                const signupResponse = await fetch('/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(signupData)
                });
                const signupDataResp = await signupResponse.json();
                if (!signupResponse.ok) throw new Error(signupDataResp.message || 'Signup failed');

                if (signupType === 'wixpro') {
                    // Partner: Direct to login
                    toastr.success('Signup successful! Redirecting to login...');
                    setTimeout(() => window.location.href = '/login', 2000);
                } else {
                    // Merchant/Community: Send OTP with /reset-password
                    const otpResponse = await fetch('/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const otpData = await otpResponse.json();
                    if (!otpResponse.ok) throw new Error(otpData.message || 'Failed to send OTP');

                    toastr.success('OTP sent to your phone. Please enter it below.');
                    const otpContainer = document.createElement('div');
                    otpContainer.innerHTML = `
                        <div class="form-group">
                            <label for="signupOtp">Enter OTP:</label>
                            <input type="text" id="signupOtp" name="otp" placeholder="Enter OTP" required>
                        </div>
                        <button id="verifyOtpBtn">Verify OTP</button>
                    `;
                    this.appendChild(otpContainer);
                    this.querySelector('.form-section').style.display = 'none';

                    document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
                        const otp = document.getElementById('signupOtp').value.trim();
                        if (!otp) {
                            toastr.error('Please enter the OTP.');
                            return;
                        }

                        // Step 2: Verify OTP with /verify-reset-code
                        const verifyResponse = await fetch('/verify-reset-code', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, code: otp, new_password: password })
                        });
                        const verifyData = await verifyResponse.json();
                        if (!verifyResponse.ok) throw new Error(verifyData.message || 'OTP verification failed');

                        // Step 3: Redirect to group page based on signup_type
                        toastr.success('Signup verified! Redirecting to your page...');
                        const redirectPath = signupType === 'seller' ? '/merchant' : '/community';
                        setTimeout(() => window.location.href = redirectPath, 2000);
                    });
                }
            } catch (error) {
                toastr.error(error.message || 'Error during signup/OTP process');
            }
        });

        // Toastr options
        toastr.options = {
            closeButton: true,
            progressBar: true,
            positionClass: 'toast-top-right',
            timeOut: 5000
        };
    </script>
</body>
</html>
siterequest.inc
<form id="siteRequestForm" class="settings-form">
    <input type="hidden" id="userType" value="{{ user_type }}">

    <label for="name">{{ 'Community Name' if user_type == 'community' else 'Store Name' }}:</label>
    <input type="text" id="name" name="name" placeholder="Enter your {{ 'community' if user_type == 'community' else 'store' }} name" required>

    <label for="about">{{ 'About Our Community' if user_type == 'community' else 'About Your Store' }}:</label>
    <textarea id="about" name="about" placeholder="Tell us about your {{ 'community' if user_type == 'community' else 'store' }}"></textarea>

    <label for="logos">{{ 'Community Logos' if user_type == 'community' else 'Store Logos' }}:</label>
    <input type="file" id="logos" name="logos" accept="image/*" multiple>
    <small>Upload up to 5 logos (e.g., main logo, secondary logos).</small>

    <label for="colorPrefs">Color Preferences:</label>
    <input type="text" id="colorPrefs" name="colorPrefs" placeholder="e.g., #FF5733, Blue">

    <label for="stylingDetails">Styling Details:</label>
    <textarea id="stylingDetails" name="stylingDetails" rows="4" placeholder="e.g., modern layout, bold fonts"></textarea>

    <label for="preferredDomain">Preferred Domain Name:</label>
    <input type="text" id="preferredDomain" name="preferredDomain" placeholder="e.g., my{{ 'community.org' if user_type == 'community' else 'store.uk' }}" oninput="updateEmailDomains()">
    <button type="button" data-action="checkDomainAvailability"><i class="fas fa-search"></i> Check Availability</button>

    <label>Email Addresses to Set Up (up to 5):</label>
    <div id="emailsContainer">
        <div class="email-section" data-email="1">
            <label for="email1Name">Email Name:</label>
            <input type="text" id="email1Name" name="email1Name" placeholder="e.g., info">
            <span id="email1Domain">@my{{ 'community.org' if user_type == 'community' else 'store.uk' }}</span>
        </div>
    </div>
    <button type="button" data-action="addEmail"><i class="fas fa-plus"></i> Add Another Email</button>

    <label>{{ 'Requested Pages (up to 5)' if user_type == 'community' else 'Required Pages' }}:</label>
    <div id="pagesContainer">
        {% if user_type == 'merchant' %}
            <!-- Fixed Home page -->
            <div class="page-section" data-page="1">
                <label for="page1Name">Page Name:</label>
                <input type="text" id="page1Name" name="page1Name" value="Home" readonly>
                <br><br>
                <label for="page1Content">Home Page Content:</label>
                <textarea id="page1Content" name="page1Content" placeholder="Describe your home page (e.g., welcome message, featured products)"></textarea>
                <label for="page1Images">Additional Images:</label>
                <input type="file" id="page1Images" name="page1Images" accept="image/*" multiple>
            </div>
            <!-- Fixed Returns Policy page -->
            <div class="page-section" data-page="2">
                <label for="page2Name">Page Name:</label>
                <input type="text" id="page2Name" name="page2Name" value="Returns Policy" readonly>
                <br><br>
                <label for="page2Content">Returns Policy Content:</label>
                <textarea id="page2Content" name="page2Content" placeholder="Outline your returns policy"></textarea>
                <label for="page2Images">Additional Images:</label>
                <input type="file" id="page2Images" name="page2Images" accept="image/*" multiple>
            </div>
        {% else %}
            <!-- Community starts with one customizable page -->
            <div class="page-section" data-page="1">
                <label for="page1Name">Page Name:</label>
                <input type="text" id="page1Name" name="page1Name" value="Home">
                <br><br>
                <label for="page1Content">Page Content:</label>
                <textarea id="page1Content" name="page1Content" placeholder="Describe this page"></textarea>
                <label for="page1Images">Additional Images:</label>
                <input type="file" id="page1Images" name="page1Images" accept="image/*" multiple>
            </div>
        {% endif %}
    </div>
    <button type="button" data-action="addPage"><i class="fas fa-plus"></i> Add Another Page</button>

    <label>{{ 'Wix Widgets' if user_type == 'community' else 'Wix Store Widgets' }}:</label>
    <div class="widget-checkboxes">
        {% if user_type == 'community' %}
            <div><label><input type="checkbox" name="widgets" value="events"> Events</label> - Add an events calendar.</div>
            <div><label><input type="checkbox" name="widgets" value="socialMediaFeeds"> Social Media Feeds</label> - Display live social media feeds.</div>
            <div><label><input type="checkbox" name="widgets" value="gallery"> Gallery</label> - Showcase photos.</div>
            <div><label><input type="checkbox" name="widgets" value="contactForm"> Contact Form</label> - Simple contact form.</div>
            <div><label><input type="checkbox" name="widgets" value="blog"> Blog</label> - Share updates and stories.</div>
            <div><label><input type="checkbox" name="widgets" value="weather"> Weather</label> - Show real-time weather.</div>
            <div><label><input type="checkbox" name="widgets" value="socialMediaLinks"> Social Media Links</label> - Quick links to profiles.</div>
        {% else %}
            <div><label><input type="checkbox" name="widgets" value="productCatalog"> Product Catalog</label> - Display your products.</div>
            <div><label><input type="checkbox" name="widgets" value="checkout"> Checkout</label> - Enable direct purchases.</div>
            <div><label><input type="checkbox" name="widgets" value="cart"> Shopping Cart</label> - Add a cart for customers.</div>
            <div><label><input type="checkbox" name="widgets" value="promotions"> Promotions</label> - Highlight sales and discounts.</div>
            <div><label><input type="checkbox" name="widgets" value="contactForm"> Contact Form</label> - Customer inquiries.</div>
        {% endif %}
    </div>

    <button type="button" data-action="saveSiteRequest"><i class="fas fa-paper-plane"></i> Submit Request</button>
</form>
