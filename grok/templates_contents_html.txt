+ [templates]
+----admin.html
+----community.html
+----login.html
+----merchant.html
+----my_account.html
+----partner.html
+----signup.html

admin.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <!-- Define window.apiUrl before loading scripts -->
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: flex;">
        <div class="multicircle-loader">
            <div class="circle circle1"></div>
            <div class="circle circle2"></div>
            <div class="circle circle3"></div>
            <div class="circle circle4"></div>
        </div>
    </div>

    <div class="layout-wrapper" style="display: none;">
        <div class="header">
            <div class="header-content" id="brandingContent" style="display: block;">
                <!-- Branding content will be loaded here -->
            </div>
        </div>
        <div class="main-container">
            <div class="menu-container">
                <div class="menu">
                    <button data-section="deal_listings">
                        <span class="button-content"><i class="fas fa-tags"></i> Deal Listings</span>
                    </button>
                    <button data-submenu="affiliatePrograms" data-section="affiliateProgramsIntro">
                        <span class="button-content"><i class="fas fa-handshake"></i> Affiliate Programs</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="affiliatePrograms" class="submenu">
                        <button data-section="amazon_uk">
                            <span class="button-content">
                                <span class="svg-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M257.2 162.7c-48.7 1.8-169.5 15.5-169.5 117.5 0 109.5 138.3 114 183.5 43.2 6.5 10.2 35.4 37.5 45.3 46.8l56.8-56S341 288.9 341 261.4V114.3C341 89 316.5 32 228.7 32 140.7 32 94 87 94 136.3l73.5 6.8c16.3-49.5 54.2-49.5 54.2-49.5 40.7-.1 35.5 29.8 35.5 69.1zm0 86.8c0 80-84.2 68-84.2 17.2 0-47.2 50.5-56.7 84.2-57.8v40.6zm136 163.5c-7.7 10-70 67-174.5 67S34.2 408.5 9.7 379c-6.8-7.7 1-11.3 5.5-8.3C88.5 415.2 203 488.5 387.7 401c7.5-3.7 13.3 2 5.5 12zm39.8 2.2c-6.5 15.8-16 26.8-21.2 31-5.5 4.5-9.5 2.7-6.5-3.8s19.3-46.5 12.7-55c-6.5-8.3-37-4.3-48-3.2-10.8 1-13 2-14-.3-2.3-5.7 21.7-15.5 37.5-17.5 15.7-1.8 41-.8 46 5.7 3.7 5.1 0 27.1-6.5 43.1z"/></svg>
                                </span> Amazon UK
                            </span>
                        </button>
                        <button data-section="ebay_uk">
                            <span class="button-content">
                                <span class="svg-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M606 189.5l-54.8 109.9-54.9-109.9h-37.5l10.9 20.6c-11.5-19-35.9-26-63.3-26-31.8 0-67.9 8.7-71.5 43.1h33.7c1.4-13.8 15.7-21.8 35-21.8 26 0 41 9.6 41 33v3.4c-12.7 0-28 .1-41.7 .4-42.4 .9-69.6 10-76.7 34.4 1-5.2 1.5-10.6 1.5-16.2 0-52.1-39.7-76.2-75.4-76.2-21.3 0-43 5.5-58.7 24.2v-80.6h-32.1v169.5c0 10.3-.6 22.9-1.1 33.1h31.5c.7-6.3 1.1-12.9 1.1-19.5 13.6 16.6 35.4 24.9 58.7 24.9 36.9 0 64.9-21.9 73.3-54.2-.5 2.8-.7 5.8-.7 9 0 24.1 21.1 45 60.6 45 26.6 0 45.8-5.7 61.9-25.5 0 6.6 .3 13.3 1.1 20.2h29.8c-.7-8.2-1-17.5-1-26.8v-65.6c0-9.3-1.7-17.2-4.8-23.8l61.5 116.1-28.5 54.1h35.9L640 189.5zM243.7 313.8c-29.6 0-50.2-21.5-50.2-53.8 0-32.4 20.6-53.8 50.2-53.8 29.8 0 50.2 21.4 50.2 53.8 0 32.3-20.4 53.8-50.2 53.8zm200.9-47.3c0 30-17.9 48.4-51.6 48.4-25.1 0-35-13.4-35-25.8 0-19.1 18.1-24.4 47.2-25.3 13.1-.5 27.6-.6 39.4-.6zm-411.9 1.6h128.8v-8.5c0-51.7-33.1-75.4-78.4-75.4-56.8 0-83 30.8-83 77.6 0 42.5 25.3 74 82.5 74 31.4 0 68-11.7 74.4-46.1h-33.1c-12 35.8-87.7 36.7-91.2-21.6zm95-21.4H33.3c6.9-56.6 92.1-54.7 94.4 0z"/></svg>
                                </span> eBay UK
                            </span>
                        </button>
                        <button data-section="awin">
                            <span class="button-content"><i class="fas fa-network-wired"></i> Awin</span>
                        </button>
                        <button data-section="cj">
                            <span class="button-content"><i class="fas fa-link"></i> CJ</span>
                        </button>
                        <button data-section="textmagic">
                            <span class="button-content"><i class="fas fa-sms"></i> TextMagic</span>
                        </button>
                        <button data-section="tiny">
                            <span class="button-content"><i class="fas fa-pen"></i> tiny</span>
                        </button>
                    </div>
                    <button data-submenu="userManagement" data-section="userManagementIntro">
                        <span class="button-content"><i class="fas fa-users"></i> User Management</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="userManagement" class="submenu">
                        <button data-section="partners">
                            <span class="button-content">
                                <span class="svg-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">
                                        <path d="M512 256c0 .9 0 1.8 0 2.7c-.4 36.5-33.6 61.3-70.1 61.3L344 320c-26.5 0-48 21.5-48 48c0 3.4 .4 6.7 1 9.9c2.1 10.2 6.5 20 10.8 29.9c6.1 13.8 12.1 27.5 12.1 42c0 31.8-21.6 60.7-53.4 62c-3.5 .1-7 .2-10.6 .2C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm0-96a32 32 0 1 0 0-64 32 32 0 1 0 0 64zM288 96a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm96 96a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/>
                                    </svg>
                                </span> Partners
                            </span>
                        </button>
                        <button data-section="communities">
                            <span class="button-content">
                                <span class="svg-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" preserveAspectRatio="xMidYMid meet">
                                        <path d="M72 88a56 56 0 1 1 112 0A56 56 0 1 1 72 88zM64 245.7C54 256.9 48 271.8 48 288s6 31.1 16 42.3l0-84.7zm144.4-49.3C178.7 222.7 160 261.2 160 304c0 34.3 12 65.8 32 90.5l0 21.5c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32l0-26.8C26.2 371.2 0 332.7 0 288c0-61.9 50.1-112 112-112l32 0c24 0 46.2 7.5 64.4 20.3zM448 416l0-21.5c20-24.7 32-56.2 32-90.5c0-42.8-18.7-81.3-48.4-107.7C449.8 183.5 472 176 496 176l32 0c61.9 0 112 50.1 112 112c0 44.7-26.2 83.2-64 101.2l0 26.8c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32zm8-328a56 56 0 1 1 112 0A56 56 0 1 1 456 88zM576 245.7l0 84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM320 32a64 64 0 1 1 0 128 64 64 0 1 1 0-128zM240 304c0 16.2 6 31 16 42.3l0-84.7c-10 11.3-16 26.1-16 42.3zm144-42.3l0 84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM448 304c0 44.7-26.2 83.2-64 101.2l0 42.8c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32l0-42.8c-37.8-18-64-56.5-64-101.2c0-61.9 50.1-112 112-112l32 0c61.9 0 112 50.1 112 112z"/>
                                    </svg>
                                </span> Communities
                            </span>
                        </button>
                        <button data-section="merchants">
                            <span class="button-content">
                                <span class="svg-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" preserveAspectRatio="xMidYMid meet">
                                        <path d="M96 128a128 128 0 1 0 256 0A128 128 0 1 0 96 128zm94.5 200.2l18.6 31L175.8 483.1l-36-146.9c-2-8.1-9.8-13.4-17.9-11.3C51.9 342.4 0 405.8 0 481.3c0 17 13.8 30.7 30.7 30.7l131.7 0c0 0 0 0 .1 0l5.5 0 112 0 5.5 0c0 0 0 0 .1 0l131.7 0c17 0 30.7-13.8 30.7-30.7c0-75.5-51.9-138.9-121.9-156.4c-8.1-2-15.9 3.3-17.9 11.3l-36 146.9L238.9 359.2l18.6-31c6.4-10.7-1.3-24.2-13.7-24.2L224 304l-19.7 0c-12.4 0-20.1 13.6-13.7 24.2z"/>
                                    </svg>
                                </span> Merchants
                            </span>
                        </button>
                    </div>
                    <button data-submenu="testScripts" data-section="testScriptsIntro">
                        <span class="button-content"><i class="fas fa-flask"></i> Test Scripts</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="testScripts" class="submenu">
                        <button data-href="/partner">
                            <span class="button-content">
                                <span class="icon-group">
                                    <span class="svg-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">
                                            <path d="M512 256c0 .9 0 1.8 0 2.7c-.4 36.5-33.6 61.3-70.1 61.3L344 320c-26.5 0-48 21.5-48 48c0 3.4 .4 6.7 1 9.9c2.1 10.2 6.5 20 10.8 29.9c6.1 13.8 12.1 27.5 12.1 42c0 31.8-21.6 60.7-53.4 62c-3.5 .1-7 .2-10.6 .2C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm0-96a32 32 0 1 0 0-64 32 32 0 1 0 0 64zM288 96a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm96 96a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/>
                                        </svg>
                                    </span>
                                    <i class="fas fa-flask small-icon"></i>
                                </span> Partner
                            </span>
                        </button>
                        <button data-href="/community">
                            <span class="button-content">
                                <span class="icon-group">
                                    <span class="svg-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" preserveAspectRatio="xMidYMid meet">
                                            <path d="M72 88a56 56 0 1 1 112 0A56 56 0 1 1 72 88zM64 245.7C54 256.9 48 271.8 48 288s6 31.1 16 42.3l0-84.7zm144.4-49.3C178.7 222.7 160 261.2 160 304c0 34.3 12 65.8 32 90.5l0 21.5c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32l0-26.8C26.2 371.2 0 332.7 0 288c0-61.9 50.1-112 112-112l32 0c24 0 46.2 7.5 64.4 20.3zM448 416l0-21.5c20-24.7 32-56.2 32-90.5c0-42.8-18.7-81.3-48.4-107.7C449.8 183.5 472 176 496 176l32 0c61.9 0 112 50.1 112 112c0 44.7-26.2 83.2-64 101.2l0 26.8c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32zm8-328a56 56 0 1 1 112 0A56 56 0 1 1 456 88zM576 245.7l0 84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM320 32a64 64 0 1 1 0 128 64 64 0 1 1 0-128zM240 304c0 16.2 6 31 16 42.3l0-84.7c-10 11.3-16 26.1-16 42.3zm144-42.3l0 84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM448 304c0 44.7-26.2 83.2-64 101.2l0 42.8c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32l0-42.8c-37.8-18-64-56.5-64-101.2c0-61.9 50.1-112 112-112l32 0c61.9 0 112 50.1 112 112z"/>
                                        </svg>
                                    </span>
                                    <i class="fas fa-flask small-icon"></i>
                                </span> Community
                            </span>
                        </button>
                        <button data-href="/merchant">
                            <span class="button-content">
                                <span class="icon-group">
                                    <span class="svg-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" preserveAspectRatio="xMidYMid meet">
                                            <path d="M96 128a128 128 0 1 0 256 0A128 128 0 1 0 96 128zm94.5 200.2l18.6 31L175.8 483.1l-36-146.9c-2-8.1-9.8-13.4-17.9-11.3C51.9 342.4 0 405.8 0 481.3c0 17 13.8 30.7 30.7 30.7l131.7 0c0 0 0 0 .1 0l5.5 0 112 0 5.5 0c0 0 0 0 .1 0l131.7 0c17 0 30.7-13.8 30.7-30.7c0-75.5-51.9-138.9-121.9-156.4c-8.1-2-15.9 3.3-17.9 11.3l-36 146.9L238.9 359.2l18.6-31c6.4-10.7-1.3-24.2-13.7-24.2L224 304l-19.7 0c-12.4 0-20.1 13.6-13.7 24.2z"/>
                                        </svg>
                                    </span>
                                    <i class="fas fa-flask small-icon"></i>
                                </span> Merchant
                            </span>
                        </button>
                        <button data-submenu="referralTests" data-section="referralTestsIntro">
                            <span class="button-content"><i class="fas fa-link"></i> Referral Tests</span>
                            <i class="fas fa-caret-right caret"></i>
                        </button>
                        <div id="referralTests" class="submenu">
                            <button data-section="page_visit_test">
                                <span class="button-content"><i class="fas fa-eye"></i> Page Visit Referral Test</span>
                            </button>
                            <button data-section="order_test">
                                <span class="button-content"><i class="fas fa-shopping-cart"></i> Order Referral Test</span>
                            </button>
                        </div>
                    </div>
                    <button data-submenu="myAccountSubmenu" data-section="myAccountIntro">
                        <span class="button-content"><i class="fas fa-user"></i> My Account</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="myAccountSubmenu" class="submenu">
                        <button data-section="contactDetails">
                            <span class="button-content"><i class="fas fa-address-book"></i> Contact Details</span>
                        </button>
                        <button data-section="changePassword">
                            <span class="button-content"><i class="fas fa-key"></i> Change Password</span>
                        </button>
                    </div>
                    <button id="logOffBtn" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
                    </button>
                </div>
            </div>
            <div class="content-wrapper">
                <div id="welcome" class="section">
                    <h2>Welcome to Admin Dashboard</h2>
                    <p>This is the main administration tool for managing your affiliate programs and deal listings.</p>
                    <p>Use the menu on the left to:</p>
                    <ul>
                        <li>View and filter discounted deals in "Deal Listings"</li>
                        <li>Manage affiliate credentials under "Affiliate Programs"</li>
                        <li>Manage users under "User Management"</li>
                        <li>Test referral tracking with "Test Scripts"</li>
                        <li>Update your account details in "My Account"</li>
                    </ul>
                </div>

                <div id="deal_listings" class="section">
                    <h2>Discounted Deal Listings</h2>
                    <p>This section displays all currently active deal listings available across your affiliate programs.</p>
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 1; max-width: 300px;">
                            <h3>Categories</h3>
                            <div class="treeview" id="categoryTree"></div>
                        </div>
                        <div style="flex: 2;">
                            <table class="deals-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Title</th>
                                        <th>URL</th>
                                        <th>Price</th>
                                        <th>Original</th>
                                        <th>Discount %</th>
                                        <th>Image</th>
                                        <th>QTY</th>
                                    </tr>
                                </thead>
                                <tbody id="dealList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="affiliateProgramsIntro" class="section">
                    <h2>Affiliate Programs</h2>
                    <p>Use this section to manage your affiliate program credentials.</p>
                    <p>Select an affiliate program from the menu to enter or update your API keys, access tokens, or other necessary credentials.</p>
                </div>

                <div id="amazon_uk" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="32" height="32" style="fill: currentColor; margin-right: 10px;">
                            <path d="M257.2 162.7c-48.7 1.8-169.5 15.5-169.5 117.5 0 109.5 138.3 114 183.5 43.2 6.5 10.2 35.4 37.5 45.3 46.8l56.8-56S341 288.9 341 261.4V114.3C341 89 316.5 32 228.7 32 140.7 32 94 87 94 136.3l73.5 6.8c16.3-49.5 54.2-49.5 54.2-49.5 40.7-.1 35.5 29.8 35.5 69.1zm0 86.8c0 80-84.2 68-84.2 17.2 0-47.2 50.5-56.7 84.2-57.8v40.6zm136 163.5c-7.7 10-70 67-174.5 67S34.2 408.5 9.7 379c-6.8-7.7 1-11.3 5.5-8.3C88.5 415.2 203 488.5 387.7 401c7.5-3.7 13.3 2 5.5 12zm39.8 2.2c-6.5 15.8-16 26.8-21.2 31-5.5 4.5-9.5 2.7-6.5-3.8s19.3-46.5 12.7-55c-6.5-8.3-37-4.3-48-3.2-10.8 1-13 2-14-.3-2.3-5.7 21.7-15.5 37.5-17.5 15.7-1.8 41-.8 46 5.7 3.7 5.1 0 27.1-6.5 43.1z"/>
                        </svg>
                        <h2>Amazon UK Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="amazonAccessKey">Access Key:</label>
                        <input type="text" id="amazonAccessKey" placeholder="Enter Access Key">
                        <label for="amazonSecretKey">Secret Key:</label>
                        <input type="text" id="amazonSecretKey" placeholder="Enter Secret Key">
                        <label for="amazonAssociateTag">Associate Tag:</label>
                        <input type="text" id="amazonAssociateTag" placeholder="Enter Associate Tag">
                        <label for="amazonCountry">Country:</label>
                        <input type="text" id="amazonCountry" placeholder="Enter Country (e.g., UK)">
                        <button data-affiliate="amazon_uk">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Visit <a href="https://affiliate-program.amazon.com/" target="_blank">Amazon Associates</a>.
                    </div>
                </div>

                <div id="ebay_uk" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="32" height="32" style="fill: currentColor; margin-right: 10px;">
                            <path d="M606 189.5l-54.8 109.9-54.9-109.9h-37.5l10.9 20.6c-11.5-19-35.9-26-63.3-26-31.8 0-67.9 8.7-71.5 43.1h33.7c1.4-13.8 15.7-21.8 35-21.8 26 0 41 9.6 41 33v3.4c-12.7 0-28 .1-41.7 .4-42.4 .9-69.6 10-76.7 34.4 1-5.2 1.5-10.6 1.5-16.2 0-52.1-39.7-76.2-75.4-76.2-21.3 0-43 5.5-58.7 24.2v-80.6h-32.1v169.5c0 10.3-.6 22.9-1.1 33.1h31.5c.7-6.3 1.1-12.9 1.1-19.5 13.6 16.6 35.4 24.9 58.7 24.9 36.9 0 64.9-21.9 73.3-54.2-.5 2.8-.7 5.8-.7 9 0 24.1 21.1 45 60.6 45 26.6 0 45.8-5.7 61.9-25.5 0 6.6 .3 13.3 1.1 20.2h29.8c-.7-8.2-1-17.5-1-26.8v-65.6c0-9.3-1.7-17.2-4.8-23.8l61.5 116.1-28.5 54.1h35.9L640 189.5zM243.7 313.8c-29.6 0-50.2-21.5-50.2-53.8 0-32.4 20.6-53.8 50.2-53.8 29.8 0 50.2 21.4 50.2 53.8 0 32.3-20.4 53.8-50.2 53.8zm200.9-47.3c0 30-17.9 48.4-51.6 48.4-25.1 0-35-13.4-35-25.8 0-19.1 18.1-24.4 47.2-25.3 13.1-.5 27.6-.6 39.4-.6zm-411.9 1.6h128.8v-8.5c0-51.7-33.1-75.4-78.4-75.4-56.8 0-83 30.8-83 77.6 0 42.5 25.3 74 82.5 74 31.4 0 68-11.7 74.4-46.1h-33.1c-12 35.8-87.7 36.7-91.2-21.6zm95-21.4H33.3c6.9-56.6 92.1-54.7 94.4 0z"/>
                        </svg>
                        <h2>eBay UK Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="ebayAppId">App ID:</label>
                        <input type="text" id="ebayAppId" placeholder="Enter App ID">
                        <button data-affiliate="ebay_uk">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Go to <a href="https://partnernetwork.ebay.com/" target="_blank">eBay Partner Network</a>.
                    </div>
                </div>

                <div id="awin" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-network-wired" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Awin Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="awinApiToken">API Token:</label>
                        <input type="text" id="awinApiToken" placeholder="Enter API Token">
                        <button data-affiliate="awin">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Visit <a href="https://www.awin.com/" target="_blank">Awin</a>.
                    </div>
                </div>

                <div id="cj" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-link" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>CJ Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="cjApiKey">API Key:</label>
                        <input type="text" id="cjApiKey" placeholder="Enter API Key">
                        <label for="cjWebsiteId">Website ID:</label>
                        <input type="text" id="cjWebsiteId" placeholder="Enter Website ID">
                        <button data-affiliate="cj">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Go to <a href="https://www.cj.com/" target="_blank">CJ Affiliate</a>.
                    </div>
                </div>

                <div id="textmagic" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-sms" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>TextMagic Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="textmagicUsername">Username:</label>
                        <input type="text" id="textmagicUsername" placeholder="Enter Username">
                        <label for="textmagicApiKey">API Key:</label>
                        <input type="text" id="textmagicApiKey" placeholder="Enter API Key">
                        <button data-affiliate="textmagic">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Visit <a href="https://www.textmagic.com/" target="_blank">TextMagic</a>.
                    </div>
                </div>

                <div id="tiny" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-pen" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>tiny Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="tinyApiKey">API Key:</label>
                        <input type="text" id="tinyApiKey" placeholder="Enter API Key">
                        <button data-affiliate="tiny">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Visit <a href="https://www.tiny.cloud/" target="_blank">tiny</a>.
                    </div>
                </div>

                <div id="userManagementIntro" class="section">
                    <h2>User Management</h2>
                    <p>This section allows you to manage different types of users in your system.</p>
                    <p>Select a user type from the menu to view their details or modify their permissions:</p>
                    <ul>
                        <li><strong>Partners:</strong> Manage users with Partner permissions.</li>
                        <li><strong>Communities:</strong> Manage community users.</li>
                        <li><strong>Merchants:</strong> Manage merchant users.</li>
                    </ul>
                </div>

                <div id="merchants" class="section">
                    <h2>Merchant Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>USERid</th>
                                <th>Contact Name</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="merchantsList">
                            <!-- Dynamically populated by updateUserTable -->
                        </tbody>
                    </table>
                </div>

                <div id="communities" class="section">
                    <h2>Communities Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>USERid</th>
                                <th>Contact Name</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="communitiesList">
                            <!-- Dynamically populated by updateUserTable -->
                        </tbody>
                    </table>
                </div>

                <div id="partners" class="section">
                    <h2>Partner Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>USERid</th>
                                <th>Contact Name</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partnersList">
                            <!-- Dynamically populated by updateUserTable -->
                        </tbody>
                    </table>
                </div>

                <div id="testScriptsIntro" class="section">
                    <h2>Test Scripts</h2>
                    <p>Use this section to test referral tracking and other scripts.</p>
                    <p>Select an option from the menu to visit endpoints or run referral tests under "Referral Tests."</p>
                </div>

                <div id="referralTestsIntro" class="section">
                    <h2>Referral Tests</h2>
                    <p>This section contains tools to test referral tracking functionality.</p>
                    <p>Choose "Page Visit Referral Test" or "Order Referral Test" to submit test data and verify tracking behavior.</p>
                </div>

                <div id="page_visit_test" class="section">
                    <h2>Page Visit Referral Test</h2>
                    <div class="form">
                        <form id="pageVisitForm">
                            <table>
                                <tr><td><label for="pageReferer">Referer:</label></td><td><select id="pageReferer" name="referer"></select></td></tr>
                                <tr><td><label for="page">Page:</label></td><td><input type="text" id="page" name="page" value="/home"></td></tr>
                                <tr><td><label for="pageTimestamp">Timestamp:</label></td><td><input type="text" id="pageTimestamp" name="timestamp"></td></tr>
                                <tr><td colspan="2"><button type="submit">Submit Page Visit</button></td></tr>
                            </table>
                        </form>
                    </div>
                </div>

                <div id="order_test" class="section">
                    <h2>Order Referral Test</h2>
                    <div class="form">
                        <form id="orderForm">
                            <table>
                                <tr><td><label for="orderReferer">Referer:</label></td><td><select id="orderReferer" name="referer"></select></td></tr>
                                <tr><td><label for="orderId">Order ID:</label></td><td><input type="text" id="orderId" name="orderId" value="ORD12345"></td></tr>
                                <tr><td><label for="buyer">Buyer Name:</label></td><td><input type="text" id="buyer" name="buyer" value="John Doe"></td></tr>
                                <tr><td><label for="total">Total Amount (£):</label></td><td><input type="number" id="total" name="total" value="99.99" step="0.01"></td></tr>
                                <tr><td><label for="orderTimestamp">Timestamp:</label></td><td><input type="text" id="orderTimestamp" name="timestamp"></td></tr>
                                <tr><td colspan="2"><button type="submit">Submit Order</button></td></tr>
                            </table>
                        </form>
                    </div>
                </div>

                <div id="myAccountIntro" class="section">
                    <h2>My Account</h2>
                    <p>Welcome to your account settings. Here, you can manage your personal information and update your password for security.</p>
                    <p>Use the options below to navigate to the desired section:</p>
                </div>

                <div id="contactDetails" class="section">
                    <h2>Contact Details</h2>
                    <div class="settings-form">
                        <label><strong>User ID:</strong></label>
                        <input type="text" id="userId" readonly>
                        <label for="contactName">Contact Name:</label>
                        <input type="text" id="contactName" placeholder="Enter contact name">
                        <label for="websiteUrl">Website URL:</label>
                        <input type="url" id="websiteUrl" placeholder="Enter website URL">
                        <label for="emailAddress">Email Address:</label>
                        <input type="email" id="emailAddress" placeholder="Enter email address">
                        <label><strong>Phone Number:</strong></label>
                        <span>{{ user.phone_number | default('N/A') }}</span>
                        <button data-action="saveSettings"><i class="fas fa-save"></i> Save Settings</button>
                    </div>
                </div>

                <div id="changePassword" class="section">
                    <h2>Change Password</h2>
                    <div class="settings-form">
                        <div class="password-container">
                            <label for="currentPassword">Current Password:</label>
                            <input type="password" id="currentPassword" name="currentPassword" placeholder="Enter current password">
                            <i class="fas fa-eye password-toggle" data-target="currentPassword"></i>
                        </div>
                        <div class="password-container">
                            <label for="newPassword">New Password:</label>
                            <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password">
                            <i class="fas fa-eye password-toggle" data-target="newPassword"></i>
                        </div>
                        <div class="password-container">
                            <label for="confirmPassword">Confirm New Password:</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password">
                            <i class="fas fa-eye password-toggle" data-target="confirmPassword"></i>
                        </div>
                        <button data-action="savePassword"><i class="fas fa-key"></i> Change Password</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in the correct order -->
    <script src="/static/js/site-auth.js"></script>
    <script src="/static/js/site-navigation.js"></script>
    <script src="/static/js/category-management.js"></script>
    <script src="/static/js/site-request.js"></script>
    <script src="/static/js/admin-page.js"></script>
    <script src="/static/js/page-load.js"></script>
    <script>
        // Wait for the initialize function to become available
        function waitForInitialize(attempts = 50, delay = 100) {
            if (typeof window.initialize === 'function') {
                console.log('Initialize function found, calling initialize("admin")');
                window.initialize('admin');
            } else if (attempts > 0) {
                console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                setTimeout(() => waitForInitialize(attempts - 1, delay), delay);
            } else {
                console.error('Initialize function not found after maximum retries');
            }
        }
        waitForInitialize();
    </script>
</body>
</html>
community.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Community</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.tiny.cloud/1/ml1wlwr128qsm8hn8d86e5mhs3y2fuvjr9ztknrsh23x6krp/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</head>
<body>
    <div class="layout-wrapper">
        <div class="header">
            <div class="header-content" id="brandingContent"></div>
        </div>
        <div class="main-container">
            <div class="menu-container">
                <div class="menu">
                    <button data-section="welcome">
                        <span class="button-content"><i class="fas fa-home"></i> Dashboard</span>
                    </button>
                    <button data-submenu="my_website_intro" data-section="my_website_intro">
                        <span class="button-content"><i class="fas fa-globe"></i> My Web Site</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="my_website_intro" class="submenu">
                        <button data-section="wix">
                            <span class="button-content"><i class="fab fa-wix-simple"></i> Wix</span>
                        </button>
                        <button data-section="wordpress">
                            <span class="button-content"><i class="fab fa-wordpress"></i> WordPress</span>
                        </button>
                        <button data-section="squarespace">
                            <span class="button-content"><i class="fab fa-squarespace"></i> Squarespace</span>
                        </button>
                        <button data-section="weebly">
                            <span class="button-content"><i class="fab fa-weebly"></i> Weebly</span>
                        </button>
                        <button data-section="joomla">
                            <span class="button-content"><i class="fab fa-joomla"></i> Joomla</span>
                        </button>
                        <button data-section="no_website">
                            <span class="button-content"><i class="fas fa-question-circle"></i> I Don’t Have a Website Yet</span>
                        </button>
                    </div>
                    <button data-section="categories">
                        <span class="button-content"><i class="fas fa-list"></i> My Categories</span>
                    </button>
                    <button data-submenu="referrals_intro" data-section="referrals_intro">
                        <span class="button-content">
                            <span class="svg-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" preserveAspectRatio="xMidYMid meet">
                                    <path d="M72 88a56 56 0 1 1 112 0A56 56 0 1 1 72 88zM64 245.7C54 256.9 48 271.8 48 288s6 31.1 16 42.3l0-84.7zm144.4-49.3C178.7 222.7 160 261.2 160 304c0 34.3 12 65.8 32 90.5l0 21.5c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32l0-26.8C26.2 371.2 0 332.7 0 288c0-61.9 50.1-112 112-112l32 0c24 0 46.2 7.5 64.4 20.3zM448 416l0-21.5c20-24.7 32-56.2 32-90.5c0-42.8-18.7-81.3-48.4-107.7C449.8 183.5 472 176 496 176l32 0c61.9 0 112 50.1 112 112c0 44.7-26.2 83.2-64 101.2l0 26.8c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32zm8-328a56 56 0 1 1 112 0A56 56 0 1 1 456 88zM576 245.7l0 84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM320 32a64 64 0 1 1 0 128 64 64 0 1 1 0-128zM240 304c0 16.2 6 31 16 42.3l0-84.7c-10 11.3-16 26.1-16 42.3zm144-42.3l0 84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM448 304c0 44.7-26.2 83.2-64 101.2l0 42.8c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32l0-42.8c-37.8-18-64-56.5-64-101.2c0-61.9 50.1-112 112-112l32 0c61.9 0 112 50.1 112 112z"/>
                                </svg>
                            </span> My Referrals
                        </span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="referrals_intro" class="submenu">
                        <button data-section="visits">
                            <span class="button-content"><i class="fas fa-eye"></i> Visits</span>
                        </button>
                        <button data-section="orders">
                            <span class="button-content"><i class="fas fa-shopping-cart"></i> Orders</span>
                        </button>
                    </div>
                    <button data-section="settings">
                        <span class="button-content"><i class="fas fa-cog"></i> My Account</span>
                    </button>
                    <button id="logOffBtn" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
                    </button>
                </div>
            </div>
            <div class="content-wrapper">
                <div id="welcome" class="section active">
                    <h2>Welcome to Your Community Dashboard</h2>
                    <p>Welcome! This dashboard is your hub for managing your community account and tracking referrals.</p>
                    <p>Use the menu on the left to:</p>
                    <ul>
                        <li>Learn how to add discounts to your website or request a site under "My Web Site"</li>
                        <li>Select product categories for your site in "My Categories"</li>
                        <li>View referral statistics under "My Referrals"</li>
                        <li>Update your account details in "My Account"</li>
                    </ul>
                </div>
                {% with user_type='community' %}
                    {% include 'my_account.html' %}
                {% endwith %}
                <div id="categories" class="section">
                    <h2>My Categories</h2>
                    <p>This section lets you choose which product categories will appear on your website's "Community Discounts" page.</p>
                    <div class="treeview" id="categoryTree"></div>
                </div>
                <div id="referrals_intro" class="section">
                    <h2>My Referrals</h2>
                    <p>This section allows you to track your referral activity.</p>
                    <p>Select from the submenu options:</p>
                    <ul>
                        <li><strong>Visits:</strong> View pages visited through your referral links.</li>
                        <li><strong>Orders:</strong> See orders placed via your referrals.</li>
                    </ul>
                </div>
                <div id="visits" class="section">
                    <h2>Visits</h2>
                    <div class="toggle-section" data-toggle="visits_this_month"><i class="fas fa-calendar-day"></i> This Month</div>
                    <div id="visits_this_month" class="toggle-content open">
                        <table id="visitsTableThisMonth">
                            <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                            <tbody id="visitsListThisMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="visits_last_month"><i class="fas fa-calendar-alt"></i> Last Month</div>
                    <div id="visits_last_month" class="toggle-content">
                        <table id="visitsTableLastMonth">
                            <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                            <tbody id="visitsListLastMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="visits_earlier"><i class="fas fa-history"></i> Earlier</div>
                    <div id="visits_earlier" class="toggle-content">
                        <table id="visitsTableEarlier">
                            <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                            <tbody id="visitsListEarlier"></tbody>
                        </table>
                    </div>
                </div>
                <div id="orders" class="section">
                    <h2>Orders</h2>
                    <div class="toggle-section" data-toggle="orders_this_month"><i class="fas fa-calendar-day"></i> This Month</div>
                    <div id="orders_this_month" class="toggle-content open">
                        <table id="ordersTableThisMonth">
                            <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                            <tbody id="ordersListThisMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="orders_last_month"><i class="fas fa-calendar-alt"></i> Last Month</div>
                    <div id="orders_last_month" class="toggle-content">
                        <table id="ordersTableLastMonth">
                            <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                            <tbody id="ordersListLastMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="orders_earlier"><i class="fas fa-history"></i> Earlier</div>
                    <div id="orders_earlier" class="toggle-content">
                        <table id="ordersTableEarlier">
                            <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                            <tbody id="ordersListEarlier"></tbody>
                        </table>
                    </div>
                </div>
                <div id="my_website_intro" class="section">
                    <h2>My Web Site</h2>
                    <p>Welcome to the "My Web Site" section! Here, you can learn how to integrate discounts into your community website.</p>
                    <ul>
                        <li><strong>Wix:</strong> Easy drag-and-drop builder.</li>
                        <li><strong>WordPress:</strong> Flexible CMS.</li>
                        <li><strong>Squarespace:</strong> Stylish solution.</li>
                        <li><strong>Weebly:</strong> Simple builder.</li>
                        <li><strong>Joomla:</strong> Robust CMS.</li>
                        <li><strong>I Don’t Have a Website Yet:</strong> Request a site setup.</li>
                    </ul>
                </div>
                <div id="wix" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" style="height: 32px; width: auto; margin-right: 10px;">
                            <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                            <path d="M393.4 131.7c0 13 2.1 32.7-28.7 43.8-9.5 3.5-16 9.7-16 9.7 0-31 4.7-42.2 17.4-48.9 9.8-5.1 27.2-4.6 27.2-4.6zm-115.8 35.5l-34.2 132.7-28.5-108.6c-7.7-32-20.8-48.5-48.4-48.5-27.4 0-40.7 16.2-48.4 48.5L89.5 299.9 55.3 167.2C49.7 140.5 23.9 129 0 132l65.6 247.9s21.6 1.6 32.5-4c14.2-7.3 21-12.8 29.6-46.6 7.7-30.1 29.1-118.4 31.1-124.7 4.8-14.9 11.1-13.8 15.4 0 2 6.3 23.5 94.6 31.1 124.7 8.6 33.7 15.4 39.3 29.6 46.6 10.8 5.5 32.5 4 32.5 4l65.6-247.9c-24.4-3.1-49.8 8.9-55.3 35.3zm115.8 5.2s-4.1 6.3-13.5 11.6c-6 3.4-11.8 5.6-18 8.6-15.1 7.3-13.2 14-13.2 35.2v152.1s16.6 2.1 27.4-3.4c13.9-7.1 17.1-14 17.3-44.8V181.4l0 0v-9zm163.4 84.1L640 132.8s-35.1-6-52.5 9.9c-13.3 12.1-24.4 29.6-54.2 72.5-.5 .7-6.3 10.5-13.1 0-29.3-42.2-40.8-60.3-54.2-72.5-17.4-15.8-52.5-9.9-52.5-9.9l83.2 123.7-83 123.4s36.6 4.6 54-11.2c11.5-10.5 17.6-20.4 52.5-70.7 6.8-10.5 12.6-.8 13.1 0 29.4 42.4 39.2 58.1 53.1 70.7 17.4 15.8 53.3 11.2 53.3 11.2L556.8 256.5z"/>
                        </svg>
                        <h2>Wix Integration</h2>
                    </div>
                    <p>Add discounts to your Wix site:</p>
                    <ol>
                        <li>Log in to Wix and open the Editor.</li>
                        <li>Click "+" > "Embed" > "Embed a Widget".</li>
                        <li>Paste: <code id="wixCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Publish.</li>
                    </ol>
                </div>
                <div id="wordpress" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fab fa-wordpress" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>WordPress Integration</h2>
                    </div>
                    <p>Add discounts to WordPress:</p>
                    <ol>
                        <li>Log in to WordPress admin.</li>
                        <li>Go to "Pages" > "Add New".</li>
                        <li>Add "Custom HTML" block: <code id="wordpressCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Publish.</li>
                    </ol>
                </div>
                <div id="squarespace" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fab fa-squarespace" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Squarespace Integration</h2>
                    </div>
                    <p>Integrate discounts into Squarespace:</p>
                    <ol>
                        <li>Log in to Squarespace editor.</li>
                        <li>Add a new page.</li>
                        <li>Add "Code" block: <code id="squarespaceCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Update site.</li>
                    </ol>
                </div>
                <div id="weebly" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fab fa-weebly" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Weebly Integration</h2>
                    </div>
                    <p>Add discounts to Weebly:</p>
                    <ol>
                        <li>Log in to Weebly editor.</li>
                        <li>Drag "Embed Code" onto page.</li>
                        <li>Paste: <code id="weeblyCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Publish.</li>
                    </ol>
                </div>
                <div id="joomla" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fab fa-joomla" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Joomla Integration</h2>
                    </div>
                    <p>Integrate discounts into Joomla:</p>
                    <ol>
                        <li>Log in to Joomla admin.</li>
                        <li>Go to "Content" > "Articles" > "Add New".</li>
                        <li>Paste in "Code" view: <code id="joomlaCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Save.</li>
                    </ol>
                </div>
                <div id="no_website" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-question-circle" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>I Don’t Have a Website Yet</h2>
                    </div>
                    <p>Request a custom Wix website for your community from our Wix Professionals. Fill out the form below to specify your needs:</p>
                    <form id="siteRequestForm" class="settings-form">
                        <label for="communityName">Community Name:</label>
                        <input type="text" id="communityName" name="communityName" placeholder="Enter your community name" required>
                        <label for="aboutCommunity">About Our Community:</label>
                        <textarea id="aboutCommunity" name="aboutCommunity" placeholder="Tell us about your community"></textarea>
                        <label for="communityLogos">Community Logos:</label>
                        <input type="file" id="communityLogos" name="communityLogos" accept="image/*" multiple>
                        <small>Upload up to 5 logos (e.g., main logo, secondary logos).</small>
                        <label for="colorPrefs">Color Preferences:</label>
                        <input type="text" id="colorPrefs" name="colorPrefs" placeholder="e.g., #FF5733, Blue">
                        <label for="stylingDetails">Styling Details:</label>
                        <textarea id="stylingDetails" name="stylingDetails" rows="4" placeholder="e.g., modern layout, bold fonts"></textarea>
                        <label for="preferredDomain">Preferred Domain Name:</label>
                        <input type="text" id="preferredDomain" name="preferredDomain" placeholder="e.g., mycommunity.org" oninput="updateEmailDomains()">
                        <button type="button" data-action="checkDomainAvailability"><i class="fas fa-search"></i> Check Availability</button>
                        <label>Email Addresses to Set Up (up to 5):</label>
                        <div id="emailsContainer">
                            <div class="email-section" data-email="1">
                                <label for="email1Name">Email Name:</label>
                                <input type="text" id="email1Name" name="email1Name" placeholder="e.g., info">
                                <span id="email1Domain">@mycommunity.org</span>
                            </div>
                        </div>
                        <button type="button" data-action="addEmail"><i class="fas fa-plus"></i> Add Another Email</button>
                        <label>Requested Pages (up to 5):</label>
                        <div id="pagesContainer">
                            <div class="page-section" data-page="1">
                                <label for="page1Name">Page Name:</label>
                                <input type="text" id="page1Name" name="page1Name" value="Home">
                                <br><br>
                                <label for="page1Content">Page Content:</label>
                                <textarea id="page1Content" name="page1Content" placeholder="Describe this page"></textarea>
                                <label for="page1Images">Additional Images:</label>
                                <input type="file" id="page1Images" name="page1Images" accept="image/*" multiple>
                            </div>
                        </div>
                        <button type="button" data-action="addPage"><i class="fas fa-plus"></i> Add Another Page</button>
                        <label>Wix Widgets:</label>
                        <div class="widget-checkboxes">
                            <div><label><input type="checkbox" name="widgets" value="events"> Events</label> - Add an events calendar.</div>
                            <div><label><input type="checkbox" name="widgets" value="socialMediaFeeds"> Social Media Feeds</label> - Display live social media feeds.</div>
                            <div><label><input type="checkbox" name="widgets" value="gallery"> Gallery</label> - Showcase photos.</div>
                            <div><label><input type="checkbox" name="widgets" value="contactForm"> Contact Form</label> - Simple contact form.</div>
                            <div><label><input type="checkbox" name="widgets" value="blog"> Blog</label> - Share updates and stories.</div>
                            <div><label><input type="checkbox" name="widgets" value="weather"> Weather</label> - Show real-time weather.</div>
                            <div><label><input type="checkbox" name="widgets" value="socialMediaLinks"> Social Media Links</label> - Quick links to profiles.</div>
                        </div>
                        <button type="button" data-action="saveSiteRequest"><i class="fas fa-paper-plane"></i> Submit Request</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in the correct order -->
    <script src="/static/js/site-auth.js"></script>
    <script src="/static/js/site-navigation.js"></script>
    <script src="/static/js/category-management.js"></script>
    <script src="/static/js/site-request.js"></script>
    <script src="/static/js/community-page.js"></script>
    <script src="/static/js/page-load.js"></script>
    <script>
        // Initialize TinyMCE on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            tinymce.init({
                selector: '#aboutCommunity, #stylingDetails, #page1Content',
                inline: true,
                menubar: false,
                toolbar: 'bold italic | bullist numlist | link',
                plugins: 'lists link',
                setup: (editor) => {
                    editor.on('init', () => {
                        console.log('TinyMCE initialized for:', editor.id);
                    });
                }
            });
        });

        // Wait for the initialize function to become available
        function waitForInitialize(attempts = 50, delay = 100) {
            if (typeof window.initialize === 'function') {
                console.log('Initialize function found, calling initialize("community")');
                window.initialize('community');
            } else if (attempts > 0) {
                console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                setTimeout(() => waitForInitialize(attempts - 1, delay), delay);
            } else {
                console.error('Initialize function not found after maximum retries');
            }
        }
        // Call waitForInitialize after all scripts are loaded
        waitForInitialize();
    </script>
</body>
</html>
login.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="login-page">
    <div id="loadingOverlay" style="display: none;">
        <div class="multicircle-loader">
            <div class="circle circle1"></div>
            <div class="circle circle2"></div>
            <div class="circle circle3"></div>
            <div class="circle circle4"></div>
        </div>
    </div>

    <div class="container" id="loginContainer">
        <h2>Login</h2>
        <div class="custom-login-notice">
            <span class="highlight">Please log in</span> to access your account. If you don’t have an account, click "Sign Up" below.
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">Email:</label>
                <div class="input-container">
                    <input type="email" id="loginEmail" name="email" placeholder="Enter your email" required>
                </div>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password:</label>
                <div class="input-container">
                    <input type="password" id="loginPassword" name="password" placeholder="Enter your password" required>
                    <span class="toggle-password"><i class="fas fa-eye"></i></span>
                </div>
            </div>
            <div class="button-container">
                <button type="submit">Login</button>
            </div>
        </form>
        <div class="toggle-link">
            <a href="/signup">Need an account? Sign Up</a><br>
            <a onclick="showForgotPassword()">Forgot Password?</a>
        </div>
    </div>

    <div class="container" id="forgotPasswordContainer" style="display: none;">
        <h2>Forgot Password</h2>
        <form id="forgotPasswordForm">
            <div class="form-group">
                <label for="forgotEmail">Email:</label>
                <input type="email" id="forgotEmail" name="email" placeholder="Enter your email" required>
            </div>
            <button type="submit">Send OTP via SMS</button>
        </form>
        <div class="toggle-link">
            <a onclick="showLogin()">Back to Login</a>
        </div>
    </div>

    <div class="container" id="verifyOtpContainer" style="display: none;">
        <h2>Verify OTP</h2>
        <form id="verifyOtpForm">
            <div class="form-group">
                <label for="verifyEmail">Email:</label>
                <input type="email" id="verifyEmail" name="email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="otpCode">One-Time Password:</label>
                <input type="text" id="otpCode" name="code" placeholder="Enter the OTP from SMS" required>
            </div>
            <div class="form-group">
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" name="new_password" placeholder="Enter new password" required>
            </div>
            <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password:</label>
                <input type="password" id="confirmNewPassword" name="confirm_new_password" placeholder="Confirm new password" required>
            </div>
            <button type="submit">Update Password</button>
        </form>
        <div class="toggle-link">
            <a onclick="showLogin()">Back to Login</a>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="/static/js/site-auth.js"></script>
    <script>
        const apiUrl = window.location.origin;

        // Override Toastr methods to log messages to the console
        (function() {
            // Store the original Toastr methods
            const originalSuccess = toastr.success;
            const originalError = toastr.error;
            const originalInfo = toastr.info;
            const originalWarning = toastr.warning;

            // Override success method
            toastr.success = function(message, title, options) {
                console.log(`Toastr Success: ${title ? title + ' - ' : ''}${message}`);
                return originalSuccess.call(toastr, message, title, options);
            };

            // Override error method
            toastr.error = function(message, title, options) {
                console.log(`Toastr Error: ${title ? title + ' - ' : ''}${message}`);
                return originalError.call(toastr, message, title, options);
            };

            // Override info method
            toastr.info = function(message, title, options) {
                console.log(`Toastr Info: ${title ? title + ' - ' : ''}${message}`);
                return originalInfo.call(toastr, message, title, options);
            };

            // Override warning method
            toastr.warning = function(message, title, options) {
                console.log(`Toastr Warning: ${title ? title + ' - ' : ''}${message}`);
                return originalWarning.call(toastr, message, title, options);
            };
        })();

        toastr.options = {
            closeButton: true,
            progressBar: true,
            positionClass: 'toast-top-right',
            timeOut: 5000,
            showMethod: 'slideDown',
            hideMethod: 'slideUp'
        };

        function showLoadingOverlay() {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.innerHTML = `
                    <div class="multicircle-loader">
                        <div class="circle circle1"></div>
                        <div class="circle circle2"></div>
                        <div class="circle circle3"></div>
                        <div class="circle circle4"></div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'flex';
            return overlay;
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        function showLogin() {
            const loginContainer = document.getElementById('loginContainer');
            if (loginContainer) {
                loginContainer.style.display = 'block';
                document.getElementById('forgotPasswordContainer').style.display = 'none';
                document.getElementById('verifyOtpContainer').style.display = 'none';
                hideLoadingOverlay();
            }
        }

        function showForgotPassword() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('forgotPasswordContainer').style.display = 'block';
            document.getElementById('verifyOtpContainer').style.display = 'none';
            hideLoadingOverlay();
        }

        function showVerifyOtp(email) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('forgotPasswordContainer').style.display = 'none';
            document.getElementById('verifyOtpContainer').style.display = 'block';
            document.getElementById('verifyEmail').value = email;
            hideLoadingOverlay();
        }

        document.querySelectorAll('.toggle-password').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const input = this.parentElement.querySelector('input');
                const icon = this.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });

        async function fetchProtectedPage(url) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                toastr.error('No authentication token found. Please log in.');
                showLogin();
                return;
            }

            const overlay = showLoadingOverlay();
            try {
                const response = await fetch(`${apiUrl}${url}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'text/html' }
                });
                if (!response.ok) throw new Error(`Server returned ${response.status}: ${await response.text()}`);
                const html = await response.text();
                document.documentElement.innerHTML = html;

                if (!document.getElementById('loadingOverlay')) {
                    const newOverlay = document.createElement('div');
                    newOverlay.id = 'loadingOverlay';
                    newOverlay.innerHTML = overlay.innerHTML;
                    newOverlay.style.display = 'flex';
                    document.body.prepend(newOverlay);
                }

                const head = document.head;
                const requiredStyles = [
                    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css',
                    'https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css',
                    '/static/styles.css'
                ];
                requiredStyles.forEach(href => {
                    if (!head.querySelector(`link[href="${href}"]`)) {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = href;
                        head.appendChild(link);
                    }
                });

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const scripts = doc.querySelectorAll('script');
                const scriptPromises = [];
                scripts.forEach(script => {
                    if (script.src) {
                        const newScript = document.createElement('script');
                        newScript.src = script.src;
                        newScript.async = false;
                        scriptPromises.push(new Promise(resolve => {
                            newScript.onload = resolve;
                            newScript.onerror = () => console.error(`Failed to load script: ${script.src}`);
                            document.head.appendChild(newScript);
                        }));
                    } else if (script.innerHTML.trim()) {
                        try { (new Function(script.innerHTML))(); } catch (e) { console.error('Error executing inline script:', e); }
                    }
                });

                await Promise.all(scriptPromises);
                setTimeout(() => {
                    const layoutWrapper = document.querySelector('.layout-wrapper');
                    if (layoutWrapper) layoutWrapper.style.display = 'block';
                    else toastr.error('Failed to load page content');
                    hideLoadingOverlay();
                }, 1000);
            } catch (error) {
                toastr.error(error.message || 'Failed to load protected page');
                showLogin();
                hideLoadingOverlay();
            }
        }

        function redirectBasedOnPermissions() {
            const token = localStorage.getItem('authToken');
            if (!token) return false;

            let decoded;
            try { decoded = decodeJWT(token); } catch (e) {
                toastr.error('Invalid token format. Please log in again.');
                localStorage.removeItem('authToken');
                return false;
            }

            if (!decoded || !decoded.permissions) {
                localStorage.removeItem('authToken');
                return false;
            }

            const permissions = decoded.permissions;
            let redirectPath;
            if (permissions.includes('admin')) redirectPath = '/admin';
            else if (permissions.includes('wixpro')) redirectPath = '/partner';
            else if (permissions.includes('merchant')) redirectPath = '/merchant';
            else if (permissions.includes('community')) redirectPath = '/community';
            else redirectPath = '/';

            if (window.location.pathname !== redirectPath) {
                fetchProtectedPage(redirectPath);
                return true;
            }
            return false;
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            showLoadingOverlay();
            try {
                const response = await fetch(`${apiUrl}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (!response.ok) throw new Error((await response.json()).message || `Login failed with status ${response.status}`);

                const data = await response.json();
                if (data.status !== 'success') throw new Error(data.message || 'Login failed');

                localStorage.setItem('authToken', data.token);
                if (data.userId) localStorage.setItem('userId', data.userId);

                const decoded = decodeJWT(data.token);
                const permissions = decoded.permissions || [];
                const needsVerification = (permissions.includes('merchant') || permissions.includes('community')) && !permissions.includes('verified');

                if (needsVerification) {
                    const otpResponse = await fetch(`${apiUrl}/reset-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const otpData = await otpResponse.json();
                    if (!otpResponse.ok) throw new Error(otpData.message || 'Failed to send OTP');

                    toastr.success('OTP sent to your phone. Please enter it below.');
                    const loginContainer = document.getElementById('loginContainer');
                    loginContainer.innerHTML = `
                        <h2>Verify OTP</h2>
                        <form id="loginOtpForm">
                            <div class="form-group">
                                <label for="loginOtp">One-Time Password:</label>
                                <input type="text" id="loginOtp" name="otp" placeholder="Enter OTP" required>
                            </div>
                            <button type="submit">Verify OTP</button>
                        </form>
                    `;
                    hideLoadingOverlay();

                    document.getElementById('loginOtpForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const otp = document.getElementById('loginOtp').value.trim();
                        if (!otp) {
                            toastr.error('Please enter the OTP.');
                            return;
                        }

                        showLoadingOverlay();
                        const verifyResponse = await fetch(`${apiUrl}/verify-reset-code`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, code: otp, new_password: password })
                        });
                        const verifyData = await verifyResponse.json();
                        if (!verifyResponse.ok) throw new Error(verifyData.message || 'OTP verification failed');

                        localStorage.setItem('authToken', verifyData.token);
                        toastr.success('Verification successful! Redirecting...');
                        redirectBasedOnPermissions();
                    });
                } else {
                    toastr.success(`Welcome back, ${data.contact_name || 'User'}!`);
                    redirectBasedOnPermissions();
                }
            } catch (error) {
                toastr.error(error.message || 'Unable to connect to server.');
                hideLoadingOverlay();
            }
        });

        document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value.trim();

            showLoadingOverlay();
            try {
                const response = await fetch(`${apiUrl}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Reset request failed');

                toastr.success('A one-time password has been sent to your phone.');
                showVerifyOtp(email);
            } catch (error) {
                toastr.error(error.message || 'Error sending OTP');
                hideLoadingOverlay();
            }
        });

        document.getElementById('verifyOtpForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('verifyEmail').value.trim();
            const code = document.getElementById('otpCode').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            const passwordRegex = /^(?=.*\d).{8,}$/;
            if (!passwordRegex.test(newPassword)) {
                toastr.error('New password must be at least 8 characters long and include numbers');
                return;
            }
            if (newPassword !== confirmNewPassword) {
                toastr.error('New password and confirmation do not match');
                return;
            }

            showLoadingOverlay();
            try {
                const response = await fetch(`${apiUrl}/verify-reset-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, new_password: newPassword })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Verification failed');

                toastr.success('Password updated successfully!');
                showLogin();
            } catch (error) {
                toastr.error(error.message || 'Error verifying OTP');
                hideLoadingOverlay();
            }
        });
    </script>
</body>
</html>
merchant.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Merchant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.tiny.cloud/1/ml1wlwr128qsm8hn8d86e5mhs3y2fuvjr9ztknrsh23x6krp/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- Define window.apiUrl before loading scripts -->
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</head>
<body>
    <div class="layout-wrapper">
        <div class="header" style="margin-bottom: 0; padding-bottom: 0;">
            <div class="header-content" id="brandingContent">
                <!-- Branding content will be loaded here -->
            </div>
        </div>
        <div class="main-container" style="margin-top: 0; padding-top: 0;">
            <div class="menu-container">
                <div class="menu">
                    <button data-section="my-products">
                        <span class="button-content"><i class="fas fa-box-open"></i> My Products</span>
                    </button>
                    <button data-section="my-store">
                        <span class="button-content"><i class="fas fa-store"></i> My Store</span>
                    </button>
                    <button data-section="my-account">
                        <span class="button-content"><i class="fas fa-cog"></i> My Account</span>
                    </button>
                    <button data-href="/admin">
                        <span class="button-content"><i class="fas fa-arrow-left"></i> Back to Admin</span>
                    </button>
                    <button id="logOffBtn" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
                    </button>
                </div>
            </div>
            <div class="content-wrapper" style="margin-top: 0;">
                <div id="welcome" class="section">
                    <h2>Welcome to Your Merchant Dashboard</h2>
                    <p>This dashboard allows you to link the parts on your Wix site to a network of community groups, who show relevant discounted products on their websites from clubmadeira.io.</p>
                </div>
                <div id="info" class="section">
                    <h2>Merchant Info</h2>
                    <p>Welcome to your merchant dashboard overview. Use the menu to manage products, your store, Wix integration, and account settings.</p>
                </div>
                {% with user_type='merchant' %}
                    {% include 'my_account.html' %}
                {% endwith %}
                <div id="my-products" class="section">
                    <h2>My Products</h2>
                    <p>These are the products from your parts feed.</p>
                    <table id="productTable">
                        <thead>
                            <tr><th class="hidden">ID</th><th>Category</th><th>Title</th><th>URL</th><th>Price</th><th>Original</th><th>Image</th><th>QTY</th></tr>
                        </thead>
                        <tbody id="productList"></tbody>
                    </table>
                </div>
                <div id="my-store" class="section" style="margin-left: 210px; margin-right: 10px; width: calc(100% - 220px);">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-store" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>My Store</h2>
                    </div>
                    <p>Request a custom Wix store to sell your products online. Provide details below to set up your store (minimum: Home and Returns Policy pages).</p>
                    <form id="storeRequestForm" class="settings-form" style="width: 100%;">
                        <label for="storeName">Store Name:</label>
                        <input type="text" id="storeName" name="storeName" placeholder="Enter your store name" required>

                        <label for="aboutStore">About Your Store:</label>
                        <textarea id="aboutStore" name="aboutStore" placeholder="Describe your store (e.g., product focus, target audience)"></textarea>

                        <label for="storeLogos">Store Logos:</label>
                        <input type="file" id="storeLogos" name="storeLogos" accept="image/*" multiple>
                        <small>Upload up to 5 logos (e.g., main logo, favicon).</small>

                        <label for="colorPrefs">Color Preferences:</label>
                        <input type="text" id="colorPrefs" name="colorPrefs" placeholder="e.g., #FF5733, Blue">

                        <label for="stylingDetails">Styling Details:</label>
                        <textarea id="stylingDetails" name="stylingDetails" rows="4" placeholder="e.g., sleek design, minimalistic"></textarea>

                        <label for="preferredDomain">Preferred Domain Name:</label>
                        <input type="text" id="preferredDOMAIN" name="preferredDomain" placeholder="e.g., mystore.uk" oninput="updateDomainPreview()">
                        <button type="button" data-action="checkDomainAvailability"><i class="fas fa-search"></i> Check Availability</button>
                        <span id="domainPreview">@mystore.uk</span>

                        <label>Email Addresses to Set Up (up to 5):</label>
                        <div id="emailsContainer">
                            <div class="email-section" data-email="1">
                                <label for="email1Name">Email Name:</label>
                                <input type="text" id="email1Name" name="email1Name" placeholder="e.g., info">
                                <span id="email1Domain">@mystore.uk</span>
                            </div>
                        </div>
                        <button type="button" data-action="addEmail"><i class="fas fa-plus"></i> Add Another Email</button>

                        <label>Required Pages:</label>
                        <div id="pagesContainer">
                            <div class="page-section" data-page="1">
                                <label for="page1Name">Page Name:</label>
                                <input type="text" id="page1Name" name="page1Name" value="Home" readonly>
                                <br><br>
                                <label for="page1Content">Home Page Content:</label>
                                <textarea id="page1Content" name="page1Content" placeholder="Describe your home page (e.g., welcome message, featured products)"></textarea>
                                <label for="page1Images">Additional Images:</label>
                                <input type="file" id="page1Images" name="page1Images" accept="image/*" multiple>
                            </div>
                            <div class="page-section" data-page="2">
                                <label for="page2Name">Page Name:</label>
                                <input type="text" id="page2Name" name="page2Name" value="Returns Policy" readonly>
                                <br><br>
                                <label for="page2Content">Returns Policy Content:</label>
                                <textarea id="page2Content" name="page2Content" placeholder="Outline your returns policy"></textarea>
                                <label for="page2Images">Additional Images:</label>
                                <input type="file" id="page2Images" name="page2Images" accept="image/*" multiple>
                            </div>
                        </div>
                        <button type="button" data-action="addPage"><i class="fas fa-plus"></i> Add Another Page</button>

                        <label>Wix Store Widgets:</label>
                        <div class="widget-checkboxes">
                            <div><label><input type="checkbox" name="widgets" value="productCatalog"> Product Catalog</label> - Display your products.</div>
                            <div><label><input type="checkbox" name="widgets" value="checkout"> Checkout</label> - Enable direct purchases.</div>
                            <div><label><input type="checkbox" name="widgets" value="cart"> Shopping Cart</label> - Add a cart for customers.</div>
                            <div><label><input type="checkbox" name="widgets" value="promotions"> Promotions</label> - Highlight sales and discounts.</div>
                            <div><label><input type="checkbox" name="widgets" value="contactForm"> Contact Form</label> - Customer inquiries.</div>
                        </div>

                        <button type="button" data-action="saveStoreRequest"><i class="fas fa-paper-plane"></i> Submit Request</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in the correct order -->
    <script src="/static/js/site-auth.js"></script>
    <script src="/static/js/site-navigation.js"></script>
    <script src="/static/js/site-request.js"></script>
    <script src="/static/js/user-management.js"></script>
    <script src="/static/js/merchant-page.js"></script>
    <script src="/static/js/page-load.js"></script>
    <script>
        // Initialize TinyMCE with minimal configuration for specific textareas
        document.addEventListener('DOMContentLoaded', () => {
            tinymce.init({
                selector: '#aboutStore, #stylingDetails, #page1Content, #page2Content',
                inline: true,
                menubar: false,
                toolbar: 'bold italic | bullist numlist | link',
                plugins: 'lists link',
                setup: (editor) => {
                    editor.on('init', () => {
                        console.log('TinyMCE initialized for:', editor.id);
                    });
                }
            });
        });

        // Wait for the initialize function to become available
        function waitForInitialize(attempts = 50, delay = 100) {
            if (typeof window.initialize === 'function') {
                console.log('Initialize function found, calling initialize("merchant")');
                window.initialize('merchant');
            } else if (attempts > 0) {
                console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                setTimeout(() => waitForInitialize(attempts - 1, delay), delay);
            } else {
                console.error('Initialize function not found after maximum retries');
            }
        }
        // Call waitForInitialize after all scripts are loaded
        waitForInitialize();
    </script>
</body>
</html>
my_account.html
<div id="settings" class="section">
    <h2>My Account</h2>
    <div class="settings-form">
        <!-- Contact Details Subsection -->
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: 24px; width: auto; margin-right: 10px;">
                <!-- Font Awesome Free 6.5.2: fa-address-card -->
                <path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zm80 256h64c44.2 0 80 35.8 80 80c0 8.8-7.2 16-16 16H112c-8.8 0-16-7.2-16-16c0-44.2 35.8-80 80-80zm-32-96a64 64 0 1 1 128 0 64 64 0 1 1 -128 0zm256-32H304c-8.8 0-16 7.2-16 16v64c0 8.8 7.2 16 16 16h64c8.8 0 16-7.2 16-16V176c0-8.8-7.2-16-16-16zm-64 0c0-26.5 21.5-48 48-48s48 21.5 48 48v64c0 26.5-21.5 48-48 48s-48-21.5-48-48V176z"/>
            </svg>
            <h3>Contact Details</h3>
        </div>
        {% if user_type == "community" %}
        <label><strong>User ID:</strong></label>
        <input type="text" id="userId" readonly>
        <label><strong>Referrer ID:</strong> <span id="referrerId"></span></label>
        {% else %}
        {% if user_type == "merchant" %}
        <label><strong>User ID:</strong></label>
        <input type="text" id="userId" readonly>
        {% endif %}
        {% endif %}
        <label for="contactName">Contact Name:</label>
        <input type="text" id="contactName" placeholder="Enter contact name">
        <label for="websiteUrl">Website URL:</label>
        <input type="url" id="websiteUrl" placeholder="Enter website URL">
        <label for="emailAddress">Email Address:</label>
        <input type="email" id="emailAddress" placeholder="Enter email address">
        <label><strong>Phone Number:</strong></label>
        <span>{{ user.phone_number | default('N/A') }}</span>
        <button data-action="saveSettings"><i class="fas fa-save"></i> Save Settings</button>

        <!-- Change Password Subsection -->
        <div style="display: flex; align-items: center; margin-top: 20px; margin-bottom: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: 24px; width: auto; margin-right: 10px;">
                <!-- Font Awesome Free 6.5.2: fa-lock -->
                <path d="M336 352c97.2 0 176-78.8 176-176S433.2 0 336 0S160 78.8 160 176c0 18.7 2.9 36.8 8.3 53.7L7 391c-4.5 4.5-7 10.6-7 17v80c0 13.3 10.7 24 24 24h80c13.3 0 24-10.7 24-24V448h40c13.3 0 24-10.7 24-24V384h40c6.4 0 12.5-2.5 17-7l33.3-33.3c16.9 5.4 35 8.3 53.7 8.3zM376 96a40 40 0 1 1 0 80 40 40 0 1 1 0-80z"/>
            </svg>
            <h3>Change Password</h3>
        </div>
        <div class="password-container">
            <label for="currentPassword">Current Password:</label>
            <input type="password" id="currentPassword" name="currentPassword" placeholder="Enter current password">
            <i class="fas fa-eye password-toggle" {% if user_type == "partner" %}data-field="currentPassword Ascending"{% else %}data-target="currentPassword"{% endif %}></i>
        </div>
        <div class="password-container">
            <label for="newPassword">New Password:</label>
            <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password">
            <i class="fas fa-eye password-toggle" {% if user_type == "partner" %}data-field="newPassword"{% else %}data-target="newPassword"{% endif %}></i>
        </div>
        <div class="password-container">
            <label for="confirmPassword">Confirm New Password:</label>
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password">
            <i class="fas fa-eye password-toggle" {% if user_type == "partner" %}data-field="confirmPassword"{% else %}data-target="confirmPassword"{% endif %}></i>
        </div>
        <button data-action="savePassword"><i class="fas fa-key"></i> Change Password</button>
    </div>
</div>
partner.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Partner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <!-- Define window.apiUrl before loading scripts -->
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</head>
<body>
    <div class="layout-wrapper">
        <div class="header">
            <div class="header-content" id="brandingContent">
                <!-- Branding content will be loaded here -->
            </div>
        </div>
        <div class="main-container">
            <div class="menu-container">
                <div class="menu">
                    <button data-section="welcome">
                        <span class="button-content"><i class="fas fa-home"></i> Dashboard</span>
                    </button>
                    <button data-section="my-account">
                        <span class="button-content"><i class="fas fa-cog"></i> My Account</span>
                    </button>
                    <button data-section="my-products">
                        <span class="button-content"><i class="fas fa-box-open"></i> My Products</span>
                    </button>
                    <button data-section="wix-keys">
                        <span class="button-content"><i class="fab fa-wix-simple"></i> Wix Keys</span>
                    </button>
                    <button data-section="site-requests">
                        <span class="button-content"><i class="fas fa-file-alt"></i> Site Requests</span>
                    </button>
                    <button data-section="documentation">
                        <span class="button-content"><i class="fas fa-book"></i> Documentation</span>
                    </button>
                    <button data-href="/admin">
                        <span class="button-content"><i class="fas fa-arrow-left"></i> Back to Admin</span>
                    </button>
                    <button id="logOffBtn" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
                    </button>
                </div>
            </div>
            <div class="content-wrapper">
                <div id="welcome" class="section active">
                    <h2>Welcome to Your Partner Dashboard</h2>
                    <p>This dashboard is designed for partners to manage merchant integrations with clubmadeira.io. Use the "My Account" section to update your contact details or change your password. If you have admin privileges, you can return to the admin panel using the "Back to Admin" button.</p>
                </div>
                {% with user_type='partner' %}
                    {% include 'my_account.html' %}
                {% endwith %}
                <div id="my-products" class="section">
                    <h2>My Products</h2>
                    <p>These are the products from your parts feed.</p>
                    <table id="productTable">
                        <thead>
                            <tr><th class="hidden">ID</th><th>Category</th><th>Title</th><th>URL</th><th>Price</th><th>Original</th><th>Image</th><th>QTY</th></tr>
                        </thead>
                        <tbody id="productList"></tbody>
                    </table>
                </div>
                <div id="wix-keys" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fab fa-wix-simple" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Wix Keys</h2>
                    </div>
                    <p>Your Wix Client ID is used to integrate your merchant account with Wix services. Ensure it matches the key provided in your Wix developer dashboard.</p>
                    <div class="settings-form">
                        <label for="wixClientId">Wix Client ID:</label>
                        <input type="text" id="wixClientId" placeholder="Enter Wix Client ID">
                        <button data-action="saveWixClientId"><i class="fas fa-save"></i> Save Wix Client ID</button>
                    </div>
                </div>
                <div id="site-requests" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-file-alt" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Site Requests</h2>
                    </div>
                    <p>View and manage site requests from merchants and communities. Click a row to see details.</p>
                    <table id="siteRequestsTable">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Received At</th>
                                <th>Contact Name</th>
                                <th>Email</th>
                                <th>Organisation</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="siteRequestsList"></tbody>
                    </table>
                </div>
                <div id="site-request-detail" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-info-circle" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Site Request Details</h2>
                    </div>
                    <div class="settings-form">
                        <button data-section="site-requests"><i class="fas fa-arrow-left"></i> Back to Site Requests</button>
                        <div id="siteRequestContent"></div>
                    </div>
                </div>
                <div id="documentation" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-book" style="font-size: 32px; margin-right: 10px;"></i>
                        <h2>Documentation</h2>
                    </div>
                    <div id="documentation-content">
                        <p>This section provides documentation for integrating with clubmadeira.io. Select a specific topic from the submenu.</p>
                    </div>
                </div>
                <div id="apiKeyModal" class="modal">
                    <div class="modal-content">
                        <span class="close" data-action="closeApiKeyModal"><i class="fas fa-times"></i></span>
                        <h3><i class="fas fa-key"></i> Enter API Key</h3>
                        <label for="merchantWixClientId">Wix Client ID:</label>
                        <input type="text" id="merchantWixClientId" placeholder="Enter Wix Client ID">
                        <button data-action="saveMerchantWixClientId"><i class="fas fa-save"></i> Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in the correct order -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js"></script>
    <script src="/static/js/site-auth.js"></script>
    <script src="/static/js/site-navigation.js"></script>
    <script src="/static/js/site-request.js"></script>
    <script src="/static/js/user-management.js"></script>
    <script src="/static/js/partner-page.js"></script>
    <script src="/static/js/page-load.js"></script>
    <script>
        // Wait for the initialize function to become available
        function waitForInitialize(attempts = 50, delay = 100) {
            if (typeof window.initialize === 'function') {
                console.log('Initialize function found, calling initialize("partner")');
                window.initialize('partner');
            } else if (attempts > 0) {
                console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                setTimeout(() => waitForInitialize(attempts - 1, delay), delay);
            } else {
                console.error('Initialize function not found after maximum retries');
            }
        }
        // Call waitForInitialize after all scripts are loaded
        waitForInitialize();
    </script>
</body>
</html>
signup.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .signup-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }
        .options {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-bottom: 30px;
        }
        .option {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            transition: border 0.3s ease;
        }
        .option.selected {
            border: 3px solid #007BFF;
            border-radius: 5px;
        }
        .option img {
            object-fit: cover;
            border-radius: 5px;
        }
        .option span {
            display: block;
            margin-top: 10px;
            font-size: 16px;
            color: #333;
        }
        .option input[type="radio"] {
            display: none;
        }
        .form-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-right: 100px; /* Shifts form 100px left */
        }
        button {
            background-color: #007BFF;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            max-width: 200px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .form-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 400px;
        }
        .form-group label {
            font-weight: bold;
            flex: 1;
            text-align: right;
            margin-bottom: 0;
        }
        .form-group .input-container {
            position: relative;
            width: 192px; /* 160px + 20% = 192px */
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            padding-right: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="signup-container">
        <h1>Sign Up - I am a...</h1>
        <form id="signupForm" autocomplete="off">
            <!-- Dummy fields to trick autofill -->
            <input type="text" class="hidden" autocomplete="off">
            <input type="text" class="hidden" autocomplete="off">
            <div class="options">
                <label class="option">
                    <input type="radio" name="signup_type" value="community">
                    <img src="{{ url_for('static', filename='img/community.jpg') }}" alt="Scout leader in uniform, neck down">
                    <span>Community Group</span>
                </label>
                <label class="option">
                    <input type="radio" name="signup_type" value="seller">
                    <img src="{{ url_for('static', filename='img/merchant.jpg') }}" alt="White man in business suit, neck down">
                    <span>Merchant</span>
                </label>
                <label class="option">
                    <input type="radio" name="signup_type" value="wixpro">
                    <img src="{{ url_for('static', filename='img/wixpro.jpg') }}" alt="Female ethnic web designer in casual dress, neck down">
                    <span>Partner</span>
                </label>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="contact_name">Contact Name:</label>
                    <div class="input-container">
                        <input type="text" id="contact_name" name="contact_name" required autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-phone">Phone Number:</label>
                    <div class="input-container">
                        <input type="tel" id="signup-phone" name="signup_phone" autocomplete="off" pattern="[0-9]{10}" title="Please enter a 10-digit phone number">
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email:</label>
                    <div class="input-container">
                        <input type="text" id="signup-email" name="signup_email" required autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password:</label>
                    <div class="input-container">
                        <input type="text" id="signup-password" name="signup_password" required autocomplete="new-password">
                        <i class="fas fa-eye toggle-password" data-target="signup-password"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-confirm-password">Confirm Password:</label>
                    <div class="input-container">
                        <input type="password" id="signup-confirm-password" name="signup_confirm_password" required autocomplete="new-password">
                        <i class="fas fa-eye toggle-password" data-target="signup-confirm-password"></i>
                    </div>
                </div>
                <button type="submit">Sign Me Up</button>
            </div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // Set correct input types and clear fields after load
        window.onload = function() {
            const emailInput = document.getElementById('signup-email');
            const passwordInput = document.getElementById('signup-password');
            const confirmPasswordInput = document.getElementById('signup-confirm-password');
            const phoneInput = document.getElementById('signup-phone');

            // Set proper types
            emailInput.type = 'email';
            passwordInput.type = 'password';

            // Double-clear strategy
            setTimeout(function() {
                emailInput.value = '';
                passwordInput.value = '';
                confirmPasswordInput.value = '';
                phoneInput.value = '';
            }, 100);

            setTimeout(function() {
                emailInput.value = '';
                passwordInput.value = '';
                confirmPasswordInput.value = '';
                phoneInput.value = '';
            }, 500); // Extra delay for Chrome
        };

        // Clear fields on focus
        document.getElementById('signup-email').addEventListener('focus', function() {
            this.value = '';
        });
        document.getElementById('signup-password').addEventListener('focus', function() {
            this.value = '';
        });
        document.getElementById('signup-confirm-password').addEventListener('focus', function() {
            this.value = '';
        });
        document.getElementById('signup-phone').addEventListener('focus', function() {
            this.value = '';
        });

        // Highlight selected option
        document.querySelectorAll('input[name="signup_type"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.option').forEach(function(option) {
                    option.classList.remove('selected');
                });
                if (this.checked) {
                    this.closest('.option').classList.add('selected');
                }
            });
        });

        // Dynamically set 'required' attribute for phone number based on signup type
        document.querySelectorAll('input[name="signup_type"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                const phoneInput = document.getElementById('signup-phone');
                if (this.value === 'wixpro') {
                    phoneInput.removeAttribute('required');
                } else {
                    phoneInput.setAttribute('required', '');
                }
            });
        });

        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(function(icon) {
            icon.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if (input.type === 'password') {
                    input.type = 'text';
                    this.classList.remove('fa-eye');
                    this.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    this.classList.remove('fa-eye-slash');
                    this.classList.add('fa-eye');
                }
            });
        });

        // Form submission with OTP workflow
        $('#signupForm').on('submit', async function(e) {
            e.preventDefault();

            const signupType = $('input[name="signup_type"]:checked').val();
            if (!signupType) {
                toastr.error('Please select a signup type.');
                return;
            }

            const contactName = $('#contact_name').val().trim();
            const phone = $('#signup-phone').val().trim();
            const email = $('#signup-email').val().trim();
            const password = $('#signup-password').val().trim();
            const confirmPassword = $('#signup-confirm-password').val().trim();

            // Validation: Check all required fields, password match, and phone validity
            if (!contactName || !email || !password || !confirmPassword) {
                toastr.error('All fields except phone (for Partner) must be filled.');
                return;
            }

            if (password !== confirmPassword) {
                toastr.error('Passwords do not match.');
                return;
            }

            const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
            if (!passwordRegex.test(password)) {
                toastr.error('Password must be 8+ characters with letters and numbers.');
                return;
            }

            if (signupType !== 'wixpro') {
                if (!phone) {
                    toastr.error('Phone number is required for Community Group and Merchant.');
                    return;
                }
                const phoneRegex = /^\d{10}$/;
                if (!phoneRegex.test(phone)) {
                    toastr.error('Enter a valid 10-digit phone number (e.g., 1234567890).');
                    return;
                }
            }

            const signupData = { 
                signup_type: signupType, 
                contact_name: contactName, 
                signup_phone: phone || null, 
                signup_email: email, 
                signup_password: password 
            };

            try {
                // Step 1: Create user with /signup
                const signupResponse = await fetch('/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(signupData)
                });
                const signupDataResp = await signupResponse.json();
                if (!signupResponse.ok) throw new Error(signupDataResp.message || 'Signup failed');

                if (signupType === 'wixpro') {
                    // Partner: Direct to login
                    toastr.success('Signup successful! Redirecting to login...');
                    setTimeout(() => window.location.href = '/login', 2000);
                } else {
                    // Merchant/Community: Send OTP with /reset-password
                    const otpResponse = await fetch('/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const otpData = await otpResponse.json();
                    if (!otpResponse.ok) throw new Error(otpData.message || 'Failed to send OTP');

                    toastr.success('OTP sent to your phone. Please enter it below.');
                    const otpContainer = document.createElement('div');
                    otpContainer.innerHTML = `
                        <div class="form-group">
                            <label for="signupOtp">Enter OTP:</label>
                            <input type="text" id="signupOtp" name="otp" placeholder="Enter OTP" required>
                        </div>
                        <button id="verifyOtpBtn">Verify OTP</button>
                    `;
                    this.appendChild(otpContainer);
                    this.querySelector('.form-section').style.display = 'none';

                    document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
                        const otp = document.getElementById('signupOtp').value.trim();
                        if (!otp) {
                            toastr.error('Please enter the OTP.');
                            return;
                        }

                        // Step 2: Verify OTP with /verify-reset-code
                        const verifyResponse = await fetch('/verify-reset-code', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, code: otp, new_password: password })
                        });
                        const verifyData = await verifyResponse.json();
                        if (!verifyResponse.ok) throw new Error(verifyData.message || 'OTP verification failed');

                        // Step 3: Redirect to group page based on signup_type
                        toastr.success('Signup verified! Redirecting to your page...');
                        const redirectPath = signupType === 'seller' ? '/merchant' : '/community';
                        setTimeout(() => window.location.href = redirectPath, 2000);
                    });
                }
            } catch (error) {
                toastr.error(error.message || 'Error during signup/OTP process');
            }
        });

        // Toastr options
        toastr.options = {
            closeButton: true,
            progressBar: true,
            positionClass: 'toast-top-right',
            timeOut: 5000
        };
    </script>
</body>
</html>
