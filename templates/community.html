<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Community</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/icons.css">
    <script src="https://cdn.tiny.cloud/1/ml1wlwr128qsm8hn8d86e5mhs3y2fuvjr9ztknrsh23x6krp/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- Favicon: Font Awesome "group-arrows-rotate" SVG (Unicode f366) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path d='M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160zM201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'/></svg>" type="image/svg+xml">
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" defer></script>
</head>
<body>
    {% include 'overlay.inc' %}  <!-- Loading overlay added -->
    <div class="layout-wrapper">
        <div class="header">
            <div class="header-content" id="brandingContent"></div>
        </div>
        <div class="main-container">
            <div class="menu-container">
                <div class="menu">
                    <button data-submenu="my_website_intro" data-section="my_website_intro">
                        <span class="button-content"><i class="fas fa-globe"></i> My Web Site</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="my_website_intro" class="submenu">
                        <button data-section="wix">
                            <span class="button-content"><span class="icon-wix menu-size"></span> Wix</span>
                        </button>
                        <button data-section="wordpress">
                            <span class="button-content"><span class="icon-wordpress menu-size"></span> WordPress</span>
                        </button>
                        <button data-section="squarespace">
                            <span class="button-content"><span class="icon-squarespace menu-size"></span> Squarespace</span>
                        </button>
                        <button data-section="weebly">
                            <span class="button-content"><span class="icon-weebly menu-size"></span> Weebly</span>
                        </button>
                        <button data-section="joomla">
                            <span class="button-content"><span class="icon-joomla menu-size"></span> Joomla</span>
                        </button>
                        <button data-section="no_website">
                            <span class="button-content"><i class="fas fa-question-circle menu-size"></i> I Don’t Have a Website Yet</span>
                        </button>
                    </div>
                    <button data-section="categories">
                        <span class="button-content"><i class="fas fa-list"></i> My Categories</span>
                    </button>
                    <button data-submenu="referrals_intro" data-section="referrals_intro">
                        <span class="button-content">
                            <span class="icon-community menu-size"></span> My Referrals
                        </span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="referrals_intro" class="submenu">
                        <button data-section="visits">
                            <span class="button-content"><i class="fas fa-eye"></i> Visits</span>
                        </button>
                        <button data-section="orders">
                            <span class="button-content"><i class="fas fa-shopping-cart"></i> Orders</span>
                        </button>
                    </div>
                    <button data-submenu="my-account-submenu" data-section="my-account">
                        <span class="button-content"><i class="fas fa-cog"></i> My Account</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="my-account-submenu" class="submenu">
                        <button data-section="contact-details">
                            <span class="button-content"><i class="fas fa-address-book"></i> Contact</span>
                        </button>
                        <button data-section="change-password">
                            <span class="button-content"><i class="fas fa-key"></i> Change Password</span>
                        </button>
                    </div>
                    <button data-href="/admin" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-arrow-left"></i> Back to Admin</span>
                    </button>
                    <button id="logOffBtn" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
                    </button>
                </div>
            </div>
            <div class="content-wrapper">
                <div id="welcome" class="section">
                    <h2>Welcome to Your Community Dashboard</h2>
                    <p id="welcome-message">Hello, <span id="user-contact-name">[User]</span>! This dashboard is your hub for managing your community account and tracking referrals.</p>
                    <p>As a valued member, connect with other community groups to share resources and grow together.</p>
                    <p>Use the menu on the left to:</p>
                    <ul>
                        <li>Learn how to add discounts to your website or request a site under "My Web Site"</li>
                        <li>Select product categories for your site in "My Categories"</li>
                        <li>View referral statistics under "My Referrals"</li>
                        <li>Update your account details in "My Account"</li>
                    </ul>
                </div>
                {% with user_type='community' %}
                    {% include 'my_account.inc' %}
                {% endwith %}
                {% with user_type='community' %}
                    <div id="change-password" class="section" style="display: none;">
                        {% include 'change_password.inc' %}
                    </div>
                {% endwith %}
                <div id="categories" class="section">
                    <h2>My Categories</h2>
                    <p>This section lets you choose which product categories will appear on your website's "Community Discounts" page.</p>
                    <div class="treeview" id="categoryTree"></div>
                </div>
                <div id="referrals_intro" class="section">
                    <h2>My Referrals</h2>
                    <p>This section allows you to track your referral activity.</p>
                    <p>Select from the submenu options:</p>
                    <ul>
                        <li><strong>Visits:</strong> View pages visited through your referral links.</li>
                        <li><strong>Orders:</strong> See orders placed via your referrals.</li>
                    </ul>
                </div>
                <div id="visits" class="section">
                    <h2>Visits</h2>
                    <div class="toggle-section" data-toggle="visits_this_month"><i class="fas fa-calendar-day"></i> This Month</div>
                    <div id="visits_this_month" class="toggle-content open">
                        <table id="visitsTableThisMonth">
                            <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                            <tbody id="visitsListThisMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="visits_last_month"><i class="fas fa-calendar-alt"></i> Last Month</div>
                    <div id="visits_last_month" class="toggle-content">
                        <table id="visitsTableLastMonth">
                            <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                            <tbody id="visitsListLastMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="visits_earlier"><i class="fas fa-history"></i> Earlier</div>
                    <div id="visits_earlier" class="toggle-content">
                        <table id="visitsTableEarlier">
                            <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                            <tbody id="visitsListEarlier"></tbody>
                        </table>
                    </div>
                </div>
                <div id="orders" class="section">
                    <h2>Orders</h2>
                    <div class="toggle-section" data-toggle="orders_this_month"><i class="fas fa-calendar-day"></i> This Month</div>
                    <div id="orders_this_month" class="toggle-content open">
                        <table id="ordersTableThisMonth">
                            <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                            <tbody id="ordersListThisMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="orders_last_month"><i class="fas fa-calendar-alt"></i> Last Month</div>
                    <div id="orders_last_month" class="toggle-content">
                        <table id="ordersTableLastMonth">
                            <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                            <tbody id="ordersListLastMonth"></tbody>
                        </table>
                    </div>
                    <div class="toggle-section" data-toggle="orders_earlier"><i class="fas fa-history"></i> Earlier</div>
                    <div id="orders_earlier" class="toggle-content">
                        <table id="ordersTableEarlier">
                            <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                            <tbody id="ordersListEarlier"></tbody>
                        </table>
                    </div>
                </div>
                <div id="my_website_intro" class="section">
                    <h2>My Web Site</h2>
                    <p>Welcome to the "My Web Site" section! Here, you can learn how to integrate discounts into your community website.</p>
                    <ul>
                        <li><strong>Wix:</strong> Easy drag-and-drop builder.</li>
                        <li><strong>WordPress:</strong> Flexible CMS.</li>
                        <li><strong>Squarespace:</strong> Stylish solution.</li>
                        <li><strong>Weebly:</strong> Simple builder.</li>
                        <li><strong>Joomla:</strong> Robust CMS.</li>
                        <li><strong>I Don’t Have a Website Yet:</strong> Request a site setup.</li>
                    </ul>
                </div>
                <div id="wix" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-wix section-icon"></span>
                        <h2>Wix Integration</h2>
                    </div>
                    <p>Add discounts to your Wix site:</p>
                    <ol>
                        <li>Log in to Wix and open the Editor.</li>
                        <li>Click "+" > "Embed" > "Embed a Widget".</li>
                        <li>Paste: <code id="wixCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Publish.</li>
                    </ol>
                </div>
                <div id="wordpress" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-wordpress section-icon"></span>
                        <h2>WordPress Integration</h2>
                    </div>
                    <p>Add discounts to WordPress:</p>
                    <ol>
                        <li>Log in to WordPress admin.</li>
                        <li>Go to "Pages" > "Add New".</li>
                        <li>Add "Custom HTML" block: <code id="wordpressCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Publish.</li>
                    </ol>
                </div>
                <div id="squarespace" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-squarespace section-icon"></span>
                        <h2>Squarespace Integration</h2>
                    </div>
                    <p>Integrate discounts into Squarespace:</p>
                    <ol>
                        <li>Log in to Squarespace editor.</li>
                        <li>Add a new page.</li>
                        <li>Add "Code" block: <code id="squarespaceCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Update site.</li>
                    </ol>
                </div>
                <div id="weebly" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-weebly section-icon"></span>
                        <h2>Weebly Integration</h2>
                    </div>
                    <p>Add discounts to Weebly:</p>
                    <ol>
                        <li>Log in to Weebly editor.</li>
                        <li>Drag "Embed Code" onto page.</li>
                        <li>Paste: <code id="weeblyCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Publish.</li>
                    </ol>
                </div>
                <div id="joomla" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-joomla section-icon"></span>
                        <h2>Joomla Integration</h2>
                    </div>
                    <p>Integrate discounts into Joomla:</p>
                    <ol>
                        <li>Log in to Joomla admin.</li>
                        <li>Go to "Content" > "Articles" > "Add New".</li>
                        <li>Paste in "Code" view: <code id="joomlaCode"><iframe src="https://clubmadeira.io/discounts?referrer=[YourUserID]" width="100%" height="600"></iframe></code></li>
                        <li>Save.</li>
                    </ol>
                </div>
                <div id="no_website" class="section">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-question-circle section-icon"></i>
                        <h2>I Don’t Have a Website Yet</h2>
                    </div>
                    <p>Request a custom Wix website for your community from our Wix Professionals. Fill out the form below to specify your needs:</p>
                    {% with user_type='community' %}
                        {% include 'siterequest.inc' %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in the correct order with defer where appropriate -->
    <script src="/static/js/site-auth.js" defer></script>
    <script src="/static/js/site-navigation.js" defer></script>
    <script src="/static/js/category-management.js" defer></script>
    <script src="/static/js/site-request.js" defer></script>
    <script src="/static/js/community-page.js" defer></script>
    <script src="/static/js/page-load.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            tinymce.init({
                selector: '#aboutCommunity, #stylingDetails, #page1Content',
                inline: true,
                menubar: false,
                toolbar: 'bold italic | bullist numlist | link',
                plugins: 'lists link',
                setup: (editor) => {
                    editor.on('init', () => {
                        console.log('TinyMCE initialized for:', editor.id);
                    });
                }
            });
        });

        function waitForInitialize(attempts = 50, delay = 1000) {
            if (typeof window.initialize === 'function') {
                console.log('Initialize function found, calling initialize("community")');
                window.initialize('community');
            } else if (attempts > 0) {
                console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                setTimeout(() => waitForInitialize(attempts - 1, delay), delay);
            } else {
                console.error('Initialize function not found after maximum retries');
            }
        }
        waitForInitialize();
    </script>
</body>
</html>