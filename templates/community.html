{% extends 'base.inc' %}
{% block content %}
    <!-- Categories Section -->
    <div id="categories" class="section" style="display: block;">
        <h2>My Categories</h2>
        <p>This section lets you choose which product categories will appear on your website's "Community Discounts" page.</p>
        <div id="category-error" style="color: red; display: none;"></div>
        <div id="categories-form">
            {% if categories %}
                <form id="category-form" method="POST" action="/categories">
                    <label for="prompt">Describe your club (e.g., 'Discount categories for a scout group'):</label><br>
                    <textarea id="prompt" name="prompt" rows="4" cols="50" style="width: 100%; max-width: 600px;" required>{{ prompt | default('') }}</textarea><br><br>
                    <input type="hidden" id="deselected" name="deselected" value="{{ deselected | default([]) | tojson | safe }}">
                    <input type="hidden" id="previous_deselected" name="previous_deselected" value="{{ previous_deselected | default([]) | tojson | safe }}">
                    <input type="hidden" id="previous_selected" name="previous_selected" value="{{ selected | default([]) | tojson | safe }}">
                    <input type="hidden" id="categories" name="categories" value="{{ categories | default({}) | tojson | safe }}">
                    <div id="categories-container" class="categories-container" style="display: flex; flex-wrap: wrap; gap: 20px;">
                        {% for main_cat, subcats in categories.items() %}
                            <div class="category-item" style="min-width: 200px; flex: 1 0 auto; box-sizing: border-box;">
                                <h3 style="font-size: 1.2em; margin-top: 15px;">
                                    <input type="checkbox" name="selected" value="{{ main_cat }}" checked data-deselected="true">
                                    {{ main_cat }}
                                </h3>
                                <ul style="margin-left: 20px; list-style-type: none;">
                                    {% for subcat in subcats %}
                                        <li>
                                            <input type="checkbox" name="selected" value="{{ main_cat }}:{{ subcat }}" checked data-deselected="true">
                                            {{ subcat }}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="submit" style="margin-top: 20px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Refine Categories</button>
                    <button type="button" data-action="save-categories" style="margin-top: 20px; margin-left: 10px; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Save Categories</button>
                    <button type="button" data-action="reset-categories" style="margin-top: 20px; margin-left: 10px; padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Reset Categories</button>
                </form>
            {% else %}
                <form id="category-form" method="POST" action="/categories">
                    <label for="prompt">Describe your club (e.g., 'We are a scout group, ages 8-16'):</label><br>
                    <textarea id="prompt" name="prompt" rows="4" cols="50" style="width: 100%; max-width: 600px;" required>{{ prompt | default('') }}</textarea><br><br>
                    <input type="hidden" id="deselected" name="deselected" value="{{ deselected | default([]) | tojson | safe }}">
                    <input type="hidden" id="previous_deselected" name="previous_deselected" value="{{ previous_deselected | default([]) | tojson | safe }}">
                    <input type="hidden" id="previous_selected" name="previous_selected" value="{{ selected | default([]) | tojson | safe }}">
                    <input type="hidden" id="categories" name="categories" value="{{ categories | default({}) | tojson | safe }}">
                    <div id="categories-container" class="categories-container" style="display: none;"></div>
                    <button type="submit" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Generate Categories</button>
                </form>
                <p id="no-categories-message" style="margin-top: 20px;">No categories available. Please describe your club above and click "Generate Categories" to get started.</p>
            {% endif %}
        </div>
    </div>

    <!-- Referrals Intro Section -->
    <div id="referrals_intro" class="section" style="display: none;">
        <h2>My Referrals</h2>
        <p>This section allows you to track your referral activity.</p>
        <p>Select from the submenu options:</p>
        <ul>
            <li><strong>Visits:</strong> View pages visited through your referral links.</li>
            <li><strong>Orders:</strong> See orders placed via your referrals.</li>
        </ul>
    </div>

    <!-- Visits Section -->
    <div id="visits" class="section" style="display: none;">
        <h2>Visits</h2>
        <div class="toggle-section" data-toggle="visits_this_month"><i class="fas fa-calendar-day"></i> This Month</div>
        <div id="visits_this_month" class="toggle-content open">
            <table id="visitsTableThisMonth">
                <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                <tbody id="visitList"></tbody>
            </table>
        </div>
        <div class="toggle-section" data-toggle="visits_last_month"><i class="fas fa-calendar-alt"></i> Last Month</div>
        <div id="visits_last_month" class="toggle-content">
            <table id="visitsTableLastMonth">
                <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                <tbody id="visitsListLastMonth"></tbody>
            </table>
        </div>
        <div class="toggle-section" data-toggle="visits_earlier"><i class="fas fa-history"></i> Earlier</div>
        <div id="visits_earlier" class="toggle-content">
            <table id="visitsTableEarlier">
                <thead><tr><th>Page</th><th>Timestamp</th></tr></thead>
                <tbody id="visitsListEarlier"></tbody>
            </table>
        </div>
    </div>

    <!-- Orders Section -->
    <div id="orders" class="section" style="display: none;">
        <h2>Orders</h2>
        <div class="toggle-section" data-toggle="orders_this_month"><i class="fas fa-calendar-day"></i> This Month</div>
        <div id="orders_this_month" class="toggle-content open">
            <table id="ordersTableThisMonth">
                <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                <tbody id="orderList"></tbody>
            </table>
        </div>
        <div class="toggle-section" data-toggle="orders_last_month"><i class="fas fa-calendar-alt"></i> Last Month</div>
        <div id="orders_last_month" class="toggle-content">
            <table id="ordersTableLastMonth">
                <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                <tbody id="ordersListLastMonth"></tbody>
            </table>
        </div>
        <div class="toggle-section" data-toggle="orders_earlier"><i class="fas fa-history"></i> Earlier</div>
        <div id="orders_earlier" class="toggle-content">
            <table id="ordersTableEarlier">
                <thead><tr><th>Order ID</th><th>Buyer</th><th>Total</th><th>Timestamp</th></tr></thead>
                <tbody id="ordersListEarlier"></tbody>
            </table>
        </div>
    </div>

    <!-- My Website Intro Section -->
    <div id="my_website_intro_section" class="section" style="display: none;">
        <h2>My Web Site</h2>
        <p>Welcome to the "My Web Site" section! Here, you can learn how to integrate discounts into your community website.</p>
        <p>Choose your website provider from the icons below to get started.</p>
        <div id="providerIconsBar" style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;"></div>
        <div id="client-api-settings"></div>
        <div id="markdown-content" style="margin-top: 20px;"></div>
    </div>

    <!-- No Website Section -->
    <div id="no_website" class="section" style="display: none;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <i class="fas fa-question-circle" style="font-size: 32px; margin-right: 10px;"></i>
            <h2>I Donâ€™t Have a Website Yet</h2>
        </div>
        <p>Request a custom Wix website for your community from our Wix Professionals. Fill out the form below to specify your needs:</p>
        {% with user_type='community' %}
            {% include 'siterequest.inc' %}
        {% endwith %}
    </div>
{% endblock %}
{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize TinyMCE for rich text fields
            if (window.tinymce) {
                tinymce.init({
                    selector: '#aboutCommunity, #stylingDetails, #page1Content',
                    inline: true,
                    menubar: false,
                    toolbar: 'bold italic | bullist numlist | link',
                    plugins: 'lists link',
                    setup: (editor) => {
                        editor.on('init', () => {
                            console.log('TinyMCE initialized for:', editor.id);
                        });
                    }
                });
            } else {
                console.error('TinyMCE library not loaded');
            }

            // Ensure marked is loaded before rendering markdown
            if (typeof marked === 'undefined') {
                console.error('marked library not loaded');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js';
                script.onload = () => {
                    console.log('marked library loaded dynamically');
                };
                document.head.appendChild(script);
            }
        });
    </script>
{% endblock %}