<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="/static/styles.css" id="styles-css">
    <link rel="stylesheet" href="/static/icons.css">
    <!-- Favicon: Font Awesome "group-arrows-rotate" SVG (Unicode f366) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path d='M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160zM201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'/></svg>" type="image/svg+xml">
    <!-- Define window.apiUrl before loading scripts -->
    <script>
        window.apiUrl = 'https://clubmadeira.io';
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</head>
<body>
    <!-- Loading Overlay: Start visible with inline styles, doubled circle sizes -->
    <div id="loadingOverlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 1); justify-content: center; align-items: center; z-index: 9999;">
        <div style="position: relative; width: 200px; height: 200px;">
            <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 120px; height: 120px; border-top-color: #ff6f61; top: 40px; left: 40px; animation-delay: 0s;"></div>
            <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 90px; height: 90px; border-top-color: #6bff61; top: 55px; left: 55px; animation-delay: 0.3s;"></div>
            <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 60px; height: 60px; border-top-color: #61cfff; top: 70px; left: 70px; animation-delay: 0.6s;"></div>
            <div style="position: absolute; border-radius: 50%; border: 8px solid transparent; animation: spin 1.5s linear infinite; width: 30px; height: 30px; border-top-color: #ff61ff; top: 85px; left: 85px; animation-delay: 0.9s;"></div>
        </div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Inline script to hide overlay once styles.css is loaded and waitForInitialize completes -->
    <script>
        (function() {
            console.log('Inline script - Starting overlay management');
            const stylesLink = document.getElementById('styles-css');
            const overlay = document.getElementById('loadingOverlay');
            const maxWaitTime = 5000; // 5 seconds max wait for CSS load
            let cssLoaded = false;
            let initComplete = false;

            function hideOverlay() {
                if (cssLoaded && initComplete) {
                    console.log('Inline script - Hiding overlay after CSS and init');
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        document.querySelector('.layout-wrapper').style.display = 'block';
                        window.overlayHidden = true; // Signal for Toastr
                    }, 200); // 200ms delay before hiding
                }
            }

            // Check CSS load
            if (stylesLink.sheet) {
                console.log('Inline script - styles.css already loaded');
                cssLoaded = true;
                hideOverlay();
            } else {
                stylesLink.onload = () => {
                    console.log('Inline script - styles.css loaded');
                    cssLoaded = true;
                    hideOverlay();
                };
                stylesLink.onerror = () => {
                    console.error('Inline script - styles.css failed to load');
                    cssLoaded = true; // Proceed even if CSS fails
                    hideOverlay();
                };
                setTimeout(() => {
                    if (!cssLoaded) {
                        console.warn('Inline script - CSS load timeout');
                        cssLoaded = true;
                        hideOverlay();
                    }
                }, maxWaitTime);
            }

            // Wait for waitForInitialize to complete
            window.waitForInitialize = function(attempts = 50, delay = 200) {
                return new Promise(resolve => {
                    console.log('waitForInitialize - Starting');
                    if (typeof window.initialize === 'function') {
                        console.log('Initialize function found, calling initialize("admin")');
                        window.initialize('admin');
                        resolve();
                    } else if (attempts > 0) {
                        console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                        setTimeout(() => {
                            window.waitForInitialize(attempts - 1, delay).then(resolve);
                        }, delay);
                    } else {
                        console.error('Initialize function not found after maximum retries');
                        resolve(); // Resolve anyway to avoid hanging
                    }
                });
            };

            window.waitForInitialize().then(() => {
                initComplete = true;
                hideOverlay();
            });
        })();
    </script>

    <div class="layout-wrapper" style="display: none;">
        <div class="header">
            <div class="header-content" id="brandingContent" style="display: block;">
                <!-- Branding content will be loaded here -->
            </div>
        </div>
        <div class="main-container">
            <div class="menu-container">
                <div class="menu">
                    <button data-section="deal_listings">
                        <span class="button-content"><i class="fas fa-tags"></i> Deal Listings</span>
                    </button>
                    <button data-submenu="affiliatePrograms" data-section="affiliateProgramsIntro">
                        <span class="button-content"><i class="fas fa-handshake"></i> Affiliate Programs</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="affiliatePrograms" class="submenu">
                        <button data-section="amazon_uk">
                            <span class="button-content">
                                <span class="icon-amazon-uk menu-size"></span> Amazon UK
                            </span>
                        </button>
                        <button data-section="ebay_uk">
                            <span class="button-content">
                                <span class="icon-ebay-uk menu-size"></span> eBay UK
                            </span>
                        </button>
                        <button data-section="awin">
                            <span class="button-content"><i class="fas fa-network-wired"></i> Awin</span>
                        </button>
                        <button data-section="cj">
                            <span class="button-content"><i class="fas fa-link"></i> CJ</span>
                        </button>
                        <button data-section="textmagic">
                            <span class="button-content"><i class="fas fa-sms"></i> TextMagic</span>
                        </button>
                        <button data-section="tiny">
                            <span class="button-content"><i class="fas fa-pen"></i> tiny</span>
                        </button>
                    </div>
                    <button data-submenu="userManagement" data-section="userManagementIntro">
                        <span class="button-content"><i class="fas fa-users"></i> User Management</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="userManagement" class="submenu">
                        <button data-section="partners">
                            <span class="button-content">
                                <span class="menu-size icon-partner"></span> Partners
                            </span>
                        </button>
                        <button data-section="communities">
                            <span class="button-content">
                                <span class="menu-size icon-community"></span> Communities
                            </span>
                        </button>
                        <button data-section="merchants">
                            <span class="button-content">
                                <span class="menu-size icon-merchant"></span> Merchants
                            </span>
                        </button>
                    </div>
                    <button data-submenu="testScripts" data-section="testScriptsIntro">
                        <span class="button-content"><i class="fas fa-flask"></i> Test Scripts</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="testScripts" class="submenu">
                        <button data-href="/partner">
                            <span class="button-content">
                                <span class="icon-group">
                                    <span class="menu-size icon-partner"></span>
                                    <i class="fas fa-flask small-icon"></i>
                                </span> Partner
                            </span>
                        </button>
                        <button data-href="/community">
                            <span class="button-content">
                                <span class="icon-group">
                                    <span class="menu-size icon-community"></span>
                                    <i class="fas fa-flask small-icon"></i>
                                </span> Community
                            </span>
                        </button>
                        <button data-href="/merchant">
                            <span class="button-content">
                                <span class="icon-group">
                                    <span class="menu-size icon-merchant"></span>
                                    <i class="fas fa-flask small-icon"></i>
                                </span> Merchant
                            </span>
                        </button>
                        <button data-submenu="referralTests" data-section="referralTestsIntro">
                            <span class="button-content"><i class="fas fa-link"></i> Referral Tests</span>
                            <i class="fas fa-caret-right caret"></i>
                        </button>
                        <div id="referralTests" class="submenu">
                            <button data-section="page_visit_test">
                                <span class="button-content"><i class="fas fa-eye"></i> Page Visit Referral Test</span>
                            </button>
                            <button data-section="order_test">
                                <span class="button-content"><i class="fas fa-shopping-cart"></i> Order Referral Test</span>
                            </button>
                        </div>
                    </div>
                    <button data-submenu="myAccountSubmenu" data-section="myAccountIntro">
                        <span class="button-content"><i class="fas fa-user"></i> My Account</span>
                        <i class="fas fa-caret-right caret"></i>
                    </button>
                    <div id="myAccountSubmenu" class="submenu">
                        <button data-section="contactDetails">
                            <span class="button-content"><i class="fas fa-address-book"></i> Contact Details</span>
                        </button>
                        <button data-section="changePassword">
                            <span class="button-content"><i class="fas fa-key"></i> Change Password</span>
                        </button>
                    </div>
                    <button id="logOffBtn" style="background-color: #dc3545;">
                        <span class="button-content"><i class="fas fa-sign-out-alt"></i> Log Off</span>
                    </button>
                </div>
            </div>
            <div class="content-wrapper">
                <div id="welcome" class="section">
                    <h2>Welcome to Admin Dashboard</h2>
                    <p>This is the main administration tool for managing your affiliate programs and deal listings.</p>
                    <p>Use the menu on the left to:</p>
                    <ul>
                        <li>View and filter discounted deals in "Deal Listings"</li>
                        <li>Manage affiliate credentials under "Affiliate Programs"</li>
                        <li>Manage users under "User Management"</li>
                        <li>Test referral tracking with "Test Scripts"</li>
                        <li>Update your account details in "My Account"</li>
                    </ul>
                </div>

                <div id="deal_listings" class="section">
                    <h2>Discounted Deal Listings</h2>
                    <p>This section displays all currently active deal listings available across your affiliate programs.</p>
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 1; max-width: 300px;">
                            <h3>Categories</h3>
                            <div class="treeview" id="categoryTree"></div>
                        </div>
                        <div style="flex: 2;">
                            <table class="deals-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Title</th>
                                        <th>URL</th>
                                        <th>Price</th>
                                        <th>Original</th>
                                        <th>Discount %</th>
                                        <th>Image</th>
                                        <th>QTY</th>
                                    </tr>
                                </thead>
                                <tbody id="dealList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="affiliateProgramsIntro" class="section">
                    <h2>Affiliate Programs</h2>
                    <p>Use this section to manage your affiliate program credentials.</p>
                    <p>Select an affiliate program from the menu to enter or update your API keys, access tokens, or other necessary credentials.</p>
                </div>

                <div id="amazon_uk" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-amazon-uk" style="width: 32px; height: 32px; margin-right: 10px;"></span>
                        <h2>Amazon UK Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="amazonAccessKey">Access Key:</label>
                        <input type="text" id="amazonAccessKey" placeholder="Enter Access Key">
                        <label for="amazonSecretKey">Secret Key:</label>
                        <input type="text" id="amazonSecretKey" placeholder="Enter Secret Key">
                        <label for="amazonAssociateTag">Associate Tag:</label>
                        <input type="text" id="amazonAssociateTag" placeholder="Enter Associate Tag">
                        <label for="amazonCountry">Country:</label>
                        <input type="text" id="amazonCountry" placeholder="Enter Country (e.g., UK)">
                        <button data-affiliate="amazon_uk">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Visit <a href="https://affiliate-program.amazon.com/" target="_blank">Amazon Associates</a>.
                    </div>
                </div>

                <div id="ebay_uk" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="icon-ebay-uk" style="width: 32px; height: 32px; margin-right: 10px;"></span>
                        <h2>eBay UK Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="ebayAppId">App ID:</label>
                        <input type="text" id="ebayAppId" placeholder="Enter App ID">
                        <button data-affiliate="ebay_uk">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Go to <a href="https://partnernetwork.ebay.com/" target="_blank">eBay Partner Network</a>.
                    </div>
                </div>

                <div id="awin" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-network-wired" style="font-size: 32px; margin-right: 10px; color: white;"></i>
                        <h2>Awin Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="awinApiToken">API Token:</label>
                        <input type="text" id="awinApiToken" placeholder="Enter API Token">
                        <button data-affiliate="awin">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Visit <a href="https://www.awin.com/" target="_blank">Awin</a>.
                    </div>
                </div>

                <div id="cj" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-link" style="font-size: 32px; margin-right: 10px; color: white;"></i>
                        <h2>CJ Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="cjApiKey">API Key:</label>
                        <input type="text" id="cjApiKey" placeholder="Enter API Key">
                        <label for="cjWebsiteId">Website ID:</label>
                        <input type="text" id="cjWebsiteId" placeholder="Enter Website ID">
                        <button data-affiliate="cj">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Go to <a href="https://www.cj.com/" target="_blank">CJ Affiliate</a>.
                    </div>
                </div>

                <div id="textmagic" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-sms" style="font-size: 32px; margin-right: 10px; color: white;"></i>
                        <h2>TextMagic Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="textmagicUsername">Username:</label>
                        <input type="text" id="textmagicUsername" placeholder="Enter Username">
                        <label for="textmagicApiKey">API Key:</label>
                        <input type="text" id="textmagicApiKey" placeholder="Enter API Key">
                        <button data-affiliate="textmagic">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Visit <a href="https://www.textmagic.com/" target="_blank">TextMagic</a>.
                    </div>
                </div>

                <div id="tiny" class="section" style="padding-left: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-pen" style="font-size: 32px; margin-right: 10px; color: white;"></i>
                        <h2>tiny Credentials</h2>
                    </div>
                    <div class="form" style="margin: 0; max-width: 400px;">
                        <label for="tinyApiKey">API Key:</label>
                        <input type="text" id="tinyApiKey" placeholder="Enter API Key">
                        <button data-affiliate="tiny">Update Credentials</button>
                    </div>
                    <div class="signup-instructions">
                        <strong>Sign Up:</strong> Visit <a href="https://www.tiny.cloud/" target="_blank">tiny</a>.
                    </div>
                </div>

                <div id="userManagementIntro" class="section">
                    <h2>User Management</h2>
                    <p>This section allows you to manage different types of users in your system.</p>
                    <p>Select a user type from the menu to view their details or modify their permissions:</p>
                    <ul>
                        <li><strong>Partners:</strong> Manage users with Partner permissions.</li>
                        <li><strong>Communities:</strong> Manage community users.</li>
                        <li><strong>Merchants:</strong> Manage merchant users.</li>
                    </ul>
                </div>

                <div id="merchants" class="section">
                    <h2>Merchant Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>USERid</th>
                                <th>Contact Name</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="merchantsList">
                            <!-- Dynamically populated by updateUserTable -->
                        </tbody>
                    </table>
                </div>

                <div id="communities" class="section">
                    <h2>Communities Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>USERid</th>
                                <th>Contact Name</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="communitiesList">
                            <!-- Dynamically populated by updateUserTable -->
                        </tbody>
                    </table>
                </div>

                <div id="partners" class="section">
                    <h2>Partner Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>USERid</th>
                                <th>Contact Name</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partnersList">
                            <!-- Dynamically populated by updateUserTable -->
                        </tbody>
                    </table>
                </div>

                <div id="testScriptsIntro" class="section">
                    <h2>Test Scripts</h2>
                    <p>Use this section to test referral tracking and other scripts.</p>
                    <p>Select an option from the menu to visit endpoints or run referral tests under "Referral Tests."</p>
                </div>

                <div id="referralTestsIntro" class="section">
                    <h2>Referral Tests</h2>
                    <p>This section contains tools to test referral tracking functionality.</p>
                    <p>Choose "Page Visit Referral Test" or "Order Referral Test" to submit test data and verify tracking behavior.</p>
                </div>

                <div id="page_visit_test" class="section">
                    <h2>Page Visit Referral Test</h2>
                    <div class="form">
                        <form id="pageVisitForm">
                            <table>
                                <tr><td><label for="pageReferer">Referer:</label></td><td><select id="pageReferer" name="referer"></select></td></tr>
                                <tr><td><label for="page">Page:</label></td><td><input type="text" id="page" name="page" value="/home"></td></tr>
                                <tr><td><label for="pageTimestamp">Timestamp:</label></td><td><input type="text" id="pageTimestamp" name="timestamp"></td></tr>
                                <tr><td colspan="2"><button type="submit">Submit Page Visit</button></td></tr>
                            </table>
                        </form>
                    </div>
                </div>

                <div id="order_test" class="section">
                    <h2>Order Referral Test</h2>
                    <div class="form">
                        <form id="orderForm">
                            <table>
                                <tr><td><label for="orderReferer">Referer:</label></td><td><select id="orderReferer" name="referer"></select></td></tr>
                                <tr><td><label for="orderId">Order ID:</label></td><td><input type="text" id="orderId" name="orderId" value="ORD12345"></td></tr>
                                <tr><td><label for="buyer">Buyer Name:</label></td><td><input type="text" id="buyer" name="buyer" value="John Doe"></td></tr>
                                <tr><td><label for="total">Total Amount (£):</label></td><td><input type="number" id="total" name="total" value="99.99" step="0.01"></td></tr>
                                <tr><td><label for="orderTimestamp">Timestamp:</label></td><td><input type="text" id="orderTimestamp" name="timestamp"></td></tr>
                                <tr><td colspan="2"><button type="submit">Submit Order</button></td></tr>
                            </table>
                        </form>
                    </div>
                </div>

                <div id="myAccountIntro" class="section">
                    <h2>My Account</h2>
                    <p>Welcome to your account settings. Here, you can manage your personal information and update your password for security.</p>
                    <p>Use the options below to navigate to the desired section:</p>
                </div>

                <div id="contactDetails" class="section">
                    <h2>Contact Details</h2>
                    <div class="settings-form">
                        <label><strong>User ID:</strong></label>
                        <input type="text" id="userId" readonly>
                        <label for="contactName">Contact Name:</label>
                        <input type="text" id="contactName" placeholder="Enter contact name">
                        <label for="websiteUrl">Website URL:</label>
                        <input type="url" id="websiteUrl" placeholder="Enter website URL">
                        <label for="emailAddress">Email Address:</label>
                        <input type="email" id="emailAddress" placeholder="Enter email address">
                        <label><strong>Phone Number:</strong></label>
                        <span>{{ user.phone_number | default('N/A') }}</span>
                        <button data-action="saveSettings"><i class="fas fa-save"></i> Save Settings</button>
                    </div>
                </div>

                {% with user_type='admin' %}
                    <div id="change-password" class="section" style="display: none;">
                        {% include 'change_password.inc' %}
                    </div>
                {% endwith %}
            </div>
        </div>
    </div>

    <!-- Load scripts in the correct order -->
    <script src="/static/js/site-auth.js"></script>
    <script src="/static/js/site-navigation.js"></script>
    <script src="/static/js/category-management.js"></script>
    <script src="/static/js/site-request.js"></script>
    <script src="/static/js/admin-page.js"></script>
    <script src="/static/js/page-load.js"></script>
    <script>
        // Wait for the initialize function to become available
        function waitForInitialize(attempts = 50, delay = 200) {
            if (typeof window.initialize === 'function') {
                console.log('Initialize function found, calling initialize("admin")');
                window.initialize('admin');
            } else if (attempts > 0) {
                console.log(`Initialize function not found, retrying (${attempts} attempts left)...`);
                setTimeout(() => waitForInitialize(attempts - 1, delay), delay);
            } else {
                console.error('Initialize function not found after maximum retries');
            }
        }
        waitForInitialize();
    </script>
</body>
</html>